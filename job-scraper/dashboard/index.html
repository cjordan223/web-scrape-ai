<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Job Scraper Dashboard</title>
<script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.14.8/dist/cdn.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.7/dist/chart.umd.min.js"></script>
<style>
/* ── Reset & Base ───────────────────────────────────────────── */
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0}
:root{
  --bg:#f4f6f9;--surface:#fff;--sidebar:#111827;--sidebar-hover:#1f2937;
  --accent:#4361ee;--accent-light:#eef1ff;
  --green:#06d6a0;--amber:#ffd166;--red:#ef476f;--purple:#7c3aed;
  --cyan:#06b6d4;--orange:#f97316;--teal:#14b8a6;
  --text:#1f2937;--text-secondary:#6b7280;--border:#e5e7eb;
  --radius:8px;--shadow:0 1px 3px rgba(0,0,0,.08);
  --font:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,sans-serif;
}
html{font-size:14px}
body{font-family:var(--font);color:var(--text);background:var(--bg);display:flex;min-height:100vh}

/* ── Sidebar ────────────────────────────────────────────────── */
.sidebar{
  width:220px;min-height:100vh;background:var(--sidebar);color:#fff;
  display:flex;flex-direction:column;position:fixed;top:0;left:0;bottom:0;z-index:10;
}
.sidebar-brand{padding:20px 20px 16px;font-size:1.15rem;font-weight:700;letter-spacing:-.02em;border-bottom:1px solid rgba(255,255,255,.08)}
.sidebar-brand span{color:var(--accent);font-weight:800}
.sidebar-nav{padding:12px 0;flex:1}
.nav-item{
  display:flex;align-items:center;gap:10px;padding:10px 20px;cursor:pointer;
  color:rgba(255,255,255,.6);font-size:.9rem;font-weight:500;
  transition:all .15s ease;border-left:3px solid transparent;
}
.nav-item:hover{color:#fff;background:var(--sidebar-hover)}
.nav-item.active{color:#fff;background:var(--sidebar-hover);border-left-color:var(--accent)}
.nav-item svg{width:18px;height:18px;flex-shrink:0;opacity:.7}
.nav-item.active svg{opacity:1}
.sidebar-footer{padding:16px 20px;font-size:.75rem;color:rgba(255,255,255,.3);border-top:1px solid rgba(255,255,255,.08)}
.sidebar-footer .db-size{color:rgba(255,255,255,.5);font-weight:600}

/* ── Main ───────────────────────────────────────────────────── */
.main{margin-left:220px;flex:1;min-height:100vh;padding:28px 32px;max-width:calc(100vw - 220px);overflow-x:hidden}
.page-header{display:flex;align-items:center;justify-content:space-between;margin-bottom:24px}
.page-title{font-size:1.5rem;font-weight:700}
.last-updated{font-size:.8rem;color:var(--text-secondary)}

/* ── Cards ──────────────────────────────────────────────────── */
.cards{display:grid;grid-template-columns:repeat(auto-fit,minmax(170px,1fr));gap:16px;margin-bottom:24px}
.card{background:var(--surface);border-radius:var(--radius);padding:20px;box-shadow:var(--shadow);transition:transform .15s ease}
.card:hover{transform:translateY(-2px)}
.card-label{font-size:.8rem;color:var(--text-secondary);font-weight:600;text-transform:uppercase;letter-spacing:.04em;margin-bottom:6px}
.card-value{font-size:1.75rem;font-weight:700;line-height:1.2}
.card-sub{font-size:.8rem;color:var(--text-secondary);margin-top:4px}
.card-icon{width:36px;height:36px;border-radius:8px;display:flex;align-items:center;justify-content:center;margin-bottom:10px}
.card-icon svg{width:20px;height:20px}
.card-icon.blue{background:var(--accent-light);color:var(--accent)}
.card-icon.purple{background:#f3f0ff;color:var(--purple)}
.card-icon.green{background:#ecfdf5;color:var(--green)}
.card-icon.amber{background:#fffbeb;color:#d97706}
.card-icon.red{background:#fef2f2;color:var(--red)}
.card-icon.cyan{background:#ecfeff;color:var(--cyan)}

/* ── Charts ─────────────────────────────────────────────────── */
.chart-container{background:var(--surface);border-radius:var(--radius);padding:20px;box-shadow:var(--shadow);margin-bottom:24px;min-width:0}
.chart-title{font-size:.95rem;font-weight:600;margin-bottom:16px}
.chart-row{display:grid;grid-template-columns:1fr 1fr;gap:16px;margin-bottom:24px}
.chart-row .chart-container{margin-bottom:0;min-width:0}
canvas{max-height:260px}

/* ── Run health strip ──────────────────────────────────────── */
.health-strip{display:flex;gap:4px;align-items:center;margin-bottom:24px;background:var(--surface);border-radius:var(--radius);padding:16px 20px;box-shadow:var(--shadow);overflow-x:auto}
.health-strip-label{font-size:.85rem;font-weight:600;margin-right:12px;white-space:nowrap}
.health-block{width:24px;height:24px;border-radius:4px;cursor:pointer;transition:transform .1s;position:relative}
.health-block:hover{transform:scale(1.3);z-index:1}
.health-block.success{background:var(--green)}
.health-block.failed{background:var(--red)}
.health-block.running{background:var(--accent);animation:pulse 1.5s infinite}
.health-block-tooltip{display:none;position:absolute;bottom:calc(100% + 6px);left:50%;transform:translateX(-50%);background:#1f2937;color:#fff;padding:4px 8px;border-radius:4px;font-size:.75rem;white-space:nowrap;z-index:20}
.health-block:hover .health-block-tooltip{display:block}

/* ── Table ──────────────────────────────────────────────────── */
.panel{background:var(--surface);border-radius:var(--radius);box-shadow:var(--shadow);overflow:hidden;margin-bottom:24px}
.panel-header{padding:16px 20px;border-bottom:1px solid var(--border);display:flex;align-items:center;justify-content:space-between}
.panel-title{font-size:.95rem;font-weight:600}
.filters{display:flex;gap:8px;flex-wrap:wrap;padding:12px 20px;border-bottom:1px solid var(--border);background:#fafbfc}
.filters select,.filters input{
  padding:6px 10px;border:1px solid var(--border);border-radius:6px;font-size:.85rem;
  font-family:var(--font);background:#fff;color:var(--text);outline:none;
}
.filters select:focus,.filters input:focus{border-color:var(--accent);box-shadow:0 0 0 2px var(--accent-light)}
.btn{
  padding:6px 14px;border:none;border-radius:6px;font-size:.85rem;font-weight:500;
  cursor:pointer;font-family:var(--font);transition:all .15s ease;
}
.btn-primary{background:var(--accent);color:#fff}
.btn-primary:hover{background:#3451d1}
.btn-ghost{background:transparent;color:var(--text-secondary);border:1px solid var(--border)}
.btn-ghost:hover{background:#f3f4f6}
.btn-sm{padding:4px 10px;font-size:.8rem}
.btn-success{background:var(--green);color:#fff}
.btn-success:hover{background:#05c090}

.stats-bar{display:flex;gap:16px;padding:10px 20px;background:#f0f4ff;border-bottom:1px solid var(--border);font-size:.85rem;color:var(--text-secondary)}
.stats-bar strong{color:var(--text)}

table{width:100%;border-collapse:collapse}
thead{background:#fafbfc}
th{text-align:left;padding:10px 16px;font-size:.8rem;font-weight:600;text-transform:uppercase;letter-spacing:.04em;color:var(--text-secondary);border-bottom:1px solid var(--border);cursor:pointer;white-space:nowrap;user-select:none}
th:hover{color:var(--text)}
th .sort-arrow{font-size:.7rem;margin-left:4px;opacity:.4}
th.sorted .sort-arrow{opacity:1;color:var(--accent)}
td{padding:10px 16px;border-bottom:1px solid var(--border);font-size:.9rem;vertical-align:top}
tr:hover td{background:#f9fafb}
tr.expanded td{background:var(--accent-light);border-bottom-color:var(--accent-light)}
.clickable-row{cursor:pointer}
.clickable-row:hover td{background:#eef1ff}

/* ── Pills ──────────────────────────────────────────────────── */
.pill{display:inline-block;padding:2px 8px;border-radius:99px;font-size:.75rem;font-weight:600;white-space:nowrap}
.pill-greenhouse{background:#dcfce7;color:#166534}
.pill-lever{background:#fef9c3;color:#854d0e}
.pill-ashby{background:#dbeafe;color:#1e40af}
.pill-workday{background:#fce7f3;color:#9d174d}
.pill-bamboohr{background:#d1fae5;color:#065f46}
.pill-icims{background:#ede9fe;color:#5b21b6}
.pill-smartrecruiters{background:#fed7aa;color:#9a3412}
.pill-unknown{background:#f3f4f6;color:#6b7280}
.pill-junior{background:#dcfce7;color:#166534}
.pill-mid{background:#dbeafe;color:#1e40af}
.pill-senior{background:#fef9c3;color:#854d0e}
.pill-success,.pill-complete{background:#dcfce7;color:#166534}
.pill-running{background:#dbeafe;color:#1e40af}
.pill-fail,.pill-failed{background:#fee2e2;color:#991b1b}
.pill-new{background:#dbeafe;color:#1e40af;font-size:.7rem;margin-left:6px}

/* ── Job detail expand ──────────────────────────────────────── */
.job-detail{padding:16px 20px;background:#fafbfc;border-bottom:1px solid var(--border)}
.jd-text{max-height:400px;overflow-y:auto;white-space:pre-wrap;font-size:.85rem;line-height:1.6;background:#fff;padding:16px;border-radius:6px;border:1px solid var(--border);margin-top:12px}
.verdicts{margin-top:12px}
.verdicts-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:6px}
.verdict-chip{display:flex;align-items:flex-start;gap:6px;padding:6px 8px;border:1px solid var(--border);border-radius:8px;background:#fff}
.verdict-chip.pass{background:#f0fdf4}
.verdict-chip.fail{background:#fff1f2}
.verdict-chip.llm{background:#f5f3ff}
.verdict-dot{width:16px;height:16px;border-radius:50%;display:flex;align-items:center;justify-content:center;flex-shrink:0;font-size:.62rem;margin-top:1px}
.verdict-dot.pass{background:#dcfce7;color:#166534}
.verdict-dot.fail{background:#fee2e2;color:#991b1b}
.verdict-dot.llm{background:#ede9fe;color:var(--purple)}

/* ── Rejection stage pills ──────────────────────────────────── */
.pill-stage-url_domain{background:#f3f4f6;color:#6b7280}
.pill-stage-title_relevance{background:#fffbeb;color:#d97706}
.pill-stage-title_role{background:#fffbeb;color:#d97706}
.pill-stage-seniority{background:#f3f0ff;color:#7c3aed}
.pill-stage-experience{background:#ecfeff;color:#0891b2}
.pill-stage-content_blocklist{background:#fee2e2;color:#991b1b}
.pill-stage-remote{background:#fff7ed;color:#c2410c}
.pill-stage-salary{background:#f0fdf4;color:#166534}
.pill-stage-llm_review{background:#f3f0ff;color:#7c3aed}
.verdict-stage{font-weight:600;font-size:.8rem;line-height:1.2}
.verdict-reason{font-size:.76rem;color:var(--text-secondary);line-height:1.2}

/* ── Pagination ─────────────────────────────────────────────── */
.pagination{display:flex;align-items:center;justify-content:space-between;padding:12px 20px;border-top:1px solid var(--border)}
.pagination-info{font-size:.85rem;color:var(--text-secondary)}
.pagination-controls{display:flex;align-items:center;gap:8px}
.pagination-controls button{padding:6px 12px;border:1px solid var(--border);border-radius:6px;background:#fff;cursor:pointer;font-size:.85rem}
.pagination-controls button:disabled{opacity:.4;cursor:default}
.pagination-controls button:not(:disabled):hover{background:#f3f4f6}
.pagination-controls .page-num{font-size:.85rem;font-weight:600;min-width:80px;text-align:center}

/* ── Status dot ─────────────────────────────────────────────── */
.status-dot{width:8px;height:8px;border-radius:50%;display:inline-block;margin-right:6px}
.status-dot.active{background:var(--green);animation:pulse 1.5s infinite}
.status-dot.idle{background:var(--border)}
@keyframes pulse{0%,100%{opacity:1}50%{opacity:.4}}
.status-controls{display:flex;align-items:center;gap:8px}
.runs-control-panel{background:var(--surface);border-radius:var(--radius);box-shadow:var(--shadow);padding:16px 20px;margin-bottom:18px;display:grid;grid-template-columns:1.2fr 1fr 1.1fr;gap:18px;align-items:start}
.runs-control-block{display:flex;flex-direction:column;gap:10px}
.runs-control-title{font-size:.78rem;text-transform:uppercase;letter-spacing:.04em;font-weight:700;color:var(--text-secondary)}
.runs-pill-row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
.switch-row{display:flex;flex-direction:column;gap:10px}
.switch-item{display:flex;align-items:center;justify-content:space-between;gap:10px;padding:10px 12px;border:1px solid var(--border);border-radius:8px;background:#fafbfc}
.switch-meta{display:flex;flex-direction:column;gap:2px}
.switch-meta strong{font-size:.88rem}
.switch-meta span{font-size:.78rem;color:var(--text-secondary)}
.switch{position:relative;display:inline-block;width:46px;height:24px;flex-shrink:0}
.switch input{opacity:0;width:0;height:0}
.slider{position:absolute;cursor:pointer;inset:0;background:#cbd5e1;transition:.2s;border-radius:24px}
.slider:before{position:absolute;content:"";height:18px;width:18px;left:3px;top:3px;background:white;transition:.2s;border-radius:50%}
.switch input:checked + .slider{background:var(--accent)}
.switch input:checked + .slider:before{transform:translateX(22px)}
.switch input:disabled + .slider{opacity:.6;cursor:not-allowed}
.control-actions{display:flex;flex-direction:column;gap:10px}
.control-action-row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
.toggle-wrap{display:flex;align-items:center;gap:6px;font-size:.82rem;color:var(--text-secondary)}
.toggle-wrap input{accent-color:var(--accent);cursor:pointer}
.control-note{font-size:.78rem;color:var(--text-secondary)}
.manual-log{max-height:140px;overflow:auto;padding:10px;border:1px solid var(--border);border-radius:8px;background:#0b1220;color:#9fb3c8;font-family:'SF Mono',Monaco,Consolas,monospace;font-size:.78rem}

/* ── Run stats ──────────────────────────────────────────────── */
.run-flow{display:flex;align-items:center;gap:4px;font-size:.85rem}
.run-flow .arrow{color:var(--text-secondary);font-size:.7rem}

/* ── Run timeline ──────────────────────────────────────────── */
.run-timeline-bar{height:20px;border-radius:4px;min-width:4px;transition:all .15s}
.run-timeline-bar.complete{background:var(--green)}
.run-timeline-bar.running{background:var(--accent)}
.run-timeline-bar.failed{background:var(--red)}

/* ── Error panel ───────────────────────────────────────────── */
.error-panel{background:#fef2f2;border:1px solid #fecaca;border-radius:6px;padding:12px 16px;margin:8px 0}
.error-panel-title{font-weight:600;color:#991b1b;font-size:.85rem;margin-bottom:6px;cursor:pointer}
.error-item{font-size:.82rem;color:#7f1d1d;padding:2px 0;font-family:monospace}

/* ── Dedup funnel ──────────────────────────────────────────── */
.funnel{display:flex;flex-direction:column;gap:8px;align-items:center;padding:20px}
.funnel-step{display:flex;align-items:center;gap:12px;width:100%;max-width:500px}
.funnel-bar{height:36px;border-radius:6px;display:flex;align-items:center;padding:0 12px;color:#fff;font-weight:600;font-size:.9rem;min-width:60px;transition:width .5s}
.funnel-label{font-size:.85rem;color:var(--text-secondary);min-width:120px;text-align:right}
.funnel-arrow{text-align:center;color:var(--text-secondary);font-size:1.2rem}

/* ── SQL Console ───────────────────────────────────────────── */
.sql-editor{width:100%;min-height:120px;padding:12px;font-family:'SF Mono',Monaco,Consolas,monospace;font-size:.9rem;border:1px solid var(--border);border-radius:6px;resize:vertical;outline:none;background:#fafbfc;line-height:1.5}
.sql-editor:focus{border-color:var(--accent);box-shadow:0 0 0 2px var(--accent-light)}
.query-meta{font-size:.8rem;color:var(--text-secondary);padding:8px 0}
.preset-queries{display:flex;gap:6px;flex-wrap:wrap;margin-bottom:12px}
.preset-btn{padding:4px 10px;border:1px solid var(--border);border-radius:99px;font-size:.8rem;background:#fff;cursor:pointer;color:var(--text-secondary);transition:all .15s}
.preset-btn:hover{border-color:var(--accent);color:var(--accent);background:var(--accent-light)}
.query-history-item{padding:6px 10px;border-bottom:1px solid var(--border);font-size:.82rem;font-family:monospace;cursor:pointer;color:var(--text-secondary)}
.query-history-item:hover{background:var(--accent-light);color:var(--accent)}

/* ── DB Explorer ───────────────────────────────────────────── */
.col-filter{padding:4px 6px;border:1px solid var(--border);border-radius:4px;font-size:.8rem;width:100%;outline:none;font-family:var(--font)}
.col-filter:focus{border-color:var(--accent)}
.cell-truncate{max-width:300px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
.cell-expand{cursor:pointer;color:var(--accent);font-size:.8rem}
.json-cell{font-family:monospace;font-size:.8rem;max-width:400px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}

/* ── Row detail modal ──────────────────────────────────────── */
.modal-overlay{position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,.5);display:flex;align-items:center;justify-content:center;z-index:100}
.modal{background:var(--surface);border-radius:12px;max-width:700px;width:90%;max-height:80vh;overflow-y:auto;box-shadow:0 20px 60px rgba(0,0,0,.2)}
.modal-header{padding:16px 20px;border-bottom:1px solid var(--border);display:flex;align-items:center;justify-content:space-between;position:sticky;top:0;background:var(--surface);z-index:1}
.modal-body{padding:20px}
.modal-field{padding:8px 0;border-bottom:1px solid var(--border)}
.modal-field:last-child{border-bottom:none}
.modal-field-label{font-size:.8rem;font-weight:600;color:var(--text-secondary);text-transform:uppercase;letter-spacing:.04em;margin-bottom:4px}
.modal-field-value{font-size:.9rem;word-break:break-all;white-space:pre-wrap}

/* ── Schedule cards ─────────────────────────────────────────── */
.sched-card{background:var(--surface);border-radius:var(--radius);box-shadow:var(--shadow);overflow:hidden;margin-bottom:16px;border-left:4px solid var(--border)}
.sched-card.loaded{border-left-color:var(--green)}
.sched-card.not-loaded{border-left-color:var(--red)}
.sched-card.running-now{border-left-color:var(--accent)}
.sched-header{display:flex;align-items:center;justify-content:space-between;padding:16px 20px;cursor:pointer}
.sched-header:hover{background:#fafbfc}
.sched-label{font-weight:700;font-size:1rem}
.sched-meta{display:flex;gap:16px;align-items:center;font-size:.85rem;color:var(--text-secondary)}
.sched-detail{padding:0 20px 16px;border-top:1px solid var(--border)}
.sched-field{display:flex;gap:12px;padding:8px 0;border-bottom:1px solid #f3f4f6;font-size:.9rem}
.sched-field:last-child{border-bottom:none}
.sched-field-label{min-width:130px;font-weight:600;color:var(--text-secondary);font-size:.8rem;text-transform:uppercase;letter-spacing:.04em}
.sched-field-value{flex:1;word-break:break-all;font-family:'SF Mono',Monaco,Consolas,monospace;font-size:.85rem}
.log-viewer{background:#1e1e2e;color:#cdd6f4;border-radius:6px;padding:16px;margin-top:12px;max-height:500px;overflow-y:auto;font-family:'SF Mono',Monaco,Consolas,monospace;font-size:.8rem;line-height:1.6}
.log-viewer .log-line{white-space:pre-wrap;word-break:break-all}
.log-viewer .log-line:hover{background:rgba(255,255,255,.05)}
.log-controls{display:flex;gap:8px;align-items:center;margin-top:12px}

/* ── Tailoring transparency ────────────────────────────────── */
.trace-grid{display:grid;grid-template-columns:320px 1fr;gap:16px}
.trace-list{max-height:520px;overflow-y:auto;border:1px solid var(--border);border-radius:6px;background:#fff}
.trace-item{padding:10px 12px;border-bottom:1px solid var(--border);cursor:pointer}
.trace-item:hover{background:#f8fafc}
.trace-item.active{background:var(--accent-light)}
.trace-meta{font-size:.75rem;color:var(--text-secondary)}
.trace-title{font-size:.85rem;font-weight:600}
.trace-pane{border:1px solid var(--border);border-radius:6px;background:#fff;min-height:520px;display:flex;flex-direction:column}
.trace-tabs{display:flex;gap:8px;padding:10px;border-bottom:1px solid var(--border)}
.trace-content{padding:12px;overflow:auto;max-height:460px}
.trace-content pre{white-space:pre-wrap;word-break:break-word;font-size:.8rem;font-family:'SF Mono',Monaco,Consolas,monospace}

/* ── Application packages (content review) ─────────────────── */
.pkg-grid{display:grid;grid-template-columns:340px 1fr;gap:16px}
.pkg-list{max-height:520px;overflow-y:auto;border:1px solid var(--border);border-radius:6px;background:#fff}
.pkg-item{padding:10px 12px;border-bottom:1px solid var(--border);cursor:pointer}
.pkg-item:hover{background:#f8fafc}
.pkg-item.active{background:var(--accent-light)}
.pkg-main{display:flex;flex-direction:column;gap:16px}
.editor-grid{display:grid;grid-template-columns:1fr 1fr;gap:16px}
.latex-editor{width:100%;min-height:560px;padding:12px;border:1px solid var(--border);border-radius:6px;font-family:'SF Mono',Monaco,Consolas,monospace;font-size:.85rem;line-height:1.5;resize:vertical;background:#fafbfc}
.doc-box{border:1px solid var(--border);border-radius:6px;background:#fff}
.doc-box-header{padding:10px 12px;border-bottom:1px solid var(--border);font-size:.85rem;font-weight:600}
.doc-box-body{padding:12px;max-height:360px;overflow:auto}
.doc-box-body pre{white-space:pre-wrap;word-break:break-word;font-size:.8rem;font-family:'SF Mono',Monaco,Consolas,monospace}

/* ── Empty state ────────────────────────────────────────────── */
.empty{text-align:center;padding:48px 20px;color:var(--text-secondary)}
.empty-icon{font-size:2rem;margin-bottom:8px;opacity:.4}
.empty-text{font-size:.95rem}

/* ── Loading ────────────────────────────────────────────────── */
.loading{display:flex;align-items:center;justify-content:center;padding:40px}
.spinner{width:24px;height:24px;border:3px solid var(--border);border-top-color:var(--accent);border-radius:50%;animation:spin .6s linear infinite}
@keyframes spin{to{transform:rotate(360deg)}}

/* ── Link ───────────────────────────────────────────────────── */
a{color:var(--accent);text-decoration:none}
a:hover{text-decoration:underline}
.ext-link{color:var(--text-secondary);transition:color .15s}
.ext-link:hover{color:var(--accent)}

/* ── Responsive ─────────────────────────────────────────────── */
@media(max-width:768px){
  .sidebar{width:60px}.sidebar-brand span,.nav-item span,.sidebar-footer{display:none}
  .nav-item{justify-content:center;padding:12px}.main{margin-left:60px;padding:16px}
  .chart-row{grid-template-columns:1fr}.cards{grid-template-columns:repeat(2,1fr)}
  .runs-control-panel{grid-template-columns:1fr}
  .trace-grid{grid-template-columns:1fr}
  .pkg-grid{grid-template-columns:1fr}
  .editor-grid{grid-template-columns:1fr}
}
</style>
</head>
<body x-data="dashboard()" x-init="init()">

<!-- ── Sidebar ──────────────────────────────────────────────── -->
<aside class="sidebar">
  <div class="sidebar-brand"><span>Job</span> Scraper</div>
  <nav class="sidebar-nav">
    <div class="nav-item" :class="{active: view==='overview'}" @click="go('overview')">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="7" height="7" rx="1"/><rect x="14" y="3" width="7" height="7" rx="1"/><rect x="3" y="14" width="7" height="7" rx="1"/><rect x="14" y="14" width="7" height="7" rx="1"/></svg>
      <span>Overview</span>
    </div>
    <div class="nav-item" :class="{active: view==='jobs'}" @click="go('jobs')">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 13V6a2 2 0 00-2-2H5a2 2 0 00-2 2v14a2 2 0 002 2h8"/><line x1="16" y1="17" x2="22" y2="17"/><line x1="16" y1="21" x2="22" y2="21"/></svg>
      <span>Jobs</span>
    </div>
    <div class="nav-item" :class="{active: view==='rejected'}" @click="go('rejected')">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><line x1="4.93" y1="4.93" x2="19.07" y2="19.07"/></svg>
      <span>Rejected</span>
    </div>
    <div class="nav-item" :class="{active: view==='runs'}" @click="go('runs')">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>
      <span>Runs</span>
    </div>
    <div class="nav-item" :class="{active: view==='tailoring'}" @click="go('tailoring')">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 6h18M3 12h18M3 18h18"/><circle cx="7" cy="6" r="1"/><circle cx="12" cy="12" r="1"/><circle cx="17" cy="18" r="1"/></svg>
      <span>Tailoring</span>
    </div>
    <div class="nav-item" :class="{active: view==='packages'}" @click="go('packages')">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 8v13H3V8"/><path d="M1 3h22v5H1z"/><path d="M10 12h4"/><path d="M12 8v8"/></svg>
      <span>Applications</span>
    </div>
    <div class="nav-item" :class="{active: view==='dedup'}" @click="go('dedup')">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polygon points="22 3 2 3 10 12.46 10 19 14 21 14 12.46 22 3"/></svg>
      <span>Dedup & Growth</span>
    </div>
    <div class="nav-item" :class="{active: view==='schedules'}" @click="go('schedules')">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/><path d="M8 14h.01"/><path d="M12 14h.01"/><path d="M16 14h.01"/><path d="M8 18h.01"/><path d="M12 18h.01"/></svg>
      <span>Schedules</span>
    </div>
    <div class="nav-item" :class="{active: view==='explorer'}" @click="go('explorer')">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><ellipse cx="12" cy="5" rx="9" ry="3"/><path d="M21 12c0 1.66-4 3-9 3s-9-1.34-9-3"/><path d="M3 5v14c0 1.66 4 3 9 3s9-1.34 9-3V5"/></svg>
      <span>DB Explorer</span>
    </div>
    <div class="nav-item" :class="{active: view==='sql'}" @click="go('sql')">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="16 18 22 12 16 6"/><polyline points="8 6 2 12 8 18"/></svg>
      <span>SQL Console</span>
    </div>
  </nav>
  <div class="sidebar-footer">
    <div class="db-size" x-text="dbSizeLabel"></div>
    v2.0 &middot; Port 8899
  </div>
</aside>

<!-- ── Main ─────────────────────────────────────────────────── -->
<div class="main">

<!-- ══════════════════════════════════════════════════════════════
     VIEW: OVERVIEW
     ══════════════════════════════════════════════════════════════ -->
<div x-show="view==='overview'" x-transition.opacity>
  <div class="page-header">
    <div class="page-title">Overview</div>
    <div style="display:flex;align-items:center;gap:12px">
      <span class="pill" :class="llmStatus?.enabled===false ? 'pill-unknown' : (llmStatus?.available ? 'pill-success' : 'pill-fail')"
            x-text="llmStatus?.enabled===false ? 'LLM disabled' : (llmStatus?.available ? 'LLM online' : 'LLM offline')"
            :title="llmStatus?.enabled===false ? 'LLM checks are disabled by runtime controls' : (llmStatus?.available ? llmStatus.models.join(', ') : 'LLM server not reachable at ' + llmStatus?.url)">
      </span>
      <div class="last-updated" x-text="'Updated ' + timeAgo(lastFetch)"></div>
    </div>
  </div>

  <div class="cards">
    <div class="card">
      <div class="card-icon blue"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M20 7H4a2 2 0 00-2 2v10a2 2 0 002 2h16a2 2 0 002-2V9a2 2 0 00-2-2z"/><path d="M16 7V5a2 2 0 00-2-2h-4a2 2 0 00-2 2v2"/></svg></div>
      <div class="card-label">Total Jobs</div>
      <div class="card-value" x-text="fmt(ov.total_results)"></div>
    </div>
    <div class="card">
      <div class="card-icon purple"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/><circle cx="12" cy="12" r="3"/></svg></div>
      <div class="card-label">URLs Seen</div>
      <div class="card-value" x-text="fmt(ov.total_seen)"></div>
    </div>
    <div class="card">
      <div class="card-icon green"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg></div>
      <div class="card-label">Today</div>
      <div class="card-value" x-text="fmt(ov.jobs_today)"></div>
    </div>
    <div class="card">
      <div class="card-icon cyan"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M16 21v-2a4 4 0 00-4-4H5a4 4 0 00-4 4v2"/><circle cx="8.5" cy="7" r="4"/><polyline points="17 11 19 13 23 9"/></svg></div>
      <div class="card-label">Dedup Ratio</div>
      <div class="card-value" x-text="ov.dedup_ratio != null ? (ov.dedup_ratio * 100).toFixed(1) + '%' : '—'"></div>
      <div class="card-sub">results / seen</div>
    </div>
    <div class="card">
      <div class="card-icon amber"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg></div>
      <div class="card-label">Last Run</div>
      <div class="card-value" style="font-size:1.1rem" x-text="ov.last_run ? timeAgo(ov.last_run.timestamp) : '—'"></div>
      <div class="card-sub">
        <span class="pill" :class="ov.last_run ? 'pill-'+ov.last_run.status : ''" x-text="ov.last_run?.status ?? ''"></span>
      </div>
    </div>
    <div class="card">
      <div class="card-icon red"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><ellipse cx="12" cy="5" rx="9" ry="3"/><path d="M21 12c0 1.66-4 3-9 3s-9-1.34-9-3"/><path d="M3 5v14c0 1.66 4 3 9 3s9-1.34 9-3V5"/></svg></div>
      <div class="card-label">DB Size</div>
      <div class="card-value" style="font-size:1.1rem" x-text="fmtBytes(ov.db_size)"></div>
    </div>
  </div>

  <!-- Run health strip -->
  <div class="health-strip" x-show="ov.run_health && ov.run_health.length > 0">
    <span class="health-strip-label">Last 20 Runs</span>
    <template x-for="rh in (ov.run_health || []).slice().reverse()" :key="rh.run_id">
      <div class="health-block" :class="rh.status === 'complete' ? 'success' : (rh.status === 'running' ? 'running' : 'failed')">
        <div class="health-block-tooltip" x-text="rh.status + ' — ' + timeAgo(rh.started_at)"></div>
      </div>
    </template>
  </div>

  <div class="chart-container">
    <div class="chart-title">Cumulative Growth</div>
    <canvas id="growthChart" style="max-height:300px"></canvas>
  </div>

  <div class="chart-container">
    <div class="chart-title">Daily Discovery (Last 30 Days)</div>
    <canvas id="trendChart"></canvas>
  </div>

  <div class="chart-row">
    <div class="chart-container">
      <div class="chart-title">By Board</div>
      <canvas id="boardChart"></canvas>
    </div>
    <div class="chart-container">
      <div class="chart-title">By Seniority</div>
      <canvas id="seniorityChart"></canvas>
    </div>
  </div>
</div>

<!-- ══════════════════════════════════════════════════════════════
     VIEW: JOBS
     ══════════════════════════════════════════════════════════════ -->
<div x-show="view==='jobs'" x-transition.opacity>
  <div class="page-header">
    <div class="page-title">Jobs</div>
    <div class="pagination-info" x-text="jobs.total + ' total results'"></div>
  </div>

  <div class="panel">
    <div class="filters">
      <select x-model="jf.board" @change="jPage=1;fetchJobs()">
        <option value="">All Boards</option>
        <template x-for="b in boards"><option :value="b" x-text="b"></option></template>
      </select>
      <select x-model="jf.seniority" @change="jPage=1;fetchJobs()">
        <option value="">All Seniority</option>
        <template x-for="s in seniorities"><option :value="s" x-text="s"></option></template>
      </select>
      <input type="text" placeholder="Search titles..." x-model.debounce.300ms="jf.search" @input="jPage=1;fetchJobs()" style="min-width:160px">
      <input type="text" placeholder="Search URLs..." x-model.debounce.300ms="jf.url_search" @input="jPage=1;fetchJobs()" style="min-width:160px">
      <select x-model="jf.run_id" @change="jPage=1;fetchJobs()">
        <option value="">All Runs</option>
        <template x-for="r in runIds"><option :value="r" x-text="r.slice(0,12) + '...'"></option></template>
      </select>
      <input type="date" x-model="jf.date_from" @change="jPage=1;fetchJobs()">
      <input type="date" x-model="jf.date_to" @change="jPage=1;fetchJobs()">
      <button class="btn btn-ghost btn-sm" @click="clearJobFilters()">Clear</button>
    </div>

    <!-- Bulk stats bar -->
    <div class="stats-bar" x-show="jobs.items.length > 0">
      <span>Showing <strong x-text="jobs.items.length"></strong> of <strong x-text="jobs.total"></strong></span>
      <span x-text="jobStatsBar"></span>
    </div>

    <div x-show="jobsLoading" class="loading"><div class="spinner"></div></div>

    <template x-if="!jobsLoading && jobs.items.length === 0">
      <div class="empty"><div class="empty-icon">&#128270;</div><div class="empty-text">No jobs match your filters</div></div>
    </template>

    <table x-show="!jobsLoading && jobs.items.length > 0">
      <thead>
        <tr>
          <th @click="toggleSort('title')" :class="{sorted: jSort.by==='title'}">Title <span class="sort-arrow" x-text="jSort.by==='title'?(jSort.dir==='asc'?'&#9650;':'&#9660;'):'&#9660;'"></span></th>
          <th @click="toggleSort('board')" :class="{sorted: jSort.by==='board'}">Board <span class="sort-arrow" x-text="jSort.by==='board'?(jSort.dir==='asc'?'&#9650;':'&#9660;'):'&#9660;'"></span></th>
          <th @click="toggleSort('seniority')" :class="{sorted: jSort.by==='seniority'}">Seniority <span class="sort-arrow" x-text="jSort.by==='seniority'?(jSort.dir==='asc'?'&#9650;':'&#9660;'):'&#9660;'"></span></th>
          <th @click="toggleSort('experience_years')" :class="{sorted: jSort.by==='experience_years'}">Exp <span class="sort-arrow" x-text="jSort.by==='experience_years'?(jSort.dir==='asc'?'&#9650;':'&#9660;'):'&#9660;'"></span></th>
          <th @click="toggleSort('salary_k')" :class="{sorted: jSort.by==='salary_k'}">Salary <span class="sort-arrow" x-text="jSort.by==='salary_k'?(jSort.dir==='asc'?'&#9650;':'&#9660;'):'&#9660;'"></span></th>
          <th @click="toggleSort('created_at')" :class="{sorted: jSort.by==='created_at'}">Date <span class="sort-arrow" x-text="jSort.by==='created_at'?(jSort.dir==='asc'?'&#9650;':'&#9660;'):'&#9660;'"></span></th>
          <th style="width:40px"></th>
        </tr>
      </thead>
      <tbody>
        <template x-for="job in jobs.items" :key="job.id">
          <tr>
            <td>
              <div @click="toggleJob(job.id)" style="cursor:pointer">
                <div style="font-weight:600;max-width:400px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap">
                  <span x-text="job.title"></span>
                  <span class="pill pill-new" x-show="job.run_id === jobs.latest_run_id">NEW</span>
                </div>
                <div style="font-size:.8rem;color:var(--text-secondary);max-width:400px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap" x-text="job.snippet"></div>
              </div>
              <!-- Expanded detail -->
              <template x-if="expandedId === job.id">
                <div class="job-detail" @click.stop>
                  <div style="margin-bottom:8px"><strong>URL:</strong> <a :href="job.url" target="_blank" x-text="job.url"></a></div>
                  <div style="margin-bottom:8px"><strong>Query:</strong> <span x-text="job.query" style="color:var(--text-secondary)"></span></div>
                  <div style="margin-bottom:8px"><strong>Run:</strong> <span x-text="job.run_id" style="color:var(--text-secondary)"></span></div>
                  <div style="margin-bottom:8px" x-show="expandedDetail?.salary_k"><strong>Salary:</strong> <span x-text="expandedDetail?.salary_k ? '$' + Math.round(expandedDetail.salary_k/1000) + 'K' : ''" style="color:var(--green);font-weight:600"></span></div>

                  <template x-if="expandedDetail">
                    <div>
                      <div class="verdicts">
                        <div style="font-weight:600;margin-bottom:8px">Filter Verdicts</div>
                        <div class="verdicts-grid">
                        <template x-for="v in expandedDetail.filter_verdicts">
                          <div class="verdict-chip" :class="v.stage==='llm_review' ? 'llm' : (v.passed?'pass':'fail')">
                            <div class="verdict-dot"
                                 :class="v.stage==='llm_review' ? 'llm' : (v.passed?'pass':'fail')"
                                 x-text="v.stage==='llm_review' ? '&#129504;' : (v.passed?'&#10003;':'&#10007;')">
                            </div>
                            <div>
                              <div class="verdict-stage"
                                   :style="v.stage==='llm_review' ? 'color:var(--purple)' : ''"
                                   x-text="v.stage==='llm_review' ? 'AI Review' : v.stage">
                              </div>
                              <div class="verdict-reason" x-text="v.reason"></div>
                            </div>
                          </div>
                        </template>
                        </div>
                      </div>
                      <template x-if="expandedDetail.jd_text">
                        <div>
                          <div style="font-weight:600;margin-top:16px;margin-bottom:4px">Job Description</div>
                          <div class="jd-text" x-text="expandedDetail.jd_text"></div>
                        </div>
                      </template>
                    </div>
                  </template>
                  <template x-if="!expandedDetail">
                    <div class="loading" style="padding:16px"><div class="spinner"></div></div>
                  </template>
                </div>
              </template>
            </td>
            <td><span class="pill" :class="'pill-'+job.board" x-text="job.board"></span></td>
            <td><span class="pill" :class="'pill-'+job.seniority" x-text="job.seniority"></span></td>
            <td x-text="job.experience_years ?? '—'"></td>
            <td x-text="job.salary_k ? '$' + Math.round(job.salary_k/1000) + 'K' : '—'" style="white-space:nowrap;color:var(--text)" :style="job.salary_k ? 'font-weight:600' : ''"></td>
            <td style="white-space:nowrap" x-text="fmtDate(job.created_at)"></td>
            <td><a :href="job.url" target="_blank" class="ext-link" title="Open job posting"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M18 13v6a2 2 0 01-2 2H5a2 2 0 01-2-2V8a2 2 0 012-2h6"/><polyline points="15 3 21 3 21 9"/><line x1="10" y1="14" x2="21" y2="3"/></svg></a></td>
          </tr>
        </template>
      </tbody>
    </table>

    <div class="pagination" x-show="jobs.pages > 0">
      <div class="pagination-info" x-text="'Page ' + jPage + ' of ' + jobs.pages"></div>
      <div class="pagination-controls">
        <select x-model="jPerPage" @change="jPage=1;fetchJobs()" style="padding:4px 8px;border:1px solid var(--border);border-radius:6px;font-size:.85rem">
          <option value="25">25</option><option value="50">50</option><option value="100">100</option>
        </select>
        <button :disabled="jPage<=1" @click="jPage--;fetchJobs()">Prev</button>
        <span class="page-num" x-text="jPage + ' / ' + jobs.pages"></span>
        <button :disabled="jPage>=jobs.pages" @click="jPage++;fetchJobs()">Next</button>
      </div>
    </div>
  </div>
</div>

<!-- ══════════════════════════════════════════════════════════════
     VIEW: REJECTED
     ══════════════════════════════════════════════════════════════ -->
<div x-show="view==='rejected'" x-transition.opacity>
  <div class="page-header">
    <div class="page-title">Rejected Jobs</div>
    <div style="font-size:.85rem;color:var(--text-secondary)" x-text="(rejectedStats?.total || 0).toLocaleString() + ' total rejections'"></div>
  </div>

  <!-- Stage breakdown strip -->
  <div class="panel" style="margin-bottom:24px" x-show="rejectedStats">
    <div class="panel-header"><div class="panel-title">Rejection Breakdown by Stage</div><div style="font-size:.8rem;color:var(--text-secondary)">Click to filter</div></div>
    <div style="padding:14px 20px;display:flex;gap:8px;flex-wrap:wrap;align-items:center">
      <span class="pill" style="cursor:pointer;font-size:.82rem;padding:4px 12px"
            :class="rf.stage===''?'pill-running':'pill-unknown'"
            @click="rf.stage='';rPage=1;fetchRejected()"
            x-text="'All (' + (rejectedStats?.total||0) + ')'"></span>
      <template x-for="[stage, cnt] in Object.entries(rejectedStats?.by_stage||{})" :key="stage">
        <span class="pill" style="cursor:pointer;font-size:.82rem;padding:4px 12px"
              :class="rf.stage===stage ? 'pill-running' : ('pill-stage-'+stage)"
              @click="rf.stage=stage;rPage=1;fetchRejected()"
              x-text="stage + ' (' + cnt + ')'"></span>
      </template>
    </div>
  </div>

  <div class="panel">
    <div class="filters">
      <select x-model="rf.stage" @change="rPage=1;fetchRejected()">
        <option value="">All Stages</option>
        <template x-for="s in rejectedStages"><option :value="s" x-text="s"></option></template>
      </select>
      <select x-model="rf.run_id" @change="rPage=1;fetchRejected()">
        <option value="">All Runs</option>
        <template x-for="r in runIds"><option :value="r" x-text="r.slice(0,12)+'...'"></option></template>
      </select>
      <input type="text" placeholder="Search titles..." x-model.debounce.300ms="rf.search" @input="rPage=1;fetchRejected()" style="min-width:180px">
      <button class="btn btn-ghost btn-sm" @click="rf={stage:'',run_id:'',search:''};rPage=1;fetchRejected()">Clear</button>
    </div>

    <div class="stats-bar" x-show="rejected.total > 0">
      <span>Showing <strong x-text="rejected.items.length"></strong> of <strong x-text="rejected.total"></strong></span>
    </div>

    <div x-show="rejectedLoading" class="loading"><div class="spinner"></div></div>

    <template x-if="!rejectedLoading && rejected.items.length === 0">
      <div class="empty"><div class="empty-icon">&#10004;</div><div class="empty-text">No rejections match your filters</div></div>
    </template>

    <table x-show="!rejectedLoading && rejected.items.length > 0">
      <thead>
        <tr>
          <th>Title</th>
          <th>Board</th>
          <th>Rejected At</th>
          <th>Reason</th>
          <th>Date</th>
          <th style="width:160px">Actions</th>
        </tr>
      </thead>
      <tbody>
        <template x-for="job in rejected.items" :key="job.id">
          <tr>
            <td>
              <div @click="toggleRejected(job.id)" style="cursor:pointer">
                <div style="font-weight:600;max-width:380px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap" x-text="job.title"></div>
                <div style="font-size:.8rem;color:var(--text-secondary);max-width:380px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap" x-text="job.snippet"></div>
              </div>
              <!-- Expanded detail -->
              <template x-if="expandedRejectedId === job.id">
                <div class="job-detail" @click.stop>
                  <div style="margin-bottom:8px"><strong>URL:</strong> <a :href="job.url" target="_blank" x-text="job.url"></a></div>
                  <div style="margin-bottom:8px"><strong>Run:</strong> <span x-text="job.run_id" style="color:var(--text-secondary)"></span></div>
                  <template x-if="expandedRejectedDetail">
                    <div class="verdicts" style="margin-top:8px">
                      <div style="font-weight:600;margin-bottom:8px">Filter Verdicts</div>
                      <div class="verdicts-grid">
                      <template x-for="v in expandedRejectedDetail.filter_verdicts">
                        <div class="verdict-chip" :class="v.stage==='llm_review' ? 'llm' : (v.passed?'pass':'fail')">
                          <div class="verdict-dot"
                               :class="v.stage==='llm_review' ? 'llm' : (v.passed?'pass':'fail')"
                               x-text="v.stage==='llm_review' ? '&#129504;' : (v.passed?'&#10003;':'&#10007;')">
                          </div>
                          <div>
                            <div class="verdict-stage"
                                 :style="v.stage==='llm_review' ? 'color:var(--purple)' : (!v.passed ? 'color:var(--red)' : '')"
                                 x-text="v.stage==='llm_review' ? 'AI Review' : v.stage">
                            </div>
                            <div class="verdict-reason" x-text="v.reason"></div>
                          </div>
                        </div>
                      </template>
                      </div>
                    </div>
                  </template>
                  <template x-if="!expandedRejectedDetail">
                    <div class="loading" style="padding:12px"><div class="spinner"></div></div>
                  </template>
                </div>
              </template>
            </td>
            <td><span class="pill" :class="'pill-'+job.board" x-text="job.board"></span></td>
            <td><span class="pill" :class="'pill-stage-'+job.rejection_stage" x-text="job.rejection_stage"></span></td>
            <td style="font-size:.82rem;color:var(--text-secondary);max-width:280px;word-break:break-word" x-text="job.rejection_reason"></td>
            <td style="white-space:nowrap" x-text="fmtDate(job.created_at)"></td>
            <td>
              <div style="display:flex;align-items:center;gap:8px;justify-content:flex-end">
                <button
                  class="btn btn-success btn-sm"
                  :disabled="!!approvingRejectedIds[job.id]"
                  @click.stop="approveRejected(job)"
                  x-text="approvingRejectedIds[job.id] ? 'Approving...' : 'Approve'"></button>
                <a :href="job.url" target="_blank" class="ext-link" title="Open URL"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M18 13v6a2 2 0 01-2 2H5a2 2 0 01-2-2V8a2 2 0 012-2h6"/><polyline points="15 3 21 3 21 9"/><line x1="10" y1="14" x2="21" y2="3"/></svg></a>
              </div>
            </td>
          </tr>
        </template>
      </tbody>
    </table>

    <div class="pagination" x-show="rejected.pages > 1">
      <div class="pagination-info" x-text="'Page ' + rPage + ' of ' + rejected.pages + ' (' + rejected.total + ' total)'"></div>
      <div class="pagination-controls">
        <select x-model="rPerPage" @change="rPage=1;fetchRejected()" style="padding:4px 8px;border:1px solid var(--border);border-radius:6px;font-size:.85rem">
          <option value="50">50</option><option value="100">100</option><option value="200">200</option>
        </select>
        <button :disabled="rPage<=1" @click="rPage--;fetchRejected()">Prev</button>
        <span class="page-num" x-text="rPage + ' / ' + rejected.pages"></span>
        <button :disabled="rPage>=rejected.pages" @click="rPage++;fetchRejected()">Next</button>
      </div>
    </div>
  </div>
</div>

<!-- ══════════════════════════════════════════════════════════════
     VIEW: RUNS
     ══════════════════════════════════════════════════════════════ -->
<div x-show="view==='runs'" x-transition.opacity>
  <div class="page-header">
    <div class="page-title">Run History</div>
    <div class="last-updated" x-text="'Updated ' + timeAgo(lastFetch)"></div>
  </div>

  <div class="runs-control-panel">
    <div class="runs-control-block">
      <div class="runs-control-title">Current State</div>
      <div class="runs-pill-row">
        <span class="pill" :class="runtimeControls.scrape_enabled ? 'pill-success' : 'pill-unknown'"
              x-text="runtimeControls.scrape_enabled ? 'Scheduled scrape enabled' : 'Scheduled scrape disabled'"></span>
        <span class="pill" :class="isActive ? 'pill-running' : 'pill-unknown'"
              x-text="isActive ? 'Scrape currently running' : 'No active scrape run'"></span>
        <span class="pill" :class="llmStatus?.enabled===false ? 'pill-unknown' : (llmStatus?.available ? 'pill-success' : 'pill-fail')"
              x-text="llmStatus?.enabled===false ? 'LLM review disabled' : (llmStatus?.available ? 'LLM online' : 'LLM offline')"></span>
      </div>
      <div class="control-note" x-text="runtimeControls.updated_at ? ('Last control change: ' + fmtDate(runtimeControls.updated_at)) : 'No control changes yet'"></div>
    </div>

    <div class="runs-control-block">
      <div class="runs-control-title">Runtime Toggles</div>
      <div class="switch-row">
        <div class="switch-item">
          <div class="switch-meta">
            <strong>Scheduled Scrape</strong>
            <span>Keep launchd runs active or pause them at runtime.</span>
          </div>
          <label class="switch">
            <input type="checkbox" x-model="runtimeControls.scrape_enabled" :disabled="controlsBusy" @change="setScrapeEnabled(runtimeControls.scrape_enabled)">
            <span class="slider"></span>
          </label>
        </div>
        <div class="switch-item">
          <div class="switch-meta">
            <strong>Scheduled LLM Review</strong>
            <span>Control whether scheduled scrapes run the LLM review stage.</span>
          </div>
          <label class="switch">
            <input type="checkbox" x-model="runtimeControls.llm_enabled" :disabled="controlsBusy" @change="setLlmEnabled(runtimeControls.llm_enabled)">
            <span class="slider"></span>
          </label>
        </div>
      </div>
    </div>

    <div class="runs-control-block">
      <div class="runs-control-title">Manual Pipeline Run</div>
        <div class="control-actions">
          <div class="control-action-row">
            <button class="btn btn-primary" :disabled="scrapeRunBusy || scrapeRunner.running || isActive" @click="runScrapeNow(true)">
              <span x-text="scrapeRunBusy ? 'Starting...' : (scrapeRunner.running ? 'Manual run in progress' : 'Run Pipeline With LLM')"></span>
            </button>
            <button class="btn btn-ghost" :disabled="scrapeRunBusy || scrapeRunner.running || isActive" @click="runScrapeNow(false)">
              Run Pipeline Without LLM
            </button>
            <button class="btn btn-ghost btn-sm" @click="fetchScrapeRunnerStatus()">Refresh</button>
          </div>
        <div class="control-note">Manual runs always bypass scheduled controls. Choose whether this run should use LLM review.</div>
        <div style="font-size:.82rem;color:var(--red)" x-show="scrapeRunError" x-text="scrapeRunError"></div>
        <div class="control-note" x-show="scrapeRunner.started_at">
          Last manual run: <strong x-text="scrapeRunner.running ? 'running' : (scrapeRunner.exit_code === 0 ? 'completed' : 'failed')"></strong>
          <span x-text="' (' + timeAgo(scrapeRunner.started_at) + ')'"></span>
          <span x-show="scrapeRunner.options">
            — LLM:
            <strong x-text="scrapeRunner.options && scrapeRunner.options.llm_enabled_override === false ? 'off' : 'on'"></strong>
          </span>
        </div>
        <pre class="manual-log" x-show="scrapeRunner.log_tail" x-text="scrapeRunner.log_tail"></pre>
      </div>
    </div>
  </div>

  <!-- Run stats -->
  <div class="cards" style="margin-bottom:24px" x-show="runStats">
    <div class="card">
      <div class="card-label">Avg Duration</div>
      <div class="card-value" style="font-size:1.3rem" x-text="runStats ? fmtDuration(runStats.avg_duration) : '—'"></div>
    </div>
    <div class="card">
      <div class="card-label">Success Rate</div>
      <div class="card-value" style="font-size:1.3rem" x-text="runStats ? runStats.success_rate + '%' : '—'"></div>
    </div>
    <div class="card">
      <div class="card-label">Avg Jobs/Run</div>
      <div class="card-value" style="font-size:1.3rem" x-text="runStats ? runStats.avg_jobs_per_run : '—'"></div>
    </div>
    <div class="card">
      <div class="card-label">Total Runs</div>
      <div class="card-value" style="font-size:1.3rem" x-text="runStats ? runStats.total_runs : '—'"></div>
    </div>
  </div>

  <!-- Timeline visualization -->
  <div class="chart-container" x-show="runs.length > 0">
    <div class="chart-title">Run Duration Timeline</div>
    <canvas id="runTimelineChart" style="max-height:200px"></canvas>
  </div>

  <div class="panel">
    <div x-show="runsLoading" class="loading"><div class="spinner"></div></div>
    <table x-show="!runsLoading">
      <thead>
        <tr>
          <th>Time</th>
          <th>Duration</th>
          <th>Status</th>
          <th>Pipeline</th>
          <th>Stored</th>
          <th>Rejected</th>
          <th>Run ID</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody>
        <template x-for="run in runs" :key="run.run_id">
          <tr>
            <td>
              <div style="white-space:nowrap;cursor:pointer" @click="toggleRunExpand(run.run_id)">
                <span x-text="fmtDate(run.started_at)"></span>
                <span style="font-size:.8rem;color:var(--accent);margin-left:4px" x-text="expandedRunId === run.run_id ? '&#9660;' : '&#9654;'"></span>
              </div>
              <!-- Run drill-down -->
              <template x-if="expandedRunId === run.run_id">
                <div style="margin-top:12px">
                  <!-- Run Funnel -->
                  <div style="display:flex;flex-direction:column;gap:4px;margin-bottom:16px;padding:12px;background:#f8fafc;border-radius:6px;border:1px solid var(--border)">
                    <div style="font-size:.75rem;font-weight:600;text-transform:uppercase;color:var(--text-secondary);margin-bottom:4px">Run Attrition Funnel</div>
                    <div style="display:flex;align-items:center;gap:8px">
                      <div style="width:80px;font-size:.75rem;color:var(--text-secondary)">Raw</div>
                      <div style="flex:1;height:12px;background:#e2e8f0;border-radius:6px;overflow:hidden">
                        <div style="height:100%;background:var(--purple)" :style="'width:' + (run.raw_count ? 100 : 0) + '%'"></div>
                      </div>
                      <div style="width:40px;font-size:.75rem;font-weight:600" x-text="run.raw_count || 0"></div>
                    </div>
                    <div style="display:flex;align-items:center;gap:8px">
                      <div style="width:80px;font-size:.75rem;color:var(--text-secondary)">Unique</div>
                      <div style="flex:1;height:12px;background:#e2e8f0;border-radius:6px;overflow:hidden">
                        <div style="height:100%;background:var(--cyan)" :style="'width:' + (run.raw_count ? (run.dedup_count / run.raw_count * 100) : 0) + '%'"></div>
                      </div>
                      <div style="width:40px;font-size:.75rem;font-weight:600" x-text="run.dedup_count || 0"></div>
                    </div>
                    <div style="display:flex;align-items:center;gap:8px">
                      <div style="width:80px;font-size:.75rem;color:var(--text-secondary)">Filtered</div>
                      <div style="flex:1;height:12px;background:#e2e8f0;border-radius:6px;overflow:hidden">
                        <div style="height:100%;background:var(--amber)" :style="'width:' + (run.raw_count ? (run.filtered_count / run.raw_count * 100) : 0) + '%'"></div>
                      </div>
                      <div style="width:40px;font-size:.75rem;font-weight:600" x-text="run.filtered_count || 0"></div>
                    </div>
                    <div style="display:flex;align-items:center;gap:8px">
                      <div style="width:80px;font-size:.75rem;color:var(--text-secondary)">Stored</div>
                      <div style="flex:1;height:12px;background:#e2e8f0;border-radius:6px;overflow:hidden">
                        <div style="height:100%;background:var(--green)" :style="'width:' + (run.raw_count ? (run.job_count / run.raw_count * 100) : 0) + '%'"></div>
                      </div>
                      <div style="width:40px;font-size:.75rem;font-weight:600" x-text="run.job_count || 0"></div>
                    </div>
                  </div>

                  <!-- Errors -->
                  <template x-if="run.errors && run.errors.length > 0">
                    <div class="error-panel">
                      <div class="error-panel-title">Errors (<span x-text="run.errors.length"></span>)</div>
                      <template x-for="err in run.errors">
                        <div class="error-item" x-text="err"></div>
                      </template>
                    </div>
                  </template>
                  <!-- Jobs from this run -->
                  <template x-if="expandedRunJobs !== null">
                    <div>
                      <div style="font-weight:600;margin-bottom:8px;font-size:.85rem" x-text="expandedRunJobs.length + ' jobs from this run'"></div>
                      <template x-if="expandedRunJobs.length > 0">
                        <table style="font-size:.85rem">
                          <thead><tr><th>Title</th><th>Board</th><th>Seniority</th></tr></thead>
                          <tbody>
                            <template x-for="rj in expandedRunJobs.slice(0,20)" :key="rj.id">
                              <tr>
                                <td><a :href="rj.url" target="_blank" x-text="rj.title" style="font-size:.85rem"></a></td>
                                <td><span class="pill" :class="'pill-'+rj.board" x-text="rj.board"></span></td>
                                <td><span class="pill" :class="'pill-'+rj.seniority" x-text="rj.seniority"></span></td>
                              </tr>
                            </template>
                          </tbody>
                        </table>
                      </template>
                      <template x-if="expandedRunJobs.length > 20">
                        <div style="padding:8px 0;font-size:.8rem;color:var(--text-secondary)" x-text="'+ ' + (expandedRunJobs.length - 20) + ' more...'"></div>
                      </template>
                    </div>
                  </template>
                  <template x-if="expandedRunJobs === null && expandedRunId === run.run_id">
                    <div class="loading" style="padding:12px"><div class="spinner"></div></div>
                  </template>
                </div>
              </template>
            </td>
            <td x-text="run.elapsed != null ? fmtDuration(run.elapsed) : '—'"></td>
            <td><span class="pill" :class="run.status==='complete'?'pill-success':(run.status==='running'?'pill-running':'pill-fail')" x-text="run.status"></span></td>
            <td>
              <div class="run-flow">
                <span x-text="run.raw_count ?? '—'"></span>
                <span class="arrow">&#8594;</span>
                <span x-text="run.dedup_count ?? '—'"></span>
                <span class="arrow">&#8594;</span>
                <strong x-text="run.filtered_count ?? '—'"></strong>
              </div>
            </td>
            <td style="font-weight:600" x-text="run.job_count ?? '—'"></td>
            <td style="color:var(--red);font-weight:600" x-text="run.filtered_count - (run.job_count || 0)"></td>
            <td style="font-size:.8rem;color:var(--text-secondary)" x-text="run.run_id.slice(0,12) + '...'"></td>
            <td>
              <div style="display:flex;gap:4px">
                <button class="btn btn-ghost btn-sm" @click="jf.run_id=run.run_id; jPage=1; fetchJobs(); go('jobs')" title="View stored jobs">Jobs</button>
                <button class="btn btn-ghost btn-sm" @click="rf.run_id=run.run_id; rPage=1; fetchRejected(); go('rejected')" title="View rejected jobs">Rej</button>
              </div>
            </td>
          </tr>
        </template>
      </tbody>
    </table>

    <div class="pagination" x-show="runPages > 1">
      <div class="pagination-info" x-text="'Page ' + runPage + ' of ' + runPages"></div>
      <div class="pagination-controls">
        <button :disabled="runPage<=1" @click="runPage--;fetchRuns()">Prev</button>
        <span class="page-num" x-text="runPage + ' / ' + runPages"></span>
        <button :disabled="runPage>=runPages" @click="runPage++;fetchRuns()">Next</button>
      </div>
    </div>
  </div>
</div>

<!-- ══════════════════════════════════════════════════════════════
     VIEW: TAILORING
     ══════════════════════════════════════════════════════════════ -->
<div x-show="view==='tailoring'" x-transition.opacity>
  <div class="page-header">
    <div class="page-title">Tailoring Transparency</div>
    <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap">
      <select x-model.number="tailoringRunConfig.selected_job_id" @change="fetchTailoringSelectedJobDetail()" style="min-width:460px;max-width:620px">
        <option :value="0">Select a job to run...</option>
        <template x-for="j in tailoringRecentJobs" :key="'tj-'+j.id">
          <option :value="j.id" x-text="tailoringJobOptionLabel(j)"></option>
        </template>
      </select>
      <label style="display:flex;align-items:center;gap:6px;font-size:.82rem;color:var(--text-secondary)">
        <input type="checkbox" x-model="tailoringRunConfig.skip_analysis">
        <span>Skip analysis</span>
      </label>
      <button class="btn btn-success btn-sm" :disabled="tailoringRunBusy || tailoringRunner.running || !tailoringRunConfig.selected_job_id" @click="runTailoringSelectedJob()">
        <span x-text="tailoringRunBusy ? 'Starting...' : (tailoringRunner.running ? 'Run in progress' : 'Run Selected Job')"></span>
      </button>
      <button class="btn btn-ghost btn-sm" :disabled="!tailoringRunner.log_tail" @click="copyTailoringLogs()">
        Copy Logs
      </button>
      <button class="btn btn-ghost btn-sm" @click="fetchTailoringRuns(); fetchTailoringRunnerStatus(); fetchTailoringRecentJobs()">Refresh</button>
    </div>
  </div>

  <div class="stats-bar" style="margin-bottom:10px">
    <span>
      Runner:
      <strong x-text="tailoringRunner.running ? 'running' : 'idle'"></strong>
    </span>
    <span x-show="tailoringRunner.job">
      Job:
      <strong x-text="(tailoringRunner.job?.id ?? '—') + ' · ' + (tailoringRunner.job?.title ?? '')"></strong>
    </span>
    <span x-show="tailoringRunner.started_at">
      Started:
      <strong x-text="timeAgo(tailoringRunner.started_at)"></strong>
    </span>
    <span x-show="!tailoringRunner.running && tailoringRunner.exit_code != null">
      Exit:
      <strong x-text="tailoringRunner.exit_code"></strong>
    </span>
    <span style="color:#ef4444" x-show="tailoringRunError" x-text="tailoringRunError"></span>
  </div>
  <pre x-show="tailoringRunner.log_tail" style="max-height:160px;overflow:auto;margin-bottom:10px" x-text="tailoringRunner.log_tail"></pre>

  <div class="panel" x-show="tailoringSelectedJobDetail !== null || tailoringSelectedJobDetailLoading">
    <div class="panel-header">
      <div class="panel-title">Selected job</div>
    </div>
    <div x-show="tailoringSelectedJobDetailLoading" class="loading" style="padding:16px"><div class="spinner"></div></div>
    <template x-if="tailoringSelectedJobDetail && !tailoringSelectedJobDetailLoading">
      <div class="job-detail">
        <div style="font-size:1.05rem;font-weight:600;margin-bottom:10px" x-text="tailoringSelectedJobDetail.title"></div>
        <div style="margin-bottom:8px"><strong>URL:</strong> <a :href="tailoringSelectedJobDetail.url" target="_blank" x-text="tailoringSelectedJobDetail.url"></a></div>
        <div style="margin-bottom:8px;display:flex;gap:12px;flex-wrap:wrap">
          <span x-show="tailoringSelectedJobDetail.board"><strong>Board:</strong> <span class="pill" :class="'pill-'+tailoringSelectedJobDetail.board" x-text="tailoringSelectedJobDetail.board"></span></span>
          <span x-show="tailoringSelectedJobDetail.seniority"><strong>Seniority:</strong> <span class="pill" :class="'pill-'+tailoringSelectedJobDetail.seniority" x-text="tailoringSelectedJobDetail.seniority"></span></span>
          <span x-show="tailoringSelectedJobDetail.experience_years != null"><strong>Experience:</strong> <span x-text="tailoringSelectedJobDetail.experience_years + ' years'"></span></span>
          <span x-show="tailoringSelectedJobDetail.salary_k"><strong>Salary:</strong> <span x-text="'$' + Math.round(tailoringSelectedJobDetail.salary_k/1000) + 'K'" style="color:var(--green);font-weight:600"></span></span>
          <span><strong>Run:</strong> <span x-text="tailoringSelectedJobDetail.run_id" style="color:var(--text-secondary)"></span></span>
          <span><strong>Created:</strong> <span x-text="fmtDate(tailoringSelectedJobDetail.created_at)" style="color:var(--text-secondary)"></span></span>
        </div>
        <div style="margin-bottom:8px" x-show="tailoringSelectedJobDetail.snippet"><strong>Snippet:</strong> <span x-text="tailoringSelectedJobDetail.snippet" style="color:var(--text-secondary);font-size:.9rem"></span></div>
        <div style="margin-bottom:8px" x-show="tailoringSelectedJobDetail.query"><strong>Query:</strong> <span x-text="tailoringSelectedJobDetail.query" style="color:var(--text-secondary)"></span></div>
        <div class="verdicts" x-show="tailoringSelectedJobDetail.filter_verdicts?.length">
          <div style="font-weight:600;margin-bottom:8px">Filter Verdicts</div>
          <div class="verdicts-grid">
          <template x-for="v in tailoringSelectedJobDetail.filter_verdicts">
            <div class="verdict-chip" :class="v.stage==='llm_review' ? 'llm' : (v.passed?'pass':'fail')">
              <div class="verdict-dot"
                   :class="v.stage==='llm_review' ? 'llm' : (v.passed?'pass':'fail')"
                   x-text="v.stage==='llm_review' ? '&#129504;' : (v.passed?'&#10003;':'&#10007;')">
              </div>
              <div>
                <div class="verdict-stage"
                     :style="v.stage==='llm_review' ? 'color:var(--purple)' : ''"
                     x-text="v.stage==='llm_review' ? 'AI Review' : v.stage">
                </div>
                <div class="verdict-reason" x-text="v.reason"></div>
              </div>
            </div>
          </template>
          </div>
        </div>
        <template x-if="tailoringSelectedJobDetail.jd_text">
          <div>
            <div style="font-weight:600;margin-top:16px;margin-bottom:4px">Job Description</div>
            <div class="jd-text" x-text="tailoringSelectedJobDetail.jd_text"></div>
          </div>
        </template>
      </div>
    </template>
  </div>

  <div class="panel">
    <div class="panel-header">
      <div class="panel-title">Tailoring Runs</div>
    </div>
    <div x-show="tailoringLoading" class="loading"><div class="spinner"></div></div>
    <table x-show="!tailoringLoading">
      <thead>
        <tr>
          <th>Run</th>
          <th>Status</th>
          <th>Attempts</th>
          <th>Events</th>
          <th>Updated</th>
        </tr>
      </thead>
      <tbody>
        <template x-for="run in tailoringRuns" :key="run.slug">
          <tr class="clickable-row" @click="openTailoringRun(run.slug)">
            <td>
              <div style="font-weight:600" x-text="(run.meta?.job_id ?? '—') + ' · ' + (run.meta?.title ?? run.slug)"></div>
              <div style="font-size:.8rem;color:var(--text-secondary)" x-text="run.slug"></div>
            </td>
            <td><span class="pill" :class="run.status==='complete'?'pill-success':(run.status==='failed'?'pill-fail':(run.status==='no-trace'?'pill-unknown':'pill-running'))" x-text="run.status"></span></td>
            <td style="font-size:.82rem" x-text="'resume ' + (run.attempts?.resume ?? 0) + ' / cover ' + (run.attempts?.cover ?? 0)"></td>
            <td x-text="run.event_count ?? 0"></td>
            <td x-text="timeAgo(run.updated_at)"></td>
          </tr>
        </template>
      </tbody>
    </table>
    <template x-if="!tailoringLoading && tailoringRuns.length === 0">
      <div class="empty"><div class="empty-icon">&#128196;</div><div class="empty-text">No tailoring output runs found</div></div>
    </template>
  </div>

  <template x-if="tailoringDetail">
    <div>
      <div class="panel">
        <div class="panel-header">
          <div class="panel-title">Run Detail</div>
          <div style="display:flex;gap:8px;flex-wrap:wrap">
            <button class="btn btn-success btn-sm" @click="openPackageFromTailoring()">Open Package Review</button>
            <a class="btn btn-ghost btn-sm" :href="'/api/tailoring/runs/' + encodeURIComponent(tailoringSelectedSlug) + '/artifact/meta.json'" target="_blank">meta.json</a>
            <a class="btn btn-ghost btn-sm" :href="'/api/tailoring/runs/' + encodeURIComponent(tailoringSelectedSlug) + '/artifact/analysis.json'" target="_blank">analysis.json</a>
            <a class="btn btn-ghost btn-sm" :href="'/api/tailoring/runs/' + encodeURIComponent(tailoringSelectedSlug) + '/artifact/resume_strategy.json'" target="_blank">resume strategy</a>
            <a class="btn btn-ghost btn-sm" :href="'/api/tailoring/runs/' + encodeURIComponent(tailoringSelectedSlug) + '/artifact/cover_strategy.json'" target="_blank">cover strategy</a>
            <a class="btn btn-primary btn-sm" :href="'/api/tailoring/runs/' + encodeURIComponent(tailoringSelectedSlug) + '/artifact/llm_trace.jsonl'" target="_blank">download trace</a>
          </div>
        </div>
        <div class="stats-bar">
          <span><strong x-text="tailoringDetail.meta?.job_id ?? '—'"></strong> job id</span>
          <span><strong x-text="tailoringDetail.doc_status?.resume ?? 'pending'"></strong> resume</span>
          <span><strong x-text="tailoringDetail.doc_status?.cover ?? 'pending'"></strong> cover</span>
          <span><strong x-text="tailoringTrace.length"></strong> trace events</span>
        </div>
        <div class="filters">
          <select x-model="tailoringFilter.doc_type" @change="fetchTailoringTrace()">
            <option value="">All docs</option>
            <option value="analysis">analysis</option>
            <option value="resume">resume</option>
            <option value="cover">cover</option>
          </select>
          <select x-model="tailoringFilter.phase" @change="fetchTailoringTrace()">
            <option value="">All phases</option>
            <option value="analysis">analysis</option>
            <option value="strategy">strategy</option>
            <option value="draft">draft</option>
            <option value="qa">qa</option>
          </select>
          <input type="number" placeholder="Attempt" min="0" x-model="tailoringFilter.attempt" @change="fetchTailoringTrace()">
        </div>
      </div>

      <div class="trace-grid">
        <div class="trace-list">
          <template x-for="(ev, idx) in tailoringTrace" :key="'tev-'+idx">
            <div class="trace-item" :class="{active: tailoringSelectedEventIdx===idx}" @click="selectTailoringEvent(idx)">
              <div class="trace-title" x-text="ev.event_type"></div>
              <div class="trace-meta" x-text="(ev.doc_type || '—') + ' · ' + (ev.phase || '—') + ' · attempt ' + (ev.attempt ?? '—')"></div>
              <div class="trace-meta" x-text="timeAgo(ev.timestamp || ev.ended_at || ev.started_at)"></div>
            </div>
          </template>
        </div>
        <div class="trace-pane">
          <div class="trace-tabs">
            <button class="btn btn-ghost btn-sm" @click="traceTab='system'" :class="traceTab==='system' ? 'btn-primary' : ''">System Prompt</button>
            <button class="btn btn-ghost btn-sm" @click="traceTab='user'" :class="traceTab==='user' ? 'btn-primary' : ''">User Prompt</button>
            <button class="btn btn-ghost btn-sm" @click="traceTab='response'" :class="traceTab==='response' ? 'btn-primary' : ''">Raw Response</button>
            <button class="btn btn-ghost btn-sm" @click="traceTab='meta'" :class="traceTab==='meta' ? 'btn-primary' : ''">Metadata</button>
            <button class="btn btn-success btn-sm" @click="copyTracePane()">Copy</button>
          </div>
          <div class="trace-content">
            <pre x-show="traceTab==='system'" x-text="tailoringSelectedEvent?.system_prompt || ''"></pre>
            <pre x-show="traceTab==='user'" x-text="tailoringSelectedEvent?.user_prompt || ''"></pre>
            <pre x-show="traceTab==='response'" x-text="tailoringSelectedEvent?.raw_response || tailoringSelectedEvent?.error || ''"></pre>
            <pre x-show="traceTab==='meta'" x-text="formatCellFull(tailoringSelectedEvent || {})"></pre>
          </div>
        </div>
      </div>
    </div>
  </template>
</div>

<!-- ══════════════════════════════════════════════════════════════
     VIEW: APPLICATION PACKAGES
     ══════════════════════════════════════════════════════════════ -->
<div x-show="view==='packages'" x-transition.opacity>
  <div class="page-header">
    <div class="page-title">Completed Application Packages</div>
    <div style="display:flex;gap:8px">
      <button class="btn btn-ghost btn-sm" @click="fetchPackages()">Refresh</button>
      <button class="btn btn-success btn-sm" x-show="packageSelectedSlug" @click="openTailoringFromPackage()">Open Process View</button>
    </div>
  </div>

  <div class="pkg-grid">
    <div class="pkg-list">
      <template x-for="pkg in packages" :key="pkg.slug">
        <div class="pkg-item" :class="{active: packageSelectedSlug===pkg.slug}" @click="openPackage(pkg.slug)">
          <div style="font-weight:600" x-text="(pkg.meta?.job_id ?? '—') + ' · ' + (pkg.meta?.title ?? pkg.slug)"></div>
          <div style="font-size:.8rem;color:var(--text-secondary)" x-text="pkg.slug"></div>
          <div style="margin-top:6px;display:flex;gap:6px;flex-wrap:wrap">
            <span class="pill" :class="pkg.status==='complete'?'pill-success':(pkg.status==='failed'?'pill-fail':'pill-running')" x-text="pkg.status"></span>
            <span class="pill pill-unknown" x-text="'events ' + (pkg.event_count ?? 0)"></span>
          </div>
        </div>
      </template>
      <template x-if="packages.length===0">
        <div class="empty"><div class="empty-icon">&#128196;</div><div class="empty-text">No completed packages yet</div></div>
      </template>
    </div>

    <div class="pkg-main" x-show="packageDetail">
      <div class="panel">
        <div class="panel-header">
          <div class="panel-title">Package Context</div>
          <div style="display:flex;gap:8px;flex-wrap:wrap">
            <button class="btn btn-ghost btn-sm" @click="setPackageAuxDoc('analysis')">analysis.json</button>
            <button class="btn btn-ghost btn-sm" @click="setPackageAuxDoc('resume_strategy')">resume strategy</button>
            <button class="btn btn-ghost btn-sm" @click="setPackageAuxDoc('cover_strategy')">cover strategy</button>
            <button class="btn btn-primary btn-sm" @click="setPackageAuxDoc('trace')">trace</button>
            <a class="btn btn-ghost btn-sm" :href="packageAuxDownloadUrl()" target="_blank">Download Raw</a>
          </div>
        </div>
        <div class="stats-bar">
          <span><strong x-text="packageDetail.summary?.meta?.job_id ?? '—'"></strong> job id</span>
          <span><strong x-text="packageDetail.summary?.doc_status?.resume ?? '—'"></strong> resume</span>
          <span><strong x-text="packageDetail.summary?.doc_status?.cover ?? '—'"></strong> cover</span>
          <span x-text="packageSaveStatus || 'ready'"></span>
        </div>
      </div>

      <div class="editor-grid">
        <div class="doc-box">
          <div class="doc-box-header" style="display:flex;justify-content:space-between;align-items:center">
            <div>Live LaTeX Editor</div>
            <div style="display:flex;gap:8px">
              <select x-model="packageDoc">
                <option value="resume">Resume</option>
                <option value="cover">Cover Letter</option>
              </select>
              <button class="btn btn-primary btn-sm" @click="compilePackageDoc()">Compile</button>
            </div>
          </div>
          <div class="doc-box-body">
            <textarea class="latex-editor" x-show="packageDoc==='resume'" x-model="packageResumeTex" @input="onPackageLatexInput('resume')"></textarea>
            <textarea class="latex-editor" x-show="packageDoc==='cover'" x-model="packageCoverTex" @input="onPackageLatexInput('cover')"></textarea>
            <div style="font-size:.8rem;color:var(--red);margin-top:8px" x-show="packageCompileError" x-text="packageCompileError"></div>
          </div>
        </div>

        <div class="doc-box">
          <div class="doc-box-header">Live PDF Preview</div>
          <div class="doc-box-body" style="height:620px;max-height:none;padding:0">
            <iframe :src="packagePdfUrl()" style="width:100%;height:620px;border:0"></iframe>
          </div>
        </div>
      </div>

      <div class="panel" style="margin-top:16px">
        <div class="panel-header">
          <div class="panel-title">Generated Content Highlight (vs Baseline)</div>
          <button class="btn btn-ghost btn-sm" @click="refreshPackageDiffPreview()">Refresh Highlighted PDF</button>
        </div>
        <div class="stats-bar">
          <span>This diff preview highlights generated edits versus the baseline template.</span>
        </div>
        <div class="doc-box-body" style="height:760px;max-height:none;padding:0">
          <iframe
            :src="packageDiffPdfUrl()"
            style="width:100%;height:760px;border:0"
            @error="packageDiffError='Failed to load highlighted diff preview.'"
          ></iframe>
        </div>
        <div style="font-size:.8rem;color:var(--red);margin-top:8px" x-show="packageDiffError" x-text="packageDiffError"></div>
      </div>

      <div class="editor-grid">
        <div class="doc-box">
          <div class="doc-box-header">Full Job Description</div>
          <div class="doc-box-body"><pre x-text="packageDetail.job_context?.jd_text || packageDetail.job_context?.snippet || 'No JD available'"></pre></div>
        </div>
        <div class="doc-box">
          <div class="doc-box-header" x-text="packageAuxTitle()"></div>
          <div class="doc-box-body"><pre x-text="packageAuxContent"></pre></div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- ══════════════════════════════════════════════════════════════
     VIEW: DEDUP & GROWTH
     ══════════════════════════════════════════════════════════════ -->
<div x-show="view==='dedup'" x-transition.opacity>
  <div class="page-header">
    <div class="page-title">Dedup & Growth</div>
  </div>

  <!-- Dedup funnel -->
  <div class="chart-container">
    <div class="chart-title">Dedup Funnel</div>
    <div class="funnel" x-show="dedupData">
      <div class="funnel-step">
        <div class="funnel-label">URLs Seen</div>
        <div class="funnel-bar" style="background:var(--purple)" :style="'width:100%'" x-text="fmt(dedupData?.total_seen)"></div>
      </div>
      <div class="funnel-arrow">&#8595;</div>
      <div class="funnel-step">
        <div class="funnel-label">Passed Filters</div>
        <div class="funnel-bar" style="background:var(--accent)" :style="'width:' + (dedupData ? Math.max(5, dedupData.total_results / dedupData.total_seen * 100) : 5) + '%'" x-text="fmt(dedupData?.total_results)"></div>
      </div>
    </div>
  </div>

  <!-- Repeat URL frequency -->
  <div class="chart-row">
    <div class="chart-container">
      <div class="chart-title">URL Frequency Distribution</div>
      <canvas id="repeatChart"></canvas>
    </div>
    <div class="chart-container">
      <div class="chart-title">Daily Uniqueness Rate</div>
      <canvas id="uniquenessChart"></canvas>
    </div>
  </div>

  <!-- Daily new URLs chart -->
  <div class="chart-container">
    <div class="chart-title">Daily New Jobs Stored</div>
    <canvas id="dailyNewChart" style="max-height:260px"></canvas>
  </div>

  <!-- Filter analytics (moved from old Filters view) -->
  <div class="cards" style="margin-bottom:24px">
    <div class="card">
      <div class="card-label">Avg Pass Rate</div>
      <div class="card-value" x-text="passRate"></div>
      <div class="card-sub">filtered / dedup across runs</div>
    </div>
    <div class="card">
      <div class="card-label">Total Passing Jobs</div>
      <div class="card-value" x-text="fmt(ov.total_results)"></div>
    </div>
  </div>

  <div class="chart-container">
    <div class="chart-title">Top Matching Keywords (Passing Jobs)</div>
    <canvas id="filterChart"></canvas>
  </div>

  <div class="panel" style="margin-top:24px">
    <div class="panel-header"><div class="panel-title">Verdict Breakdown by Stage</div></div>
    <template x-for="stage in filterStages" :key="stage.stage">
      <div style="padding:12px 20px;border-bottom:1px solid var(--border)">
        <div style="font-weight:600;margin-bottom:6px" x-text="stage.stage"></div>
        <template x-for="r in stage.reasons.slice(0,5)" :key="r.reason">
          <div style="display:flex;align-items:center;gap:8px;padding:2px 0;font-size:.85rem">
            <div style="min-width:32px;text-align:right;font-weight:600;color:var(--accent)" x-text="r.count"></div>
            <div style="flex:1;color:var(--text-secondary)" x-text="r.reason"></div>
            <div style="width:120px;height:6px;background:var(--border);border-radius:3px;overflow:hidden">
              <div style="height:100%;border-radius:3px;background:var(--accent)" :style="'width:'+Math.round(r.count/stage.total*100)+'%'"></div>
            </div>
          </div>
        </template>
      </div>
    </template>
  </div>
</div>

<!-- ══════════════════════════════════════════════════════════════
     VIEW: SCHEDULES
     ══════════════════════════════════════════════════════════════ -->
<div x-show="view==='schedules'" x-transition.opacity>
  <div class="page-header">
    <div class="page-title">Scheduled Jobs</div>
    <button class="btn btn-ghost btn-sm" @click="fetchSchedules()">Refresh</button>
  </div>

  <div class="cards" style="margin-bottom:24px">
    <div class="card">
      <div class="card-icon green"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M22 11.08V12a10 10 0 11-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></svg></div>
      <div class="card-label">Loaded</div>
      <div class="card-value" x-text="schedJobs.filter(j => j.loaded).length"></div>
    </div>
    <div class="card">
      <div class="card-icon red"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><line x1="15" y1="9" x2="9" y2="15"/><line x1="9" y1="9" x2="15" y2="15"/></svg></div>
      <div class="card-label">Not Loaded</div>
      <div class="card-value" x-text="schedJobs.filter(j => !j.loaded).length"></div>
    </div>
    <div class="card">
      <div class="card-icon blue"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 2v4M12 18v4M4.93 4.93l2.83 2.83M16.24 16.24l2.83 2.83M2 12h4M18 12h4M4.93 19.07l2.83-2.83M16.24 7.76l2.83-2.83"/></svg></div>
      <div class="card-label">Running Now</div>
      <div class="card-value" x-text="schedJobs.filter(j => j.running).length"></div>
    </div>
    <div class="card">
      <div class="card-icon amber"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M10.29 3.86L1.82 18a2 2 0 001.71 3h16.94a2 2 0 001.71-3L13.71 3.86a2 2 0 00-3.42 0z"/><line x1="12" y1="9" x2="12" y2="13"/><line x1="12" y1="17" x2="12.01" y2="17"/></svg></div>
      <div class="card-label">Last Exit != 0</div>
      <div class="card-value" x-text="schedJobs.filter(j => j.loaded && j.last_exit !== 0 && j.last_exit !== null).length"></div>
    </div>
  </div>

  <div x-show="schedLoading" class="loading"><div class="spinner"></div></div>

  <template x-if="!schedLoading && schedJobs.length === 0">
    <div class="empty"><div class="empty-icon">&#128197;</div><div class="empty-text">No launchd agents found</div></div>
  </template>

  <template x-for="job in schedJobs" :key="job.label">
    <div class="sched-card" :class="job.running ? 'running-now' : (job.loaded ? 'loaded' : 'not-loaded')">
      <div class="sched-header" @click="toggleSchedExpand(job.label)">
        <div>
          <div class="sched-label" x-text="job.label"></div>
          <div style="font-size:.8rem;color:var(--text-secondary);margin-top:2px" x-text="job.schedule || 'No schedule'"></div>
        </div>
        <div class="sched-meta">
          <span class="pill" :class="job.running ? 'pill-running' : (job.loaded ? 'pill-success' : 'pill-fail')"
                x-text="job.running ? 'Running' : (job.loaded ? 'Loaded' : 'Not Loaded')"></span>
          <template x-if="job.last_exit !== null && job.last_exit !== undefined">
            <span class="pill" :class="job.last_exit === 0 ? 'pill-success' : 'pill-fail'" x-text="'Exit: ' + job.last_exit"></span>
          </template>
          <span style="font-size:.8rem" x-text="schedExpandedId === job.label ? '&#9660;' : '&#9654;'"></span>
        </div>
      </div>

      <template x-if="schedExpandedId === job.label">
        <div class="sched-detail">
          <div class="sched-field">
            <div class="sched-field-label">Command</div>
            <div class="sched-field-value" x-text="job.command"></div>
          </div>
          <div class="sched-field">
            <div class="sched-field-label">Working Dir</div>
            <div class="sched-field-value" x-text="job.working_dir || '—'"></div>
          </div>
          <div class="sched-field">
            <div class="sched-field-label">Schedule</div>
            <div class="sched-field-value" x-text="(job.schedule || 'None') + (job.interval_seconds ? ' (' + job.interval_seconds + 's)' : '')"></div>
          </div>
          <div class="sched-field">
            <div class="sched-field-label">Run at Load</div>
            <div class="sched-field-value" x-text="job.run_at_load ? 'Yes' : 'No'"></div>
          </div>
          <div class="sched-field">
            <div class="sched-field-label">PID</div>
            <div class="sched-field-value" x-text="job.pid ?? '—'"></div>
          </div>
          <div class="sched-field">
            <div class="sched-field-label">Last Exit</div>
            <div class="sched-field-value">
              <span :style="job.last_exit !== 0 && job.last_exit !== null ? 'color:var(--red);font-weight:600' : ''" x-text="job.last_exit ?? '—'"></span>
            </div>
          </div>
          <div class="sched-field">
            <div class="sched-field-label">Log File</div>
            <div class="sched-field-value" x-text="job.log_path || 'None'"></div>
          </div>
          <div class="sched-field" x-show="job.log_size > 0">
            <div class="sched-field-label">Log Size</div>
            <div class="sched-field-value" x-text="fmtBytes(job.log_size)"></div>
          </div>
          <div class="sched-field">
            <div class="sched-field-label">Plist Path</div>
            <div class="sched-field-value" x-text="job.plist_path"></div>
          </div>

          <!-- Log viewer -->
          <template x-if="job.log_path">
            <div>
              <div class="log-controls">
                <button class="btn btn-sm btn-primary" @click="fetchSchedLog(job.label)"
                  x-text="schedLogData[job.label] ? 'Refresh Log' : 'View Log'"></button>
                <select x-model="schedLogLines" @change="if(schedLogData[job.label]) fetchSchedLog(job.label)"
                  style="padding:4px 8px;border:1px solid var(--border);border-radius:6px;font-size:.8rem">
                  <option value="50">50 lines</option>
                  <option value="100">100 lines</option>
                  <option value="300">300 lines</option>
                  <option value="500">500 lines</option>
                </select>
                <span style="font-size:.8rem;color:var(--text-secondary)" x-show="schedLogData[job.label]"
                  x-text="schedLogData[job.label] ? 'Showing last ' + schedLogData[job.label].lines.length + ' of ' + schedLogData[job.label].total_lines + ' lines' : ''">
                </span>
              </div>
              <template x-if="schedLogData[job.label]">
                <div class="log-viewer" x-ref="logViewer">
                  <template x-for="(line, li) in schedLogData[job.label].lines" :key="li">
                    <div class="log-line" x-text="line"></div>
                  </template>
                </div>
              </template>
            </div>
          </template>
        </div>
      </template>
    </div>
  </template>
</div>

<!-- ══════════════════════════════════════════════════════════════
     VIEW: DB EXPLORER
     ══════════════════════════════════════════════════════════════ -->
<div x-show="view==='explorer'" x-transition.opacity>
  <div class="page-header">
    <div class="page-title">DB Explorer</div>
    <button class="btn btn-ghost btn-sm" @click="copyExplorerJSON()" x-show="explorerData.items.length > 0">Copy as JSON</button>
  </div>

  <div class="panel">
    <div class="filters">
      <select x-model="explorerTable" @change="explorerPage=1;fetchExplorerData()">
        <template x-for="t in dbTables" :key="t.name">
          <option :value="t.name" x-text="t.name + ' (' + t.row_count + ' rows)'"></option>
        </template>
      </select>
      <select x-model="explorerPerPage" @change="explorerPage=1;fetchExplorerData()">
        <option value="50">50 rows</option>
        <option value="100">100 rows</option>
        <option value="200">200 rows</option>
      </select>
    </div>

    <div x-show="explorerLoading" class="loading"><div class="spinner"></div></div>

    <div style="overflow-x:auto" x-show="!explorerLoading && explorerData.items.length > 0">
      <table>
        <thead>
          <tr>
            <template x-for="col in explorerData.columns" :key="col">
              <th @click="toggleExplorerSort(col)" :class="{sorted: explorerSort.by===col}">
                <span x-text="col"></span>
                <span class="sort-arrow" x-text="explorerSort.by===col?(explorerSort.dir==='asc'?'&#9650;':'&#9660;'):'&#9660;'"></span>
              </th>
            </template>
          </tr>
          <!-- Column filters -->
          <tr style="background:#fafbfc">
            <template x-for="col in explorerData.columns" :key="'f-'+col">
              <th style="padding:4px 8px">
                <input class="col-filter" type="text" placeholder="Filter..."
                  x-model.debounce.300ms="explorerColFilters[col]"
                  @input="filterExplorerLocal()">
              </th>
            </template>
          </tr>
        </thead>
        <tbody>
          <template x-for="(row, idx) in explorerFiltered" :key="idx">
            <tr class="clickable-row" @click="openRowModal(row)">
              <template x-for="col in explorerData.columns" :key="col+'-'+idx">
                <td>
                  <div class="cell-truncate" x-text="formatCell(row[col])"></div>
                </td>
              </template>
            </tr>
          </template>
        </tbody>
      </table>
    </div>

    <template x-if="!explorerLoading && explorerData.items.length === 0">
      <div class="empty"><div class="empty-icon">&#128451;</div><div class="empty-text">No data in this table</div></div>
    </template>

    <div class="pagination" x-show="explorerData.pages > 1">
      <div class="pagination-info" x-text="'Page ' + explorerPage + ' of ' + explorerData.pages + ' (' + explorerData.total + ' rows)'"></div>
      <div class="pagination-controls">
        <button :disabled="explorerPage<=1" @click="explorerPage--;fetchExplorerData()">Prev</button>
        <span class="page-num" x-text="explorerPage + ' / ' + explorerData.pages"></span>
        <button :disabled="explorerPage>=explorerData.pages" @click="explorerPage++;fetchExplorerData()">Next</button>
      </div>
    </div>
  </div>

  <!-- Row detail modal -->
  <template x-if="rowModalData">
    <div class="modal-overlay" @click.self="rowModalData=null">
      <div class="modal">
        <div class="modal-header">
          <div class="panel-title">Row Detail</div>
          <button class="btn btn-ghost btn-sm" @click="rowModalData=null">Close</button>
        </div>
        <div class="modal-body">
          <template x-for="col in explorerData.columns" :key="'m-'+col">
            <div class="modal-field">
              <div class="modal-field-label" x-text="col"></div>
              <div class="modal-field-value" x-text="formatCellFull(rowModalData[col])"></div>
            </div>
          </template>
        </div>
      </div>
    </div>
  </template>
</div>

<!-- ══════════════════════════════════════════════════════════════
     VIEW: SQL CONSOLE
     ══════════════════════════════════════════════════════════════ -->
<div x-show="view==='sql'" x-transition.opacity>
  <div class="page-header">
    <div class="page-title">SQL Console</div>
    <div style="font-size:.8rem;color:var(--text-secondary)">Read-only &middot; SELECT only &middot; LIMIT 1000</div>
  </div>

  <!-- Preset queries -->
  <div class="preset-queries">
    <button class="preset-btn" @click="runSQLPreset(`SELECT * FROM runs ORDER BY started_at DESC LIMIT 10`)">Recent runs</button>
    <button class="preset-btn" @click="runSQLPreset(`SELECT * FROM results WHERE jd_text IS NULL OR jd_text = '' LIMIT 20`)">Jobs with no JD</button>
    <button class="preset-btn" @click="runSQLPreset(`SELECT * FROM runs WHERE errors != '[]' AND errors IS NOT NULL ORDER BY started_at DESC LIMIT 10`)">Runs with errors</button>
    <button class="preset-btn" @click="runSQLPreset(`SELECT SUBSTR(url, 1, INSTR(SUBSTR(url, 9), '/') + 8) as domain, COUNT(*) as cnt FROM results GROUP BY domain ORDER BY cnt DESC LIMIT 20`)">Top domains</button>
    <button class="preset-btn" @click="runSQLPreset(`SELECT board, seniority, COUNT(*) as cnt FROM results GROUP BY board, seniority ORDER BY cnt DESC`)">Board x Seniority</button>
    <button class="preset-btn" @click="runSQLPreset(`SELECT date(created_at) as day, COUNT(*) as cnt FROM results GROUP BY day ORDER BY day DESC LIMIT 30`)">Daily counts</button>
    <button class="preset-btn" @click="runSQLPreset(`SELECT title, salary_k, seniority, board FROM results WHERE salary_k IS NOT NULL ORDER BY salary_k DESC LIMIT 25`)">Salary data</button>
  </div>

  <div class="panel">
    <div style="padding:16px 20px">
      <textarea class="sql-editor" x-model="sqlText" @keydown.meta.enter.prevent="runSQL()" @keydown.ctrl.enter.prevent="runSQL()" placeholder="Enter a SELECT query... (Cmd+Enter to run)"></textarea>
      <div style="display:flex;align-items:center;gap:12px;margin-top:8px">
        <button class="btn btn-primary" @click="runSQL()" :disabled="sqlRunning">
          <span x-show="!sqlRunning">Run Query</span>
          <span x-show="sqlRunning">Running...</span>
        </button>
        <div class="query-meta" x-show="sqlResult">
          <span x-text="sqlResult ? sqlResult.row_count + ' rows' : ''"></span>
          <span x-text="sqlResult ? ' in ' + sqlResult.elapsed_ms + 'ms' : ''"></span>
        </div>
        <div style="font-size:.85rem;color:var(--red)" x-show="sqlError" x-text="sqlError"></div>
      </div>
    </div>

    <!-- Query history -->
    <template x-if="sqlHistory.length > 0">
      <div style="border-top:1px solid var(--border)">
        <div style="padding:8px 20px;font-size:.8rem;font-weight:600;color:var(--text-secondary)">Recent Queries</div>
        <template x-for="(q, qi) in sqlHistory" :key="qi">
          <div class="query-history-item" @click="sqlText=q;runSQL()" x-text="q"></div>
        </template>
      </div>
    </template>
  </div>

  <!-- Results -->
  <div class="panel" x-show="sqlResult && sqlResult.rows.length > 0">
    <div style="overflow-x:auto">
      <table>
        <thead>
          <tr>
            <template x-for="col in sqlResult?.columns || []" :key="'sc-'+col">
              <th x-text="col"></th>
            </template>
          </tr>
        </thead>
        <tbody>
          <template x-for="(row, ri) in sqlResult?.rows || []" :key="'sr-'+ri">
            <tr>
              <template x-for="col in sqlResult?.columns || []" :key="'src-'+col+'-'+ri">
                <td><div class="cell-truncate" x-text="formatCell(row[col])"></div></td>
              </template>
            </tr>
          </template>
        </tbody>
      </table>
    </div>
  </div>
</div>

</div><!-- /.main -->

<script>
function dashboard() {
  return {
    view: 'overview',
    lastFetch: null,
    isActive: false,
    dbSizeLabel: '',
    llmStatus: null,
    runtimeControls: {scrape_enabled: true, llm_enabled: true, updated_at: null},
    controlsBusy: false,
    scrapeRunner: {running: false, log_tail: '', exit_code: null, started_at: null},
    scrapeRunBusy: false,
    scrapeRunError: '',

    // Overview
    ov: {},
    trendChart: null, boardChart: null, seniorityChart: null, growthChart: null,

    // Jobs
    jobs: {items:[],total:0,page:1,pages:0,latest_run_id:null},
    jf: {board:'',seniority:'',search:'',url_search:'',run_id:'',date_from:'',date_to:''},
    jSort: {by:'created_at',dir:'desc'},
    jPage: 1, jPerPage: 25,
    expandedId: null, expandedDetail: null,
    jobsLoading: false,
    boards: ['greenhouse','lever','ashby','workday','bamboohr','icims','smartrecruiters','unknown'],
    seniorities: ['junior','mid','senior','staff','principal','lead','manager','director','unknown'],
    runIds: [],

    // Rejected
    rejected: {items:[],total:0,pages:0},
    rejectedStats: null,
    rejectedStages: [],
    rf: {stage:'', run_id:'', search:''},
    rPage: 1, rPerPage: 50,
    rejectedLoading: false,
    expandedRejectedId: null, expandedRejectedDetail: null,
    approvingRejectedIds: {},

    // Runs
    runs: [], runsLoading: false,
    runStats: null, runPage: 1, runPages: 1,
    expandedRunId: null, expandedRunJobs: null,
    runTimelineChart: null,

    // Tailoring
    tailoringRuns: [], tailoringLoading: false,
    tailoringSelectedSlug: '',
    tailoringDetail: null,
    tailoringTrace: [],
    tailoringRecentJobs: [],
    tailoringRunner: {running: false, log_tail: ''},
    tailoringRunConfig: {selected_job_id: 0, skip_analysis: false},
    tailoringRunBusy: false,
    tailoringRunError: '',
    tailoringFilter: {doc_type:'', phase:'', attempt:''},
    tailoringSelectedEventIdx: -1,
    traceTab: 'meta',
    tailoringSelectedJobDetail: null,
    tailoringSelectedJobDetailLoading: false,

    // Application packages
    packages: [], packagesLoading: false,
    packageSelectedSlug: '',
    packageDetail: null,
    packageDoc: 'resume',
    packageResumeTex: '',
    packageCoverTex: '',
    packageSaveStatus: '',
    packageCompileError: '',
    packagePreviewBuster: {resume: Date.now(), cover: Date.now()},
    packageDiffBuster: {resume: Date.now(), cover: Date.now()},
    packageDiffError: '',
    packageSaveTimers: {resume: null, cover: null},
    packageAuxDoc: 'analysis',
    packageAuxContent: '',

    // Dedup & Growth
    dedupData: null, dedupLoaded: false,
    repeatChart: null, uniquenessChart: null, dailyNewChart: null,

    // Filters (moved to dedup view)
    filterStages: [], filterChart: null, passRate: '—',

    // DB Explorer
    dbTables: [], explorerTable: '',
    explorerData: {items:[],columns:[],total:0,page:1,pages:0},
    explorerPage: 1, explorerPerPage: 50,
    explorerSort: {by:null,dir:'asc'},
    explorerLoading: false,
    explorerColFilters: {},
    explorerFiltered: [],
    rowModalData: null,

    // Schedules
    schedJobs: [], schedLoading: false,
    schedExpandedId: null, schedLogData: {}, schedLogLines: '100',

    // SQL Console
    sqlText: '', sqlResult: null, sqlError: '', sqlRunning: false,
    sqlHistory: JSON.parse(localStorage.getItem('sqlHistory') || '[]'),

    init() {
      this.fetchOverview();
      this.fetchActiveRun();
      this.fetchRunIds();
      this.fetchLLMStatus();
      this.fetchRuntimeControls();
      this.fetchScrapeRunnerStatus();
      setInterval(() => {
        if (this.view === 'overview') this.fetchOverview();
        if (this.view === 'jobs') this.fetchJobs();
        if (this.view === 'runs') this.fetchRuns();
        if (this.view === 'tailoring') { this.fetchTailoringRuns(); this.fetchTailoringRunnerStatus(); this.fetchTailoringRecentJobs(); }
        if (this.view === 'packages') this.fetchPackages();
        if (this.view === 'dedup') { this.fetchDedupStats(); this.fetchFilterStats(); }
      }, 30000);
      setInterval(() => this.fetchActiveRun(), 10000);
      setInterval(() => this.fetchLLMStatus(), 60000);
      setInterval(() => this.fetchRuntimeControls(), 30000);
      setInterval(() => this.fetchScrapeRunnerStatus(), 10000);
    },

    go(v) {
      this.view = v;
      if (v === 'overview') this.fetchOverview();
      if (v === 'jobs' && this.jobs.items.length === 0) this.fetchJobs();
      if (v === 'rejected' && !this.rejectedStats) { this.fetchRejectedStats(); this.fetchRejected(); }
      if (v === 'runs') {
        if (this.runs.length === 0) this.fetchRuns();
        this.fetchScrapeRunnerStatus();
        this.fetchRuntimeControls();
      }
      if (v === 'tailoring') {
        if (this.tailoringRuns.length === 0) this.fetchTailoringRuns();
        this.fetchTailoringRunnerStatus();
        this.fetchTailoringRecentJobs();
        if (this.tailoringRunConfig.selected_job_id) this.fetchTailoringSelectedJobDetail();
      }
      if (v === 'packages' && this.packages.length === 0) this.fetchPackages();
      if (v === 'dedup' && !this.dedupLoaded) { this.fetchDedupStats(); this.fetchFilterStats(); }
      if (v === 'schedules' && this.schedJobs.length === 0) this.fetchSchedules();
      if (v === 'explorer' && this.dbTables.length === 0) this.fetchDBTables();
    },

    // ── Overview ────────────────────────────────────────────
    async fetchOverview() {
      try {
        const [ovRes, growthRes] = await Promise.all([
          fetch('/api/overview'),
          fetch('/api/growth'),
        ]);
        this.ov = await ovRes.json();
        this._growthData = await growthRes.json();
        this.lastFetch = new Date().toISOString();
        this.dbSizeLabel = this.fmtBytes(this.ov.db_size);
        this.$nextTick(() => {
          this.renderGrowthChart();
          this.renderTrendChart();
          this.renderBoardChart();
          this.renderSeniorityChart();
        });
      } catch(e) { console.error('overview', e); }
    },

    // ── Jobs ────────────────────────────────────────────────
    async fetchJobs() {
      this.jobsLoading = true;
      const p = new URLSearchParams({page:this.jPage,per_page:this.jPerPage,sort_by:this.jSort.by,sort_dir:this.jSort.dir});
      if (this.jf.board) p.set('board', this.jf.board);
      if (this.jf.seniority) p.set('seniority', this.jf.seniority);
      if (this.jf.search) p.set('search', this.jf.search);
      if (this.jf.url_search) p.set('url_search', this.jf.url_search);
      if (this.jf.run_id) p.set('run_id', this.jf.run_id);
      if (this.jf.date_from) p.set('date_from', this.jf.date_from);
      if (this.jf.date_to) p.set('date_to', this.jf.date_to);
      try {
        const r = await fetch('/api/jobs?' + p);
        this.jobs = await r.json();
      } catch(e) { console.error('jobs', e); }
      this.jobsLoading = false;
    },

    async fetchRunIds() {
      try {
        const r = await fetch('/api/runs?per_page=100');
        const data = await r.json();
        this.runIds = (data.runs || []).map(r => r.run_id);
      } catch(e) {}
    },

    get jobStatsBar() {
      if (!this.jobs.items.length) return '';
      const bs = new Set(this.jobs.items.map(j => j.board));
      const ss = new Set(this.jobs.items.map(j => j.seniority));
      return bs.size + ' boards, ' + ss.size + ' seniority levels in view';
    },

    async toggleJob(id) {
      if (this.expandedId === id) { this.expandedId = null; this.expandedDetail = null; return; }
      this.expandedId = id;
      this.expandedDetail = null;
      try {
        const r = await fetch('/api/jobs/' + id);
        this.expandedDetail = await r.json();
      } catch(e) { console.error('job detail', e); }
    },

    toggleSort(col) {
      if (this.jSort.by === col) this.jSort.dir = this.jSort.dir === 'asc' ? 'desc' : 'asc';
      else { this.jSort.by = col; this.jSort.dir = 'desc'; }
      this.jPage = 1; this.fetchJobs();
    },

    clearJobFilters() {
      this.jf = {board:'',seniority:'',search:'',url_search:'',run_id:'',date_from:'',date_to:''};
      this.jPage = 1; this.fetchJobs();
    },

    // ── Runs ────────────────────────────────────────────────
    async fetchRuns() {
      this.runsLoading = true;
      try {
        const r = await fetch('/api/runs?page=' + this.runPage + '&per_page=50');
        const data = await r.json();
        this.runs = data.runs || [];
        this.runStats = data.stats || null;
        this.runPages = data.pages || 1;
        this.$nextTick(() => this.renderRunTimeline());
      } catch(e) { console.error('runs', e); }
      this.runsLoading = false;
    },

    async toggleRunExpand(runId) {
      if (this.expandedRunId === runId) {
        this.expandedRunId = null;
        this.expandedRunJobs = null;
        return;
      }
      this.expandedRunId = runId;
      this.expandedRunJobs = null;
      try {
        const r = await fetch('/api/runs/' + encodeURIComponent(runId));
        const data = await r.json();
        this.expandedRunJobs = data.jobs || [];
      } catch(e) { console.error('run detail', e); this.expandedRunJobs = []; }
    },

    async fetchActiveRun() {
      try {
        const r = await fetch('/api/runs/active');
        const data = await r.json();
        this.isActive = data.active;
        if (typeof data.enabled === 'boolean') {
          this.runtimeControls.scrape_enabled = data.enabled;
        }
      } catch(e) { this.isActive = false; }
    },

    async fetchRuntimeControls() {
      try {
        const r = await fetch('/api/runtime-controls');
        const data = await r.json();
        this.runtimeControls = {
          scrape_enabled: !!data.scrape_enabled,
          llm_enabled: !!data.llm_enabled,
          updated_at: data.updated_at || null,
        };
      } catch (e) {
        console.error('runtime controls', e);
      }
    },

    async updateRuntimeControls(payload) {
      this.controlsBusy = true;
      try {
        const r = await fetch('/api/runtime-controls', {
          method: 'POST',
          headers: {'Content-Type': 'application/json'},
          body: JSON.stringify(payload),
        });
        const data = await r.json();
        if (!r.ok || !data.ok) throw new Error(data.error || 'Failed to update controls');
        const controls = data.controls || {};
        this.runtimeControls.scrape_enabled = !!controls.scrape_enabled;
        this.runtimeControls.llm_enabled = !!controls.llm_enabled;
        this.runtimeControls.updated_at = controls.updated_at || null;
        await this.fetchActiveRun();
        await this.fetchLLMStatus();
      } catch (e) {
        console.error('update runtime controls', e);
        await this.fetchRuntimeControls();
      } finally {
        this.controlsBusy = false;
      }
    },

    async setScrapeEnabled(enabled) {
      await this.updateRuntimeControls({scrape_enabled: !!enabled});
    },

    async setLlmEnabled(enabled) {
      await this.updateRuntimeControls({llm_enabled: !!enabled});
    },

    async fetchScrapeRunnerStatus() {
      try {
        const r = await fetch('/api/scrape/runner/status?lines=80');
        this.scrapeRunner = await r.json();
      } catch (e) {
        console.error('scrape runner status', e);
      }
    },

    async runScrapeNow(llmEnabled = true) {
      this.scrapeRunBusy = true;
      this.scrapeRunError = '';
      try {
        const r = await fetch('/api/scrape/run', {
          method: 'POST',
          headers: {'Content-Type': 'application/json'},
          body: JSON.stringify({
            ignore_runtime_controls: true,
            llm_enabled: !!llmEnabled,
          }),
        });
        const data = await r.json();
        if (!r.ok || !data.ok) {
          this.scrapeRunError = data.error || 'Failed to start scrape run';
          if (data.runner) this.scrapeRunner = data.runner;
          return;
        }
        this.scrapeRunner = data.runner || this.scrapeRunner;
        await this.fetchActiveRun();
        await this.fetchRuns();
      } catch (e) {
        console.error('manual scrape run', e);
        this.scrapeRunError = 'Failed to start scrape run';
      } finally {
        this.scrapeRunBusy = false;
      }
    },

    // ── Tailoring transparency ──────────────────────────────
    get tailoringSelectedEvent() {
      if (this.tailoringSelectedEventIdx < 0) return null;
      return this.tailoringTrace[this.tailoringSelectedEventIdx] || null;
    },

    async fetchTailoringRuns() {
      this.tailoringLoading = true;
      try {
        const r = await fetch('/api/tailoring/runs');
        const data = await r.json();
        this.tailoringRuns = data.runs || [];
      } catch (e) {
        console.error('tailoring runs', e);
      }
      this.tailoringLoading = false;
    },

    async fetchTailoringRecentJobs() {
      try {
        const r = await fetch('/api/tailoring/jobs/recent?limit=40');
        const data = await r.json();
        this.tailoringRecentJobs = data.items || [];
        if (!this.tailoringRunConfig.selected_job_id && this.tailoringRecentJobs.length > 0) {
          this.tailoringRunConfig.selected_job_id = this.tailoringRecentJobs[0].id;
        }
      } catch (e) {
        console.error('tailoring recent jobs', e);
      }
    },

    async fetchTailoringRunnerStatus() {
      try {
        const r = await fetch('/api/tailoring/runner/status?lines=80');
        this.tailoringRunner = await r.json();
      } catch (e) {
        console.error('tailoring runner status', e);
      }
    },

    async runTailoringSelectedJob() {
      if (!this.tailoringRunConfig.selected_job_id) return;
      this.tailoringRunBusy = true;
      this.tailoringRunError = '';
      try {
        const payload = {
          job_id: this.tailoringRunConfig.selected_job_id,
          skip_analysis: !!this.tailoringRunConfig.skip_analysis,
        };
        const r = await fetch('/api/tailoring/run', {
          method: 'POST',
          headers: {'Content-Type': 'application/json'},
          body: JSON.stringify(payload),
        });
        const data = await r.json();
        if (!r.ok || !data.ok) {
          this.tailoringRunError = data.error || 'Failed to start run';
          if (data.runner) this.tailoringRunner = data.runner;
          return;
        }
        this.tailoringRunner = data.runner || this.tailoringRunner;
        await this.fetchTailoringRuns();
      } catch (e) {
        console.error('run tailoring selected job', e);
        this.tailoringRunError = 'Failed to start run';
      } finally {
        this.tailoringRunBusy = false;
      }
    },

    tailoringJobOptionLabel(job) {
      const title = (job?.title || '').replace(/\s+/g, ' ').trim();
      const when = this.timeAgo(job?.created_at);
      return `${job?.id ?? '—'} · ${title || 'Untitled job'} (${when})`;
    },

    copyTailoringLogs() {
      const text = this.tailoringRunner?.log_tail || '';
      if (!text) return;
      navigator.clipboard.writeText(text).catch(() => {});
    },

    async fetchTailoringSelectedJobDetail() {
      const id = this.tailoringRunConfig?.selected_job_id;
      if (!id) {
        this.tailoringSelectedJobDetail = null;
        this.tailoringSelectedJobDetailLoading = false;
        return;
      }
      this.tailoringSelectedJobDetailLoading = true;
      this.tailoringSelectedJobDetail = null;
      try {
        const r = await fetch('/api/jobs/' + id);
        if (!r.ok) {
          this.tailoringSelectedJobDetail = null;
          return;
        }
        this.tailoringSelectedJobDetail = await r.json();
      } catch (e) {
        console.error('tailoring selected job detail', e);
        this.tailoringSelectedJobDetail = null;
      } finally {
        this.tailoringSelectedJobDetailLoading = false;
      }
    },

    async openTailoringRun(slug) {
      this.tailoringSelectedSlug = slug;
      this.tailoringSelectedEventIdx = -1;
      this.tailoringDetail = null;
      this.tailoringTrace = [];
      try {
        const r = await fetch('/api/tailoring/runs/' + encodeURIComponent(slug));
        this.tailoringDetail = await r.json();
        await this.fetchTailoringTrace();
      } catch (e) {
        console.error('tailoring detail', e);
      }
    },

    async fetchTailoringTrace() {
      if (!this.tailoringSelectedSlug) return;
      const p = new URLSearchParams();
      if (this.tailoringFilter.doc_type) p.set('doc_type', this.tailoringFilter.doc_type);
      if (this.tailoringFilter.phase) p.set('phase', this.tailoringFilter.phase);
      if (this.tailoringFilter.attempt !== '' && this.tailoringFilter.attempt != null) p.set('attempt', this.tailoringFilter.attempt);
      try {
        const r = await fetch('/api/tailoring/runs/' + encodeURIComponent(this.tailoringSelectedSlug) + '/trace?' + p.toString());
        const data = await r.json();
        this.tailoringTrace = data.events || [];
        this.tailoringSelectedEventIdx = this.tailoringTrace.length ? 0 : -1;
      } catch (e) {
        console.error('tailoring trace', e);
      }
    },

    selectTailoringEvent(idx) {
      this.tailoringSelectedEventIdx = idx;
    },

    copyTracePane() {
      const ev = this.tailoringSelectedEvent;
      if (!ev) return;
      let text = '';
      if (this.traceTab === 'system') text = ev.system_prompt || '';
      if (this.traceTab === 'user') text = ev.user_prompt || '';
      if (this.traceTab === 'response') text = ev.raw_response || ev.error || '';
      if (this.traceTab === 'meta') text = this.formatCellFull(ev);
      navigator.clipboard.writeText(text).catch(() => {});
    },

    openPackageFromTailoring() {
      if (!this.tailoringSelectedSlug) return;
      this.view = 'packages';
      this.openPackage(this.tailoringSelectedSlug);
    },

    // ── Application packages ───────────────────────────────
    async fetchPackages() {
      this.packagesLoading = true;
      try {
        const r = await fetch('/api/packages?status=complete');
        const data = await r.json();
        this.packages = data.items || [];
      } catch (e) {
        console.error('packages', e);
      }
      this.packagesLoading = false;
    },

    async openPackage(slug) {
      this.packageSelectedSlug = slug;
      this.packageDetail = null;
      this.packageCompileError = '';
      this.packageDiffError = '';
      this.packageSaveStatus = '';
      this.packageAuxDoc = 'analysis';
      this.packageAuxContent = '';
      try {
        const r = await fetch('/api/packages/' + encodeURIComponent(slug));
        this.packageDetail = await r.json();
        this.packageResumeTex = this.packageDetail?.latex?.resume || '';
        this.packageCoverTex = this.packageDetail?.latex?.cover || '';
        this.packagePreviewBuster.resume = Date.now();
        this.packagePreviewBuster.cover = Date.now();
        this.packageDiffBuster.resume = Date.now();
        this.packageDiffBuster.cover = Date.now();
        await this.setPackageAuxDoc('analysis');
      } catch (e) {
        console.error('package detail', e);
      }
    },

    openTailoringFromPackage() {
      this.view = 'tailoring';
      if (this.packageSelectedSlug) this.openTailoringRun(this.packageSelectedSlug);
    },

    packagePdfUrl() {
      if (!this.packageSelectedSlug) return '';
      const name = this.packageDoc === 'resume' ? 'Conner_Jordan_Resume.pdf' : 'Conner_Jordan_Cover_Letter.pdf';
      const bust = this.packageDoc === 'resume' ? this.packagePreviewBuster.resume : this.packagePreviewBuster.cover;
      return '/api/tailoring/runs/' + encodeURIComponent(this.packageSelectedSlug) + '/artifact/' + name + '?v=' + bust;
    },

    packageDiffPdfUrl() {
      if (!this.packageSelectedSlug) return '';
      const bust = this.packageDoc === 'resume' ? this.packageDiffBuster.resume : this.packageDiffBuster.cover;
      return '/api/packages/' + encodeURIComponent(this.packageSelectedSlug) + '/diff-preview/' + this.packageDoc + '?v=' + bust;
    },

    refreshPackageDiffPreview() {
      this.packageDiffError = '';
      this.packageDiffBuster[this.packageDoc] = Date.now();
    },

    onPackageLatexInput(docType) {
      this.packageSaveStatus = 'saving...';
      if (this.packageSaveTimers[docType]) clearTimeout(this.packageSaveTimers[docType]);
      this.packageSaveTimers[docType] = setTimeout(() => {
        this.savePackageLatex(docType, true);
      }, 900);
    },

    async savePackageLatex(docType, compileAfter = false) {
      if (!this.packageSelectedSlug) return;
      const content = docType === 'resume' ? this.packageResumeTex : this.packageCoverTex;
      try {
        const r = await fetch('/api/packages/' + encodeURIComponent(this.packageSelectedSlug) + '/latex/' + docType, {
          method: 'POST',
          headers: {'Content-Type': 'application/json'},
          body: JSON.stringify({content}),
        });
        const data = await r.json();
        if (!data.ok) {
          this.packageSaveStatus = 'save failed';
          return;
        }
        this.packageSaveStatus = 'saved';
        this.packageDiffBuster[docType] = Date.now();
        if (compileAfter) await this.compilePackageDoc(docType);
      } catch (e) {
        console.error('save latex', e);
        this.packageSaveStatus = 'save failed';
      }
    },

    async compilePackageDoc(forceDocType = null) {
      if (!this.packageSelectedSlug) return;
      const docType = forceDocType || this.packageDoc;
      this.packageCompileError = '';
      this.packageSaveStatus = 'compiling...';
      try {
        const r = await fetch('/api/packages/' + encodeURIComponent(this.packageSelectedSlug) + '/compile/' + docType, {
          method: 'POST',
        });
        const data = await r.json();
        if (!data.ok) {
          this.packageCompileError = data.error || 'compile failed';
          this.packageSaveStatus = 'compile failed';
          return;
        }
        this.packageSaveStatus = 'compiled';
        this.packagePreviewBuster[docType] = Date.now();
        this.packageDiffBuster[docType] = Date.now();
      } catch (e) {
        console.error('compile package', e);
        this.packageCompileError = String(e);
        this.packageSaveStatus = 'compile failed';
      }
    },

    packageAuxTitle() {
      if (this.packageAuxDoc === 'analysis') return 'LLM Report (analysis.json)';
      if (this.packageAuxDoc === 'resume_strategy') return 'Resume Strategy';
      if (this.packageAuxDoc === 'cover_strategy') return 'Cover Strategy';
      if (this.packageAuxDoc === 'trace') return 'LLM Trace Events';
      return 'Document';
    },

    packageAuxDownloadUrl() {
      if (!this.packageSelectedSlug) return '#';
      const name = this.packageAuxDoc === 'analysis'
        ? 'analysis.json'
        : this.packageAuxDoc === 'resume_strategy'
          ? 'resume_strategy.json'
          : this.packageAuxDoc === 'cover_strategy'
            ? 'cover_strategy.json'
            : 'llm_trace.jsonl';
      return '/api/tailoring/runs/' + encodeURIComponent(this.packageSelectedSlug) + '/artifact/' + name;
    },

    async setPackageAuxDoc(doc) {
      this.packageAuxDoc = doc;
      if (!this.packageDetail) return;
      if (doc === 'analysis') {
        this.packageAuxContent = this.formatCellFull(this.packageDetail.analysis || {});
        return;
      }
      if (doc === 'resume_strategy') {
        this.packageAuxContent = this.formatCellFull(this.packageDetail.resume_strategy || {});
        return;
      }
      if (doc === 'cover_strategy') {
        this.packageAuxContent = this.formatCellFull(this.packageDetail.cover_strategy || {});
        return;
      }
      if (doc === 'trace' && this.packageSelectedSlug) {
        try {
          const r = await fetch('/api/tailoring/runs/' + encodeURIComponent(this.packageSelectedSlug) + '/trace');
          const data = await r.json();
          this.packageAuxContent = this.formatCellFull(data.events || []);
        } catch (e) {
          console.error('package trace load', e);
          this.packageAuxContent = 'Failed to load trace events.';
        }
      }
    },

    // ── Dedup & Growth ──────────────────────────────────────
    async fetchDedupStats() {
      try {
        const r = await fetch('/api/dedup/stats');
        this.dedupData = await r.json();
        this.dedupLoaded = true;
        this.$nextTick(() => {
          this.renderRepeatChart();
          this.renderUniquenessChart();
          this.renderDailyNewChart();
        });
      } catch(e) { console.error('dedup', e); }
    },

    async fetchFilterStats() {
      try {
        const r = await fetch('/api/filters/stats');
        const data = await r.json();
        this.filterStages = data.stages || [];
        if (this.runs.length === 0) await this.fetchRuns();
        let totalDedup = 0, totalPassed = 0;
        for (const run of this.runs) {
          if (run.dedup_count != null && run.filtered_count != null) {
            totalDedup += run.dedup_count;
            totalPassed += run.filtered_count;
          }
        }
        this.passRate = totalDedup > 0 ? Math.round(totalPassed / totalDedup * 100) + '%' : '—';
        this.$nextTick(() => this.renderFilterChart());
      } catch(e) { console.error('filters', e); }
    },

    // ── Rejected ─────────────────────────────────────────────
    async fetchRejectedStats() {
      try {
        const r = await fetch('/api/rejected/stats');
        this.rejectedStats = await r.json();
      } catch(e) { console.error('rejected stats', e); }
    },

    async fetchRejected() {
      this.rejectedLoading = true;
      const p = new URLSearchParams({page: this.rPage, per_page: this.rPerPage});
      if (this.rf.stage) p.set('stage', this.rf.stage);
      if (this.rf.run_id) p.set('run_id', this.rf.run_id);
      if (this.rf.search) p.set('search', this.rf.search);
      try {
        const r = await fetch('/api/rejected?' + p);
        const data = await r.json();
        this.rejected = data;
        this.rejectedStages = data.stages || [];
      } catch(e) { console.error('rejected', e); }
      this.rejectedLoading = false;
    },

    async toggleRejected(id) {
      if (this.expandedRejectedId === id) {
        this.expandedRejectedId = null; this.expandedRejectedDetail = null; return;
      }
      this.expandedRejectedId = id;
      this.expandedRejectedDetail = null;
      try {
        const r = await fetch('/api/rejected/' + id);
        this.expandedRejectedDetail = await r.json();
      } catch(e) { console.error('rejected detail', e); }
    },

    async approveRejected(job) {
      if (!job?.id || this.approvingRejectedIds[job.id]) return;
      this.approvingRejectedIds[job.id] = true;
      try {
        const r = await fetch('/api/rejected/' + job.id + '/approve', {method: 'POST'});
        const data = await r.json();
        if (!r.ok || !data.ok) throw new Error(data.error || 'Failed to approve rejected job');

        if (this.expandedRejectedId === job.id) {
          this.expandedRejectedId = null;
          this.expandedRejectedDetail = null;
        }
        await this.fetchRejected();
        await this.fetchRejectedStats();
        if (this.jobs.items.length > 0) await this.fetchJobs();
      } catch(e) {
        console.error('approve rejected', e);
      } finally {
        delete this.approvingRejectedIds[job.id];
      }
    },

    // ── LLM status ──────────────────────────────────────────
    async fetchLLMStatus() {
      try {
        const r = await fetch('/api/llm/status');
        this.llmStatus = await r.json();
        if (this.llmStatus && typeof this.llmStatus.enabled === 'boolean') {
          this.runtimeControls.llm_enabled = this.llmStatus.enabled;
        }
      } catch(e) { this.llmStatus = {enabled: true, available: false, models: [], url: 'http://localhost:1234'}; }
    },

    // ── Schedules ────────────────────────────────────────────
    async fetchSchedules() {
      this.schedLoading = true;
      try {
        const r = await fetch('/api/schedules');
        const data = await r.json();
        this.schedJobs = data.jobs || [];
      } catch(e) { console.error('schedules', e); }
      this.schedLoading = false;
    },

    toggleSchedExpand(label) {
      this.schedExpandedId = this.schedExpandedId === label ? null : label;
    },

    async fetchSchedLog(label) {
      try {
        const r = await fetch('/api/schedules/' + encodeURIComponent(label) + '/log?lines=' + this.schedLogLines);
        const data = await r.json();
        this.schedLogData[label] = data;
        // Scroll to bottom after render
        this.$nextTick(() => {
          const viewer = this.$refs.logViewer;
          if (viewer) viewer.scrollTop = viewer.scrollHeight;
        });
      } catch(e) { console.error('sched log', e); }
    },

    // ── DB Explorer ─────────────────────────────────────────
    async fetchDBTables() {
      try {
        const r = await fetch('/api/db/tables');
        const data = await r.json();
        this.dbTables = data.tables || [];
        if (this.dbTables.length > 0 && !this.explorerTable) {
          this.explorerTable = this.dbTables[0].name;
          this.fetchExplorerData();
        }
      } catch(e) { console.error('db tables', e); }
    },

    async fetchExplorerData() {
      this.explorerLoading = true;
      this.explorerColFilters = {};
      const p = new URLSearchParams({page: this.explorerPage, per_page: this.explorerPerPage});
      if (this.explorerSort.by) {
        p.set('sort_by', this.explorerSort.by);
        p.set('sort_dir', this.explorerSort.dir);
      }
      try {
        const r = await fetch('/api/db/table/' + encodeURIComponent(this.explorerTable) + '?' + p);
        this.explorerData = await r.json();
        this.explorerFiltered = this.explorerData.items;
      } catch(e) { console.error('explorer', e); }
      this.explorerLoading = false;
    },

    toggleExplorerSort(col) {
      if (this.explorerSort.by === col) this.explorerSort.dir = this.explorerSort.dir === 'asc' ? 'desc' : 'asc';
      else { this.explorerSort.by = col; this.explorerSort.dir = 'asc'; }
      this.explorerPage = 1;
      this.fetchExplorerData();
    },

    filterExplorerLocal() {
      const filters = this.explorerColFilters;
      this.explorerFiltered = this.explorerData.items.filter(row => {
        for (const col in filters) {
          if (!filters[col]) continue;
          const val = String(row[col] ?? '').toLowerCase();
          if (!val.includes(filters[col].toLowerCase())) return false;
        }
        return true;
      });
    },

    openRowModal(row) {
      this.rowModalData = row;
    },

    copyExplorerJSON() {
      const text = JSON.stringify(this.explorerFiltered, null, 2);
      navigator.clipboard.writeText(text).catch(() => {});
    },

    // ── SQL Console ─────────────────────────────────────────
    async runSQL() {
      if (!this.sqlText.trim()) return;
      this.sqlRunning = true;
      this.sqlError = '';
      this.sqlResult = null;
      try {
        const r = await fetch('/api/db/query?sql=' + encodeURIComponent(this.sqlText.trim()));
        const data = await r.json();
        if (data.error) {
          this.sqlError = data.error;
        } else {
          this.sqlResult = data;
          // Save to history
          const q = this.sqlText.trim();
          this.sqlHistory = [q, ...this.sqlHistory.filter(h => h !== q)].slice(0, 10);
          localStorage.setItem('sqlHistory', JSON.stringify(this.sqlHistory));
        }
      } catch(e) { this.sqlError = 'Request failed: ' + e.message; }
      this.sqlRunning = false;
    },

    runSQLPreset(query) {
      this.sqlText = query;
      this.runSQL();
    },

    // ── Chart rendering ─────────────────────────────────────
    renderGrowthChart() {
      const el = document.getElementById('growthChart');
      if (!el || !this._growthData) return;
      if (this.growthChart) this.growthChart.destroy();
      const results = this._growthData.results || [];
      const seen = this._growthData.seen_urls || [];
      const datasets = [{
        label: 'Cumulative Results',
        data: results.map(d => ({x: d.date, y: d.cumulative})),
        borderColor: '#4361ee',
        backgroundColor: 'rgba(67,97,238,.1)',
        fill: true, tension: .3, pointRadius: 0,
      }];
      if (seen.length > 0) {
        datasets.push({
          label: 'Cumulative URLs Seen',
          data: seen.map(d => ({x: d.date, y: d.cumulative})),
          borderColor: '#7c3aed',
          backgroundColor: 'rgba(124,58,237,.05)',
          fill: true, tension: .3, pointRadius: 0,
          yAxisID: 'y1',
        });
      }
      const opts = {
        responsive: true, maintainAspectRatio: false,
        interaction: {mode: 'index', intersect: false},
        plugins: {legend: {position: 'top', labels: {boxWidth: 12}}},
        scales: {
          x: {type: 'category', grid: {display: false}},
          y: {beginAtZero: true, position: 'left', title: {display: true, text: 'Results'}},
        }
      };
      if (seen.length > 0) {
        opts.scales.y1 = {beginAtZero: true, position: 'right', title: {display: true, text: 'URLs Seen'}, grid: {drawOnChartArea: false}};
      }
      this.growthChart = new Chart(el, {type: 'line', data: {labels: results.map(d => d.date.slice(5)), datasets}, options: opts});
    },

    renderTrendChart() {
      const el = document.getElementById('trendChart');
      if (!el || !this.ov.trend) return;
      if (this.trendChart) this.trendChart.destroy();
      this.trendChart = new Chart(el, {
        type: 'bar',
        data: {
          labels: this.ov.trend.map(d => d.date.slice(5)),
          datasets: [{
            label: 'Jobs/Day',
            data: this.ov.trend.map(d => d.count),
            backgroundColor: 'rgba(67,97,238,.6)',
            borderRadius: 4,
          }]
        },
        options: {responsive:true,maintainAspectRatio:false,plugins:{legend:{display:false}},scales:{y:{beginAtZero:true,ticks:{stepSize:1}},x:{grid:{display:false}}}}
      });
    },

    renderBoardChart() {
      const el = document.getElementById('boardChart');
      if (!el || !this.ov.boards) return;
      if (this.boardChart) this.boardChart.destroy();
      const labels = Object.keys(this.ov.boards);
      const colors = ['#06d6a0','#ffd166','#4361ee','#ef476f','#7c3aed','#f97316','#14b8a6','#6b7280'];
      this.boardChart = new Chart(el, {
        type: 'doughnut',
        data: {labels, datasets: [{data: Object.values(this.ov.boards), backgroundColor: colors.slice(0,labels.length)}]},
        options: {responsive:true,maintainAspectRatio:false,plugins:{legend:{position:'right',labels:{boxWidth:12,padding:8,font:{size:12}}}}}
      });
    },

    renderSeniorityChart() {
      const el = document.getElementById('seniorityChart');
      if (!el || !this.ov.seniority) return;
      if (this.seniorityChart) this.seniorityChart.destroy();
      const labels = Object.keys(this.ov.seniority);
      const colors = ['#06d6a0','#4361ee','#ffd166','#ef476f','#7c3aed','#f97316','#14b8a6','#ec4899','#6b7280'];
      this.seniorityChart = new Chart(el, {
        type: 'doughnut',
        data: {labels, datasets: [{data: Object.values(this.ov.seniority), backgroundColor: colors.slice(0,labels.length)}]},
        options: {responsive:true,maintainAspectRatio:false,plugins:{legend:{position:'right',labels:{boxWidth:12,padding:8,font:{size:12}}}}}
      });
    },

    renderRunTimeline() {
      const el = document.getElementById('runTimelineChart');
      if (!el || !this.runs.length) return;
      if (this.runTimelineChart) this.runTimelineChart.destroy();
      const recent = this.runs.slice().reverse().slice(-30);
      const colors = recent.map(r => r.status === 'complete' ? '#06d6a0' : (r.status === 'running' ? '#4361ee' : '#ef476f'));
      this.runTimelineChart = new Chart(el, {
        type: 'bar',
        data: {
          labels: recent.map(r => r.started_at ? new Date(r.started_at).toLocaleDateString('en-US', {month:'short',day:'numeric'}) : ''),
          datasets: [{
            label: 'Duration (s)',
            data: recent.map(r => r.elapsed ?? 0),
            backgroundColor: colors,
            borderRadius: 4,
          }]
        },
        options: {responsive:true,maintainAspectRatio:false,plugins:{legend:{display:false}},scales:{y:{beginAtZero:true,title:{display:true,text:'seconds'}},x:{grid:{display:false}}}}
      });
    },

    renderRepeatChart() {
      const el = document.getElementById('repeatChart');
      if (!el || !this.dedupData?.repeat_freq) return;
      if (this.repeatChart) this.repeatChart.destroy();
      const freq = this.dedupData.repeat_freq;
      this.repeatChart = new Chart(el, {
        type: 'doughnut',
        data: {
          labels: Object.keys(freq),
          datasets: [{data: Object.values(freq), backgroundColor: ['#06d6a0','#4361ee','#ffd166','#ef476f']}]
        },
        options: {responsive:true,maintainAspectRatio:false,plugins:{legend:{position:'right',labels:{boxWidth:12,padding:8,font:{size:12}}}}}
      });
    },

    renderUniquenessChart() {
      const el = document.getElementById('uniquenessChart');
      if (!el || !this.dedupData?.run_uniqueness?.length) return;
      if (this.uniquenessChart) this.uniquenessChart.destroy();
      const data = this.dedupData.run_uniqueness.slice().reverse().slice(-30);
      const pcts = data.map(r => r.dedup > 0 ? Math.round(r.stored / r.dedup * 100) : 0);
      this.uniquenessChart = new Chart(el, {
        type: 'line',
        data: {
          labels: data.map(r => r.date ? new Date(r.date).toLocaleDateString('en-US', {month:'short',day:'numeric'}) : ''),
          datasets: [{
            label: '% Unique',
            data: pcts,
            borderColor: '#7c3aed',
            backgroundColor: 'rgba(124,58,237,.1)',
            fill: true, tension: .3, pointRadius: 2,
          }]
        },
        options: {responsive:true,maintainAspectRatio:false,plugins:{legend:{display:false}},scales:{y:{beginAtZero:true,max:100,ticks:{callback:v=>v+'%'}},x:{grid:{display:false}}}}
      });
    },

    renderDailyNewChart() {
      const el = document.getElementById('dailyNewChart');
      if (!el || !this.dedupData?.daily_new?.length) return;
      if (this.dailyNewChart) this.dailyNewChart.destroy();
      const data = this.dedupData.daily_new;
      this.dailyNewChart = new Chart(el, {
        type: 'bar',
        data: {
          labels: data.map(d => d.date.slice(5)),
          datasets: [{
            label: 'New Jobs',
            data: data.map(d => d.count),
            backgroundColor: 'rgba(6,214,160,.6)',
            borderRadius: 4,
          }]
        },
        options: {responsive:true,maintainAspectRatio:false,plugins:{legend:{display:false}},scales:{y:{beginAtZero:true,ticks:{stepSize:1}},x:{grid:{display:false}}}}
      });
    },

    renderFilterChart() {
      const el = document.getElementById('filterChart');
      if (!el || !this.filterStages.length) return;
      if (this.filterChart) this.filterChart.destroy();
      const items = [];
      for (const s of this.filterStages) {
        for (const r of s.reasons.slice(0, 3)) {
          items.push({label: s.stage + ': ' + r.reason, count: r.count});
        }
      }
      items.sort((a,b) => b.count - a.count);
      const top = items.slice(0, 12);
      this.filterChart = new Chart(el, {
        type: 'bar',
        data: {
          labels: top.map(i => i.label.length > 40 ? i.label.slice(0,37)+'...' : i.label),
          datasets: [{data: top.map(i => i.count), backgroundColor: '#4361ee', borderRadius: 4}]
        },
        options: {indexAxis:'y',responsive:true,maintainAspectRatio:false,plugins:{legend:{display:false}},scales:{x:{beginAtZero:true,ticks:{stepSize:1}},y:{ticks:{font:{size:11}}}}}
      });
    },

    // ── Formatters ──────────────────────────────────────────
    fmt(n) { return n != null ? n.toLocaleString() : '—'; },

    fmtBytes(bytes) {
      if (bytes == null || bytes === 0) return '—';
      const units = ['B','KB','MB','GB'];
      let i = 0;
      let val = bytes;
      while (val >= 1024 && i < units.length - 1) { val /= 1024; i++; }
      return val.toFixed(i > 0 ? 1 : 0) + ' ' + units[i];
    },

    timeAgo(ts) {
      if (!ts) return '—';
      const d = new Date(ts);
      const diff = (Date.now() - d.getTime()) / 1000;
      if (diff < 60) return Math.round(diff) + 's ago';
      if (diff < 3600) return Math.round(diff/60) + 'm ago';
      if (diff < 86400) return Math.round(diff/3600) + 'h ago';
      return Math.round(diff/86400) + 'd ago';
    },

    fmtDate(ts) {
      if (!ts) return '—';
      return new Date(ts).toLocaleDateString('en-US', {month:'short',day:'numeric',year:'numeric'});
    },

    fmtDuration(sec) {
      if (sec == null) return '—';
      if (sec < 60) return Math.round(sec) + 's';
      return Math.floor(sec/60) + 'm ' + Math.round(sec%60) + 's';
    },

    formatCell(val) {
      if (val === null || val === undefined) return 'NULL';
      if (typeof val === 'string' && val.length > 100) return val.slice(0, 100) + '...';
      return String(val);
    },

    formatCellFull(val) {
      if (val === null || val === undefined) return 'NULL';
      if (typeof val === 'object') return JSON.stringify(val, null, 2);
      if (typeof val === 'string') {
        try { return JSON.stringify(JSON.parse(val), null, 2); } catch(e) {}
      }
      return String(val);
    },
  };
}
</script>
</body>
</html>
