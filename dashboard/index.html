<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Job Scraper Dashboard</title>
<script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.14.8/dist/cdn.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.7/dist/chart.umd.min.js"></script>
<style>
/* ── Reset & Base ───────────────────────────────────────────── */
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0}
:root{
  --bg:#f4f6f9;--surface:#fff;--sidebar:#111827;--sidebar-hover:#1f2937;
  --accent:#4361ee;--accent-light:#eef1ff;
  --green:#06d6a0;--amber:#ffd166;--red:#ef476f;--purple:#7c3aed;
  --cyan:#06b6d4;--orange:#f97316;--teal:#14b8a6;
  --text:#1f2937;--text-secondary:#6b7280;--border:#e5e7eb;
  --radius:8px;--shadow:0 1px 3px rgba(0,0,0,.08);
  --font:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,sans-serif;
}
html{font-size:14px}
body{font-family:var(--font);color:var(--text);background:var(--bg);display:flex;min-height:100vh}

/* ── Sidebar ────────────────────────────────────────────────── */
.sidebar{
  width:220px;min-height:100vh;background:var(--sidebar);color:#fff;
  display:flex;flex-direction:column;position:fixed;top:0;left:0;bottom:0;z-index:10;
}
.sidebar-brand{padding:20px 20px 16px;font-size:1.15rem;font-weight:700;letter-spacing:-.02em;border-bottom:1px solid rgba(255,255,255,.08)}
.sidebar-brand span{color:var(--accent);font-weight:800}
.sidebar-nav{padding:12px 0;flex:1}
.nav-item{
  display:flex;align-items:center;gap:10px;padding:10px 20px;cursor:pointer;
  color:rgba(255,255,255,.6);font-size:.9rem;font-weight:500;
  transition:all .15s ease;border-left:3px solid transparent;
}
.nav-item:hover{color:#fff;background:var(--sidebar-hover)}
.nav-item.active{color:#fff;background:var(--sidebar-hover);border-left-color:var(--accent)}
.nav-item svg{width:18px;height:18px;flex-shrink:0;opacity:.7}
.nav-item.active svg{opacity:1}
.sidebar-footer{padding:16px 20px;font-size:.75rem;color:rgba(255,255,255,.3);border-top:1px solid rgba(255,255,255,.08)}
.sidebar-footer .db-size{color:rgba(255,255,255,.5);font-weight:600}

/* ── Main ───────────────────────────────────────────────────── */
.main{margin-left:220px;flex:1;min-height:100vh;padding:28px 32px}
.page-header{display:flex;align-items:center;justify-content:space-between;margin-bottom:24px}
.page-title{font-size:1.5rem;font-weight:700}
.last-updated{font-size:.8rem;color:var(--text-secondary)}

/* ── Cards ──────────────────────────────────────────────────── */
.cards{display:grid;grid-template-columns:repeat(auto-fit,minmax(170px,1fr));gap:16px;margin-bottom:24px}
.card{background:var(--surface);border-radius:var(--radius);padding:20px;box-shadow:var(--shadow);transition:transform .15s ease}
.card:hover{transform:translateY(-2px)}
.card-label{font-size:.8rem;color:var(--text-secondary);font-weight:600;text-transform:uppercase;letter-spacing:.04em;margin-bottom:6px}
.card-value{font-size:1.75rem;font-weight:700;line-height:1.2}
.card-sub{font-size:.8rem;color:var(--text-secondary);margin-top:4px}
.card-icon{width:36px;height:36px;border-radius:8px;display:flex;align-items:center;justify-content:center;margin-bottom:10px}
.card-icon svg{width:20px;height:20px}
.card-icon.blue{background:var(--accent-light);color:var(--accent)}
.card-icon.purple{background:#f3f0ff;color:var(--purple)}
.card-icon.green{background:#ecfdf5;color:var(--green)}
.card-icon.amber{background:#fffbeb;color:#d97706}
.card-icon.red{background:#fef2f2;color:var(--red)}
.card-icon.cyan{background:#ecfeff;color:var(--cyan)}

/* ── Charts ─────────────────────────────────────────────────── */
.chart-container{background:var(--surface);border-radius:var(--radius);padding:20px;box-shadow:var(--shadow);margin-bottom:24px}
.chart-title{font-size:.95rem;font-weight:600;margin-bottom:16px}
.chart-row{display:grid;grid-template-columns:1fr 1fr;gap:16px;margin-bottom:24px}
.chart-row .chart-container{margin-bottom:0}
canvas{max-height:260px}

/* ── Run health strip ──────────────────────────────────────── */
.health-strip{display:flex;gap:4px;align-items:center;margin-bottom:24px;background:var(--surface);border-radius:var(--radius);padding:16px 20px;box-shadow:var(--shadow)}
.health-strip-label{font-size:.85rem;font-weight:600;margin-right:12px;white-space:nowrap}
.health-block{width:24px;height:24px;border-radius:4px;cursor:pointer;transition:transform .1s;position:relative}
.health-block:hover{transform:scale(1.3);z-index:1}
.health-block.success{background:var(--green)}
.health-block.failed{background:var(--red)}
.health-block.running{background:var(--accent);animation:pulse 1.5s infinite}
.health-block-tooltip{display:none;position:absolute;bottom:calc(100% + 6px);left:50%;transform:translateX(-50%);background:#1f2937;color:#fff;padding:4px 8px;border-radius:4px;font-size:.75rem;white-space:nowrap;z-index:20}
.health-block:hover .health-block-tooltip{display:block}

/* ── Table ──────────────────────────────────────────────────── */
.panel{background:var(--surface);border-radius:var(--radius);box-shadow:var(--shadow);overflow:hidden;margin-bottom:24px}
.panel-header{padding:16px 20px;border-bottom:1px solid var(--border);display:flex;align-items:center;justify-content:space-between}
.panel-title{font-size:.95rem;font-weight:600}
.filters{display:flex;gap:8px;flex-wrap:wrap;padding:12px 20px;border-bottom:1px solid var(--border);background:#fafbfc}
.filters select,.filters input{
  padding:6px 10px;border:1px solid var(--border);border-radius:6px;font-size:.85rem;
  font-family:var(--font);background:#fff;color:var(--text);outline:none;
}
.filters select:focus,.filters input:focus{border-color:var(--accent);box-shadow:0 0 0 2px var(--accent-light)}
.btn{
  padding:6px 14px;border:none;border-radius:6px;font-size:.85rem;font-weight:500;
  cursor:pointer;font-family:var(--font);transition:all .15s ease;
}
.btn-primary{background:var(--accent);color:#fff}
.btn-primary:hover{background:#3451d1}
.btn-ghost{background:transparent;color:var(--text-secondary);border:1px solid var(--border)}
.btn-ghost:hover{background:#f3f4f6}
.btn-sm{padding:4px 10px;font-size:.8rem}
.btn-success{background:var(--green);color:#fff}
.btn-success:hover{background:#05c090}

.stats-bar{display:flex;gap:16px;padding:10px 20px;background:#f0f4ff;border-bottom:1px solid var(--border);font-size:.85rem;color:var(--text-secondary)}
.stats-bar strong{color:var(--text)}

table{width:100%;border-collapse:collapse}
thead{background:#fafbfc}
th{text-align:left;padding:10px 16px;font-size:.8rem;font-weight:600;text-transform:uppercase;letter-spacing:.04em;color:var(--text-secondary);border-bottom:1px solid var(--border);cursor:pointer;white-space:nowrap;user-select:none}
th:hover{color:var(--text)}
th .sort-arrow{font-size:.7rem;margin-left:4px;opacity:.4}
th.sorted .sort-arrow{opacity:1;color:var(--accent)}
td{padding:10px 16px;border-bottom:1px solid var(--border);font-size:.9rem;vertical-align:top}
tr:hover td{background:#f9fafb}
tr.expanded td{background:var(--accent-light);border-bottom-color:var(--accent-light)}
.clickable-row{cursor:pointer}
.clickable-row:hover td{background:#eef1ff}

/* ── Pills ──────────────────────────────────────────────────── */
.pill{display:inline-block;padding:2px 8px;border-radius:99px;font-size:.75rem;font-weight:600;white-space:nowrap}
.pill-greenhouse{background:#dcfce7;color:#166534}
.pill-lever{background:#fef9c3;color:#854d0e}
.pill-ashby{background:#dbeafe;color:#1e40af}
.pill-workday{background:#fce7f3;color:#9d174d}
.pill-bamboohr{background:#d1fae5;color:#065f46}
.pill-icims{background:#ede9fe;color:#5b21b6}
.pill-smartrecruiters{background:#fed7aa;color:#9a3412}
.pill-unknown{background:#f3f4f6;color:#6b7280}
.pill-junior{background:#dcfce7;color:#166534}
.pill-mid{background:#dbeafe;color:#1e40af}
.pill-senior{background:#fef9c3;color:#854d0e}
.pill-success,.pill-complete{background:#dcfce7;color:#166534}
.pill-running{background:#dbeafe;color:#1e40af}
.pill-fail,.pill-failed{background:#fee2e2;color:#991b1b}
.pill-new{background:#dbeafe;color:#1e40af;font-size:.7rem;margin-left:6px}

/* ── Job detail expand ──────────────────────────────────────── */
.job-detail{padding:16px 20px;background:#fafbfc;border-bottom:1px solid var(--border)}
.jd-text{max-height:400px;overflow-y:auto;white-space:pre-wrap;font-size:.85rem;line-height:1.6;background:#fff;padding:16px;border-radius:6px;border:1px solid var(--border);margin-top:12px}
.verdicts{margin-top:12px}
.verdict-step{display:flex;align-items:flex-start;gap:10px;padding:6px 0}
.verdict-dot{width:22px;height:22px;border-radius:50%;display:flex;align-items:center;justify-content:center;flex-shrink:0;font-size:.7rem;margin-top:1px}
.verdict-dot.pass{background:#dcfce7;color:#166534}
.verdict-dot.fail{background:#fee2e2;color:#991b1b}
.verdict-dot.llm{background:#f3f0ff;color:var(--purple)}

/* ── Rejection stage pills ──────────────────────────────────── */
.pill-stage-url_domain{background:#f3f4f6;color:#6b7280}
.pill-stage-title_relevance{background:#fffbeb;color:#d97706}
.pill-stage-title_role{background:#fffbeb;color:#d97706}
.pill-stage-seniority{background:#f3f0ff;color:#7c3aed}
.pill-stage-experience{background:#ecfeff;color:#0891b2}
.pill-stage-content_blocklist{background:#fee2e2;color:#991b1b}
.pill-stage-remote{background:#fff7ed;color:#c2410c}
.pill-stage-salary{background:#f0fdf4;color:#166534}
.pill-stage-llm_review{background:#f3f0ff;color:#7c3aed}
.verdict-stage{font-weight:600;font-size:.85rem}
.verdict-reason{font-size:.82rem;color:var(--text-secondary)}

/* ── Pagination ─────────────────────────────────────────────── */
.pagination{display:flex;align-items:center;justify-content:space-between;padding:12px 20px;border-top:1px solid var(--border)}
.pagination-info{font-size:.85rem;color:var(--text-secondary)}
.pagination-controls{display:flex;align-items:center;gap:8px}
.pagination-controls button{padding:6px 12px;border:1px solid var(--border);border-radius:6px;background:#fff;cursor:pointer;font-size:.85rem}
.pagination-controls button:disabled{opacity:.4;cursor:default}
.pagination-controls button:not(:disabled):hover{background:#f3f4f6}
.pagination-controls .page-num{font-size:.85rem;font-weight:600;min-width:80px;text-align:center}

/* ── Status dot ─────────────────────────────────────────────── */
.status-dot{width:8px;height:8px;border-radius:50%;display:inline-block;margin-right:6px}
.status-dot.active{background:var(--green);animation:pulse 1.5s infinite}
.status-dot.idle{background:var(--border)}
@keyframes pulse{0%,100%{opacity:1}50%{opacity:.4}}

/* ── Run stats ──────────────────────────────────────────────── */
.run-flow{display:flex;align-items:center;gap:4px;font-size:.85rem}
.run-flow .arrow{color:var(--text-secondary);font-size:.7rem}

/* ── Run timeline ──────────────────────────────────────────── */
.run-timeline-bar{height:20px;border-radius:4px;min-width:4px;transition:all .15s}
.run-timeline-bar.complete{background:var(--green)}
.run-timeline-bar.running{background:var(--accent)}
.run-timeline-bar.failed{background:var(--red)}

/* ── Error panel ───────────────────────────────────────────── */
.error-panel{background:#fef2f2;border:1px solid #fecaca;border-radius:6px;padding:12px 16px;margin:8px 0}
.error-panel-title{font-weight:600;color:#991b1b;font-size:.85rem;margin-bottom:6px;cursor:pointer}
.error-item{font-size:.82rem;color:#7f1d1d;padding:2px 0;font-family:monospace}

/* ── Dedup funnel ──────────────────────────────────────────── */
.funnel{display:flex;flex-direction:column;gap:8px;align-items:center;padding:20px}
.funnel-step{display:flex;align-items:center;gap:12px;width:100%;max-width:500px}
.funnel-bar{height:36px;border-radius:6px;display:flex;align-items:center;padding:0 12px;color:#fff;font-weight:600;font-size:.9rem;min-width:60px;transition:width .5s}
.funnel-label{font-size:.85rem;color:var(--text-secondary);min-width:120px;text-align:right}
.funnel-arrow{text-align:center;color:var(--text-secondary);font-size:1.2rem}

/* ── SQL Console ───────────────────────────────────────────── */
.sql-editor{width:100%;min-height:120px;padding:12px;font-family:'SF Mono',Monaco,Consolas,monospace;font-size:.9rem;border:1px solid var(--border);border-radius:6px;resize:vertical;outline:none;background:#fafbfc;line-height:1.5}
.sql-editor:focus{border-color:var(--accent);box-shadow:0 0 0 2px var(--accent-light)}
.query-meta{font-size:.8rem;color:var(--text-secondary);padding:8px 0}
.preset-queries{display:flex;gap:6px;flex-wrap:wrap;margin-bottom:12px}
.preset-btn{padding:4px 10px;border:1px solid var(--border);border-radius:99px;font-size:.8rem;background:#fff;cursor:pointer;color:var(--text-secondary);transition:all .15s}
.preset-btn:hover{border-color:var(--accent);color:var(--accent);background:var(--accent-light)}
.query-history-item{padding:6px 10px;border-bottom:1px solid var(--border);font-size:.82rem;font-family:monospace;cursor:pointer;color:var(--text-secondary)}
.query-history-item:hover{background:var(--accent-light);color:var(--accent)}

/* ── DB Explorer ───────────────────────────────────────────── */
.col-filter{padding:4px 6px;border:1px solid var(--border);border-radius:4px;font-size:.8rem;width:100%;outline:none;font-family:var(--font)}
.col-filter:focus{border-color:var(--accent)}
.cell-truncate{max-width:300px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
.cell-expand{cursor:pointer;color:var(--accent);font-size:.8rem}
.json-cell{font-family:monospace;font-size:.8rem;max-width:400px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}

/* ── Row detail modal ──────────────────────────────────────── */
.modal-overlay{position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,.5);display:flex;align-items:center;justify-content:center;z-index:100}
.modal{background:var(--surface);border-radius:12px;max-width:700px;width:90%;max-height:80vh;overflow-y:auto;box-shadow:0 20px 60px rgba(0,0,0,.2)}
.modal-header{padding:16px 20px;border-bottom:1px solid var(--border);display:flex;align-items:center;justify-content:space-between;position:sticky;top:0;background:var(--surface);z-index:1}
.modal-body{padding:20px}
.modal-field{padding:8px 0;border-bottom:1px solid var(--border)}
.modal-field:last-child{border-bottom:none}
.modal-field-label{font-size:.8rem;font-weight:600;color:var(--text-secondary);text-transform:uppercase;letter-spacing:.04em;margin-bottom:4px}
.modal-field-value{font-size:.9rem;word-break:break-all;white-space:pre-wrap}

/* ── Schedule cards ─────────────────────────────────────────── */
.sched-card{background:var(--surface);border-radius:var(--radius);box-shadow:var(--shadow);overflow:hidden;margin-bottom:16px;border-left:4px solid var(--border)}
.sched-card.loaded{border-left-color:var(--green)}
.sched-card.not-loaded{border-left-color:var(--red)}
.sched-card.running-now{border-left-color:var(--accent)}
.sched-header{display:flex;align-items:center;justify-content:space-between;padding:16px 20px;cursor:pointer}
.sched-header:hover{background:#fafbfc}
.sched-label{font-weight:700;font-size:1rem}
.sched-meta{display:flex;gap:16px;align-items:center;font-size:.85rem;color:var(--text-secondary)}
.sched-detail{padding:0 20px 16px;border-top:1px solid var(--border)}
.sched-field{display:flex;gap:12px;padding:8px 0;border-bottom:1px solid #f3f4f6;font-size:.9rem}
.sched-field:last-child{border-bottom:none}
.sched-field-label{min-width:130px;font-weight:600;color:var(--text-secondary);font-size:.8rem;text-transform:uppercase;letter-spacing:.04em}
.sched-field-value{flex:1;word-break:break-all;font-family:'SF Mono',Monaco,Consolas,monospace;font-size:.85rem}
.log-viewer{background:#1e1e2e;color:#cdd6f4;border-radius:6px;padding:16px;margin-top:12px;max-height:500px;overflow-y:auto;font-family:'SF Mono',Monaco,Consolas,monospace;font-size:.8rem;line-height:1.6}
.log-viewer .log-line{white-space:pre-wrap;word-break:break-all}
.log-viewer .log-line:hover{background:rgba(255,255,255,.05)}
.log-controls{display:flex;gap:8px;align-items:center;margin-top:12px}

/* ── Empty state ────────────────────────────────────────────── */
.empty{text-align:center;padding:48px 20px;color:var(--text-secondary)}
.empty-icon{font-size:2rem;margin-bottom:8px;opacity:.4}
.empty-text{font-size:.95rem}

/* ── Loading ────────────────────────────────────────────────── */
.loading{display:flex;align-items:center;justify-content:center;padding:40px}
.spinner{width:24px;height:24px;border:3px solid var(--border);border-top-color:var(--accent);border-radius:50%;animation:spin .6s linear infinite}
@keyframes spin{to{transform:rotate(360deg)}}

/* ── Link ───────────────────────────────────────────────────── */
a{color:var(--accent);text-decoration:none}
a:hover{text-decoration:underline}
.ext-link{color:var(--text-secondary);transition:color .15s}
.ext-link:hover{color:var(--accent)}

/* ── Responsive ─────────────────────────────────────────────── */
@media(max-width:768px){
  .sidebar{width:60px}.sidebar-brand span,.nav-item span,.sidebar-footer{display:none}
  .nav-item{justify-content:center;padding:12px}.main{margin-left:60px;padding:16px}
  .chart-row{grid-template-columns:1fr}.cards{grid-template-columns:repeat(2,1fr)}
}
</style>
</head>
<body x-data="dashboard()" x-init="init()">

<!-- ── Sidebar ──────────────────────────────────────────────── -->
<aside class="sidebar">
  <div class="sidebar-brand"><span>Job</span> Scraper</div>
  <nav class="sidebar-nav">
    <div class="nav-item" :class="{active: view==='overview'}" @click="go('overview')">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="7" height="7" rx="1"/><rect x="14" y="3" width="7" height="7" rx="1"/><rect x="3" y="14" width="7" height="7" rx="1"/><rect x="14" y="14" width="7" height="7" rx="1"/></svg>
      <span>Overview</span>
    </div>
    <div class="nav-item" :class="{active: view==='jobs'}" @click="go('jobs')">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 13V6a2 2 0 00-2-2H5a2 2 0 00-2 2v14a2 2 0 002 2h8"/><line x1="16" y1="17" x2="22" y2="17"/><line x1="16" y1="21" x2="22" y2="21"/></svg>
      <span>Jobs</span>
    </div>
    <div class="nav-item" :class="{active: view==='rejected'}" @click="go('rejected')">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><line x1="4.93" y1="4.93" x2="19.07" y2="19.07"/></svg>
      <span>Rejected</span>
    </div>
    <div class="nav-item" :class="{active: view==='runs'}" @click="go('runs')">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>
      <span>Runs</span>
    </div>
    <div class="nav-item" :class="{active: view==='dedup'}" @click="go('dedup')">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polygon points="22 3 2 3 10 12.46 10 19 14 21 14 12.46 22 3"/></svg>
      <span>Dedup & Growth</span>
    </div>
    <div class="nav-item" :class="{active: view==='schedules'}" @click="go('schedules')">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/><path d="M8 14h.01"/><path d="M12 14h.01"/><path d="M16 14h.01"/><path d="M8 18h.01"/><path d="M12 18h.01"/></svg>
      <span>Schedules</span>
    </div>
    <div class="nav-item" :class="{active: view==='explorer'}" @click="go('explorer')">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><ellipse cx="12" cy="5" rx="9" ry="3"/><path d="M21 12c0 1.66-4 3-9 3s-9-1.34-9-3"/><path d="M3 5v14c0 1.66 4 3 9 3s9-1.34 9-3V5"/></svg>
      <span>DB Explorer</span>
    </div>
    <div class="nav-item" :class="{active: view==='sql'}" @click="go('sql')">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="16 18 22 12 16 6"/><polyline points="8 6 2 12 8 18"/></svg>
      <span>SQL Console</span>
    </div>
  </nav>
  <div class="sidebar-footer">
    <div class="db-size" x-text="dbSizeLabel"></div>
    v2.0 &middot; Port 8899
  </div>
</aside>

<!-- ── Main ─────────────────────────────────────────────────── -->
<div class="main">

<!-- ══════════════════════════════════════════════════════════════
     VIEW: OVERVIEW
     ══════════════════════════════════════════════════════════════ -->
<div x-show="view==='overview'" x-transition.opacity>
  <div class="page-header">
    <div class="page-title">Overview</div>
    <div style="display:flex;align-items:center;gap:12px">
      <span class="pill" :class="llmStatus?.available ? 'pill-success' : 'pill-fail'"
            x-text="llmStatus?.available ? 'LLM online' : 'LLM offline'"
            :title="llmStatus?.available ? llmStatus.models.join(', ') : 'LLM server not reachable at ' + llmStatus?.url">
      </span>
      <div class="last-updated" x-text="'Updated ' + timeAgo(lastFetch)"></div>
    </div>
  </div>

  <div class="cards">
    <div class="card">
      <div class="card-icon blue"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M20 7H4a2 2 0 00-2 2v10a2 2 0 002 2h16a2 2 0 002-2V9a2 2 0 00-2-2z"/><path d="M16 7V5a2 2 0 00-2-2h-4a2 2 0 00-2 2v2"/></svg></div>
      <div class="card-label">Total Jobs</div>
      <div class="card-value" x-text="fmt(ov.total_results)"></div>
    </div>
    <div class="card">
      <div class="card-icon purple"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/><circle cx="12" cy="12" r="3"/></svg></div>
      <div class="card-label">URLs Seen</div>
      <div class="card-value" x-text="fmt(ov.total_seen)"></div>
    </div>
    <div class="card">
      <div class="card-icon green"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg></div>
      <div class="card-label">Today</div>
      <div class="card-value" x-text="fmt(ov.jobs_today)"></div>
    </div>
    <div class="card">
      <div class="card-icon cyan"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M16 21v-2a4 4 0 00-4-4H5a4 4 0 00-4 4v2"/><circle cx="8.5" cy="7" r="4"/><polyline points="17 11 19 13 23 9"/></svg></div>
      <div class="card-label">Dedup Ratio</div>
      <div class="card-value" x-text="ov.dedup_ratio != null ? (ov.dedup_ratio * 100).toFixed(1) + '%' : '—'"></div>
      <div class="card-sub">results / seen</div>
    </div>
    <div class="card">
      <div class="card-icon amber"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg></div>
      <div class="card-label">Last Run</div>
      <div class="card-value" style="font-size:1.1rem" x-text="ov.last_run ? timeAgo(ov.last_run.timestamp) : '—'"></div>
      <div class="card-sub">
        <span class="pill" :class="ov.last_run ? 'pill-'+ov.last_run.status : ''" x-text="ov.last_run?.status ?? ''"></span>
      </div>
    </div>
    <div class="card">
      <div class="card-icon red"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><ellipse cx="12" cy="5" rx="9" ry="3"/><path d="M21 12c0 1.66-4 3-9 3s-9-1.34-9-3"/><path d="M3 5v14c0 1.66 4 3 9 3s9-1.34 9-3V5"/></svg></div>
      <div class="card-label">DB Size</div>
      <div class="card-value" style="font-size:1.1rem" x-text="fmtBytes(ov.db_size)"></div>
    </div>
  </div>

  <!-- Run health strip -->
  <div class="health-strip" x-show="ov.run_health && ov.run_health.length > 0">
    <span class="health-strip-label">Last 20 Runs</span>
    <template x-for="rh in (ov.run_health || []).slice().reverse()" :key="rh.run_id">
      <div class="health-block" :class="rh.status === 'complete' ? 'success' : (rh.status === 'running' ? 'running' : 'failed')">
        <div class="health-block-tooltip" x-text="rh.status + ' — ' + timeAgo(rh.started_at)"></div>
      </div>
    </template>
  </div>

  <div class="chart-container">
    <div class="chart-title">Cumulative Growth</div>
    <canvas id="growthChart" style="max-height:300px"></canvas>
  </div>

  <div class="chart-container">
    <div class="chart-title">Daily Discovery (Last 30 Days)</div>
    <canvas id="trendChart"></canvas>
  </div>

  <div class="chart-row">
    <div class="chart-container">
      <div class="chart-title">By Board</div>
      <canvas id="boardChart"></canvas>
    </div>
    <div class="chart-container">
      <div class="chart-title">By Seniority</div>
      <canvas id="seniorityChart"></canvas>
    </div>
  </div>
</div>

<!-- ══════════════════════════════════════════════════════════════
     VIEW: JOBS
     ══════════════════════════════════════════════════════════════ -->
<div x-show="view==='jobs'" x-transition.opacity>
  <div class="page-header">
    <div class="page-title">Jobs</div>
    <div class="pagination-info" x-text="jobs.total + ' total results'"></div>
  </div>

  <div class="panel">
    <div class="filters">
      <select x-model="jf.board" @change="jPage=1;fetchJobs()">
        <option value="">All Boards</option>
        <template x-for="b in boards"><option :value="b" x-text="b"></option></template>
      </select>
      <select x-model="jf.seniority" @change="jPage=1;fetchJobs()">
        <option value="">All Seniority</option>
        <template x-for="s in seniorities"><option :value="s" x-text="s"></option></template>
      </select>
      <input type="text" placeholder="Search titles..." x-model.debounce.300ms="jf.search" @input="jPage=1;fetchJobs()" style="min-width:160px">
      <input type="text" placeholder="Search URLs..." x-model.debounce.300ms="jf.url_search" @input="jPage=1;fetchJobs()" style="min-width:160px">
      <select x-model="jf.run_id" @change="jPage=1;fetchJobs()">
        <option value="">All Runs</option>
        <template x-for="r in runIds"><option :value="r" x-text="r.slice(0,12) + '...'"></option></template>
      </select>
      <input type="date" x-model="jf.date_from" @change="jPage=1;fetchJobs()">
      <input type="date" x-model="jf.date_to" @change="jPage=1;fetchJobs()">
      <button class="btn btn-ghost btn-sm" @click="clearJobFilters()">Clear</button>
    </div>

    <!-- Bulk stats bar -->
    <div class="stats-bar" x-show="jobs.items.length > 0">
      <span>Showing <strong x-text="jobs.items.length"></strong> of <strong x-text="jobs.total"></strong></span>
      <span x-text="jobStatsBar"></span>
    </div>

    <div x-show="jobsLoading" class="loading"><div class="spinner"></div></div>

    <template x-if="!jobsLoading && jobs.items.length === 0">
      <div class="empty"><div class="empty-icon">&#128270;</div><div class="empty-text">No jobs match your filters</div></div>
    </template>

    <table x-show="!jobsLoading && jobs.items.length > 0">
      <thead>
        <tr>
          <th @click="toggleSort('title')" :class="{sorted: jSort.by==='title'}">Title <span class="sort-arrow" x-text="jSort.by==='title'?(jSort.dir==='asc'?'&#9650;':'&#9660;'):'&#9660;'"></span></th>
          <th @click="toggleSort('board')" :class="{sorted: jSort.by==='board'}">Board <span class="sort-arrow" x-text="jSort.by==='board'?(jSort.dir==='asc'?'&#9650;':'&#9660;'):'&#9660;'"></span></th>
          <th @click="toggleSort('seniority')" :class="{sorted: jSort.by==='seniority'}">Seniority <span class="sort-arrow" x-text="jSort.by==='seniority'?(jSort.dir==='asc'?'&#9650;':'&#9660;'):'&#9660;'"></span></th>
          <th @click="toggleSort('experience_years')" :class="{sorted: jSort.by==='experience_years'}">Exp <span class="sort-arrow" x-text="jSort.by==='experience_years'?(jSort.dir==='asc'?'&#9650;':'&#9660;'):'&#9660;'"></span></th>
          <th @click="toggleSort('salary_k')" :class="{sorted: jSort.by==='salary_k'}">Salary <span class="sort-arrow" x-text="jSort.by==='salary_k'?(jSort.dir==='asc'?'&#9650;':'&#9660;'):'&#9660;'"></span></th>
          <th @click="toggleSort('created_at')" :class="{sorted: jSort.by==='created_at'}">Date <span class="sort-arrow" x-text="jSort.by==='created_at'?(jSort.dir==='asc'?'&#9650;':'&#9660;'):'&#9660;'"></span></th>
          <th style="width:40px"></th>
        </tr>
      </thead>
      <tbody>
        <template x-for="job in jobs.items" :key="job.id">
          <tr>
            <td>
              <div @click="toggleJob(job.id)" style="cursor:pointer">
                <div style="font-weight:600;max-width:400px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap">
                  <span x-text="job.title"></span>
                  <span class="pill pill-new" x-show="job.run_id === jobs.latest_run_id">NEW</span>
                </div>
                <div style="font-size:.8rem;color:var(--text-secondary);max-width:400px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap" x-text="job.snippet"></div>
              </div>
              <!-- Expanded detail -->
              <template x-if="expandedId === job.id">
                <div class="job-detail" @click.stop>
                  <div style="margin-bottom:8px"><strong>URL:</strong> <a :href="job.url" target="_blank" x-text="job.url"></a></div>
                  <div style="margin-bottom:8px"><strong>Query:</strong> <span x-text="job.query" style="color:var(--text-secondary)"></span></div>
                  <div style="margin-bottom:8px"><strong>Run:</strong> <span x-text="job.run_id" style="color:var(--text-secondary)"></span></div>
                  <div style="margin-bottom:8px" x-show="expandedDetail?.salary_k"><strong>Salary:</strong> <span x-text="expandedDetail?.salary_k ? '$' + Math.round(expandedDetail.salary_k/1000) + 'K' : ''" style="color:var(--green);font-weight:600"></span></div>

                  <template x-if="expandedDetail">
                    <div>
                      <div class="verdicts">
                        <div style="font-weight:600;margin-bottom:8px">Filter Verdicts</div>
                        <template x-for="v in expandedDetail.filter_verdicts">
                          <div class="verdict-step">
                            <div class="verdict-dot"
                                 :class="v.stage==='llm_review' ? 'llm' : (v.passed?'pass':'fail')"
                                 x-text="v.stage==='llm_review' ? '&#129504;' : (v.passed?'&#10003;':'&#10007;')">
                            </div>
                            <div>
                              <div class="verdict-stage"
                                   :style="v.stage==='llm_review' ? 'color:var(--purple)' : ''"
                                   x-text="v.stage==='llm_review' ? 'AI Review' : v.stage">
                              </div>
                              <div class="verdict-reason" x-text="v.reason"></div>
                            </div>
                          </div>
                        </template>
                      </div>
                      <template x-if="expandedDetail.jd_text">
                        <div>
                          <div style="font-weight:600;margin-top:16px;margin-bottom:4px">Job Description</div>
                          <div class="jd-text" x-text="expandedDetail.jd_text"></div>
                        </div>
                      </template>
                    </div>
                  </template>
                  <template x-if="!expandedDetail">
                    <div class="loading" style="padding:16px"><div class="spinner"></div></div>
                  </template>
                </div>
              </template>
            </td>
            <td><span class="pill" :class="'pill-'+job.board" x-text="job.board"></span></td>
            <td><span class="pill" :class="'pill-'+job.seniority" x-text="job.seniority"></span></td>
            <td x-text="job.experience_years ?? '—'"></td>
            <td x-text="job.salary_k ? '$' + Math.round(job.salary_k/1000) + 'K' : '—'" style="white-space:nowrap;color:var(--text)" :style="job.salary_k ? 'font-weight:600' : ''"></td>
            <td style="white-space:nowrap" x-text="fmtDate(job.created_at)"></td>
            <td><a :href="job.url" target="_blank" class="ext-link" title="Open job posting"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M18 13v6a2 2 0 01-2 2H5a2 2 0 01-2-2V8a2 2 0 012-2h6"/><polyline points="15 3 21 3 21 9"/><line x1="10" y1="14" x2="21" y2="3"/></svg></a></td>
          </tr>
        </template>
      </tbody>
    </table>

    <div class="pagination" x-show="jobs.pages > 0">
      <div class="pagination-info" x-text="'Page ' + jPage + ' of ' + jobs.pages"></div>
      <div class="pagination-controls">
        <select x-model="jPerPage" @change="jPage=1;fetchJobs()" style="padding:4px 8px;border:1px solid var(--border);border-radius:6px;font-size:.85rem">
          <option value="25">25</option><option value="50">50</option><option value="100">100</option>
        </select>
        <button :disabled="jPage<=1" @click="jPage--;fetchJobs()">Prev</button>
        <span class="page-num" x-text="jPage + ' / ' + jobs.pages"></span>
        <button :disabled="jPage>=jobs.pages" @click="jPage++;fetchJobs()">Next</button>
      </div>
    </div>
  </div>
</div>

<!-- ══════════════════════════════════════════════════════════════
     VIEW: REJECTED
     ══════════════════════════════════════════════════════════════ -->
<div x-show="view==='rejected'" x-transition.opacity>
  <div class="page-header">
    <div class="page-title">Rejected Jobs</div>
    <div style="font-size:.85rem;color:var(--text-secondary)" x-text="(rejectedStats?.total || 0).toLocaleString() + ' total rejections'"></div>
  </div>

  <!-- Stage breakdown strip -->
  <div class="panel" style="margin-bottom:24px" x-show="rejectedStats">
    <div class="panel-header"><div class="panel-title">Rejection Breakdown by Stage</div><div style="font-size:.8rem;color:var(--text-secondary)">Click to filter</div></div>
    <div style="padding:14px 20px;display:flex;gap:8px;flex-wrap:wrap;align-items:center">
      <span class="pill" style="cursor:pointer;font-size:.82rem;padding:4px 12px"
            :class="rf.stage===''?'pill-running':'pill-unknown'"
            @click="rf.stage='';rPage=1;fetchRejected()"
            x-text="'All (' + (rejectedStats?.total||0) + ')'"></span>
      <template x-for="[stage, cnt] in Object.entries(rejectedStats?.by_stage||{})" :key="stage">
        <span class="pill" style="cursor:pointer;font-size:.82rem;padding:4px 12px"
              :class="rf.stage===stage ? 'pill-running' : ('pill-stage-'+stage)"
              @click="rf.stage=stage;rPage=1;fetchRejected()"
              x-text="stage + ' (' + cnt + ')'"></span>
      </template>
    </div>
  </div>

  <div class="panel">
    <div class="filters">
      <select x-model="rf.stage" @change="rPage=1;fetchRejected()">
        <option value="">All Stages</option>
        <template x-for="s in rejectedStages"><option :value="s" x-text="s"></option></template>
      </select>
      <select x-model="rf.run_id" @change="rPage=1;fetchRejected()">
        <option value="">All Runs</option>
        <template x-for="r in runIds"><option :value="r" x-text="r.slice(0,12)+'...'"></option></template>
      </select>
      <input type="text" placeholder="Search titles..." x-model.debounce.300ms="rf.search" @input="rPage=1;fetchRejected()" style="min-width:180px">
      <button class="btn btn-ghost btn-sm" @click="rf={stage:'',run_id:'',search:''};rPage=1;fetchRejected()">Clear</button>
    </div>

    <div class="stats-bar" x-show="rejected.total > 0">
      <span>Showing <strong x-text="rejected.items.length"></strong> of <strong x-text="rejected.total"></strong></span>
    </div>

    <div x-show="rejectedLoading" class="loading"><div class="spinner"></div></div>

    <template x-if="!rejectedLoading && rejected.items.length === 0">
      <div class="empty"><div class="empty-icon">&#10004;</div><div class="empty-text">No rejections match your filters</div></div>
    </template>

    <table x-show="!rejectedLoading && rejected.items.length > 0">
      <thead>
        <tr>
          <th>Title</th>
          <th>Board</th>
          <th>Rejected At</th>
          <th>Reason</th>
          <th>Date</th>
          <th style="width:40px"></th>
        </tr>
      </thead>
      <tbody>
        <template x-for="job in rejected.items" :key="job.id">
          <tr>
            <td>
              <div @click="toggleRejected(job.id)" style="cursor:pointer">
                <div style="font-weight:600;max-width:380px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap" x-text="job.title"></div>
                <div style="font-size:.8rem;color:var(--text-secondary);max-width:380px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap" x-text="job.snippet"></div>
              </div>
              <!-- Expanded detail -->
              <template x-if="expandedRejectedId === job.id">
                <div class="job-detail" @click.stop>
                  <div style="margin-bottom:8px"><strong>URL:</strong> <a :href="job.url" target="_blank" x-text="job.url"></a></div>
                  <div style="margin-bottom:8px"><strong>Run:</strong> <span x-text="job.run_id" style="color:var(--text-secondary)"></span></div>
                  <template x-if="expandedRejectedDetail">
                    <div class="verdicts" style="margin-top:8px">
                      <div style="font-weight:600;margin-bottom:8px">Filter Verdicts</div>
                      <template x-for="v in expandedRejectedDetail.filter_verdicts">
                        <div class="verdict-step">
                          <div class="verdict-dot"
                               :class="v.stage==='llm_review' ? 'llm' : (v.passed?'pass':'fail')"
                               x-text="v.stage==='llm_review' ? '&#129504;' : (v.passed?'&#10003;':'&#10007;')">
                          </div>
                          <div>
                            <div class="verdict-stage"
                                 :style="v.stage==='llm_review' ? 'color:var(--purple)' : (!v.passed ? 'color:var(--red)' : '')"
                                 x-text="v.stage==='llm_review' ? 'AI Review' : v.stage">
                            </div>
                            <div class="verdict-reason" x-text="v.reason"></div>
                          </div>
                        </div>
                      </template>
                    </div>
                  </template>
                  <template x-if="!expandedRejectedDetail">
                    <div class="loading" style="padding:12px"><div class="spinner"></div></div>
                  </template>
                </div>
              </template>
            </td>
            <td><span class="pill" :class="'pill-'+job.board" x-text="job.board"></span></td>
            <td><span class="pill" :class="'pill-stage-'+job.rejection_stage" x-text="job.rejection_stage"></span></td>
            <td style="font-size:.82rem;color:var(--text-secondary);max-width:280px;word-break:break-word" x-text="job.rejection_reason"></td>
            <td style="white-space:nowrap" x-text="fmtDate(job.created_at)"></td>
            <td><a :href="job.url" target="_blank" class="ext-link" title="Open URL"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M18 13v6a2 2 0 01-2 2H5a2 2 0 01-2-2V8a2 2 0 012-2h6"/><polyline points="15 3 21 3 21 9"/><line x1="10" y1="14" x2="21" y2="3"/></svg></a></td>
          </tr>
        </template>
      </tbody>
    </table>

    <div class="pagination" x-show="rejected.pages > 1">
      <div class="pagination-info" x-text="'Page ' + rPage + ' of ' + rejected.pages + ' (' + rejected.total + ' total)'"></div>
      <div class="pagination-controls">
        <select x-model="rPerPage" @change="rPage=1;fetchRejected()" style="padding:4px 8px;border:1px solid var(--border);border-radius:6px;font-size:.85rem">
          <option value="50">50</option><option value="100">100</option><option value="200">200</option>
        </select>
        <button :disabled="rPage<=1" @click="rPage--;fetchRejected()">Prev</button>
        <span class="page-num" x-text="rPage + ' / ' + rejected.pages"></span>
        <button :disabled="rPage>=rejected.pages" @click="rPage++;fetchRejected()">Next</button>
      </div>
    </div>
  </div>
</div>

<!-- ══════════════════════════════════════════════════════════════
     VIEW: RUNS
     ══════════════════════════════════════════════════════════════ -->
<div x-show="view==='runs'" x-transition.opacity>
  <div class="page-header">
    <div class="page-title">Run History</div>
    <div style="display:flex;align-items:center;gap:8px">
      <span class="status-dot" :class="isActive?'active':'idle'"></span>
      <span style="font-size:.9rem" x-text="isActive?'Scrape running...':'Idle'"></span>
    </div>
  </div>

  <!-- Run stats -->
  <div class="cards" style="margin-bottom:24px" x-show="runStats">
    <div class="card">
      <div class="card-label">Avg Duration</div>
      <div class="card-value" style="font-size:1.3rem" x-text="runStats ? fmtDuration(runStats.avg_duration) : '—'"></div>
    </div>
    <div class="card">
      <div class="card-label">Success Rate</div>
      <div class="card-value" style="font-size:1.3rem" x-text="runStats ? runStats.success_rate + '%' : '—'"></div>
    </div>
    <div class="card">
      <div class="card-label">Avg Jobs/Run</div>
      <div class="card-value" style="font-size:1.3rem" x-text="runStats ? runStats.avg_jobs_per_run : '—'"></div>
    </div>
    <div class="card">
      <div class="card-label">Total Runs</div>
      <div class="card-value" style="font-size:1.3rem" x-text="runStats ? runStats.total_runs : '—'"></div>
    </div>
  </div>

  <!-- Timeline visualization -->
  <div class="chart-container" x-show="runs.length > 0">
    <div class="chart-title">Run Duration Timeline</div>
    <canvas id="runTimelineChart" style="max-height:200px"></canvas>
  </div>

  <div class="panel">
    <div x-show="runsLoading" class="loading"><div class="spinner"></div></div>
    <table x-show="!runsLoading">
      <thead>
        <tr>
          <th>Time</th>
          <th>Duration</th>
          <th>Status</th>
          <th>Pipeline</th>
          <th>Stored</th>
          <th>Run ID</th>
        </tr>
      </thead>
      <tbody>
        <template x-for="run in runs" :key="run.run_id">
          <tr>
            <td>
              <div style="white-space:nowrap;cursor:pointer" @click="toggleRunExpand(run.run_id)">
                <span x-text="fmtDate(run.started_at)"></span>
                <span style="font-size:.8rem;color:var(--accent);margin-left:4px" x-text="expandedRunId === run.run_id ? '&#9660;' : '&#9654;'"></span>
              </div>
              <!-- Run drill-down -->
              <template x-if="expandedRunId === run.run_id">
                <div style="margin-top:12px">
                  <!-- Errors -->
                  <template x-if="run.errors && run.errors.length > 0">
                    <div class="error-panel">
                      <div class="error-panel-title">Errors (<span x-text="run.errors.length"></span>)</div>
                      <template x-for="err in run.errors">
                        <div class="error-item" x-text="err"></div>
                      </template>
                    </div>
                  </template>
                  <!-- Jobs from this run -->
                  <template x-if="expandedRunJobs !== null">
                    <div>
                      <div style="font-weight:600;margin-bottom:8px;font-size:.85rem" x-text="expandedRunJobs.length + ' jobs from this run'"></div>
                      <template x-if="expandedRunJobs.length > 0">
                        <table style="font-size:.85rem">
                          <thead><tr><th>Title</th><th>Board</th><th>Seniority</th></tr></thead>
                          <tbody>
                            <template x-for="rj in expandedRunJobs.slice(0,20)" :key="rj.id">
                              <tr>
                                <td><a :href="rj.url" target="_blank" x-text="rj.title" style="font-size:.85rem"></a></td>
                                <td><span class="pill" :class="'pill-'+rj.board" x-text="rj.board"></span></td>
                                <td><span class="pill" :class="'pill-'+rj.seniority" x-text="rj.seniority"></span></td>
                              </tr>
                            </template>
                          </tbody>
                        </table>
                      </template>
                      <template x-if="expandedRunJobs.length > 20">
                        <div style="padding:8px 0;font-size:.8rem;color:var(--text-secondary)" x-text="'+ ' + (expandedRunJobs.length - 20) + ' more...'"></div>
                      </template>
                    </div>
                  </template>
                  <template x-if="expandedRunJobs === null && expandedRunId === run.run_id">
                    <div class="loading" style="padding:12px"><div class="spinner"></div></div>
                  </template>
                </div>
              </template>
            </td>
            <td x-text="run.elapsed != null ? fmtDuration(run.elapsed) : '—'"></td>
            <td><span class="pill" :class="run.status==='complete'?'pill-success':(run.status==='running'?'pill-running':'pill-fail')" x-text="run.status"></span></td>
            <td>
              <div class="run-flow">
                <span x-text="run.raw_count ?? '—'"></span>
                <span class="arrow">&#8594;</span>
                <span x-text="run.dedup_count ?? '—'"></span>
                <span class="arrow">&#8594;</span>
                <strong x-text="run.filtered_count ?? '—'"></strong>
              </div>
            </td>
            <td style="font-weight:600" x-text="run.job_count ?? '—'"></td>
            <td style="font-size:.8rem;color:var(--text-secondary)" x-text="run.run_id.slice(0,12) + '...'"></td>
          </tr>
        </template>
      </tbody>
    </table>

    <div class="pagination" x-show="runPages > 1">
      <div class="pagination-info" x-text="'Page ' + runPage + ' of ' + runPages"></div>
      <div class="pagination-controls">
        <button :disabled="runPage<=1" @click="runPage--;fetchRuns()">Prev</button>
        <span class="page-num" x-text="runPage + ' / ' + runPages"></span>
        <button :disabled="runPage>=runPages" @click="runPage++;fetchRuns()">Next</button>
      </div>
    </div>
  </div>
</div>

<!-- ══════════════════════════════════════════════════════════════
     VIEW: DEDUP & GROWTH
     ══════════════════════════════════════════════════════════════ -->
<div x-show="view==='dedup'" x-transition.opacity>
  <div class="page-header">
    <div class="page-title">Dedup & Growth</div>
  </div>

  <!-- Dedup funnel -->
  <div class="chart-container">
    <div class="chart-title">Dedup Funnel</div>
    <div class="funnel" x-show="dedupData">
      <div class="funnel-step">
        <div class="funnel-label">URLs Seen</div>
        <div class="funnel-bar" style="background:var(--purple)" :style="'width:100%'" x-text="fmt(dedupData?.total_seen)"></div>
      </div>
      <div class="funnel-arrow">&#8595;</div>
      <div class="funnel-step">
        <div class="funnel-label">Passed Filters</div>
        <div class="funnel-bar" style="background:var(--accent)" :style="'width:' + (dedupData ? Math.max(5, dedupData.total_results / dedupData.total_seen * 100) : 5) + '%'" x-text="fmt(dedupData?.total_results)"></div>
      </div>
    </div>
  </div>

  <!-- Repeat URL frequency -->
  <div class="chart-row">
    <div class="chart-container">
      <div class="chart-title">URL Frequency Distribution</div>
      <canvas id="repeatChart"></canvas>
    </div>
    <div class="chart-container">
      <div class="chart-title">Daily Uniqueness Rate</div>
      <canvas id="uniquenessChart"></canvas>
    </div>
  </div>

  <!-- Daily new URLs chart -->
  <div class="chart-container">
    <div class="chart-title">Daily New Jobs Stored</div>
    <canvas id="dailyNewChart" style="max-height:260px"></canvas>
  </div>

  <!-- Filter analytics (moved from old Filters view) -->
  <div class="cards" style="margin-bottom:24px">
    <div class="card">
      <div class="card-label">Avg Pass Rate</div>
      <div class="card-value" x-text="passRate"></div>
      <div class="card-sub">filtered / dedup across runs</div>
    </div>
    <div class="card">
      <div class="card-label">Total Passing Jobs</div>
      <div class="card-value" x-text="fmt(ov.total_results)"></div>
    </div>
  </div>

  <div class="chart-container">
    <div class="chart-title">Top Matching Keywords (Passing Jobs)</div>
    <canvas id="filterChart"></canvas>
  </div>

  <div class="panel" style="margin-top:24px">
    <div class="panel-header"><div class="panel-title">Verdict Breakdown by Stage</div></div>
    <template x-for="stage in filterStages" :key="stage.stage">
      <div style="padding:12px 20px;border-bottom:1px solid var(--border)">
        <div style="font-weight:600;margin-bottom:6px" x-text="stage.stage"></div>
        <template x-for="r in stage.reasons.slice(0,5)" :key="r.reason">
          <div style="display:flex;align-items:center;gap:8px;padding:2px 0;font-size:.85rem">
            <div style="min-width:32px;text-align:right;font-weight:600;color:var(--accent)" x-text="r.count"></div>
            <div style="flex:1;color:var(--text-secondary)" x-text="r.reason"></div>
            <div style="width:120px;height:6px;background:var(--border);border-radius:3px;overflow:hidden">
              <div style="height:100%;border-radius:3px;background:var(--accent)" :style="'width:'+Math.round(r.count/stage.total*100)+'%'"></div>
            </div>
          </div>
        </template>
      </div>
    </template>
  </div>
</div>

<!-- ══════════════════════════════════════════════════════════════
     VIEW: SCHEDULES
     ══════════════════════════════════════════════════════════════ -->
<div x-show="view==='schedules'" x-transition.opacity>
  <div class="page-header">
    <div class="page-title">Scheduled Jobs</div>
    <button class="btn btn-ghost btn-sm" @click="fetchSchedules()">Refresh</button>
  </div>

  <div class="cards" style="margin-bottom:24px">
    <div class="card">
      <div class="card-icon green"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M22 11.08V12a10 10 0 11-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></svg></div>
      <div class="card-label">Loaded</div>
      <div class="card-value" x-text="schedJobs.filter(j => j.loaded).length"></div>
    </div>
    <div class="card">
      <div class="card-icon red"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><line x1="15" y1="9" x2="9" y2="15"/><line x1="9" y1="9" x2="15" y2="15"/></svg></div>
      <div class="card-label">Not Loaded</div>
      <div class="card-value" x-text="schedJobs.filter(j => !j.loaded).length"></div>
    </div>
    <div class="card">
      <div class="card-icon blue"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 2v4M12 18v4M4.93 4.93l2.83 2.83M16.24 16.24l2.83 2.83M2 12h4M18 12h4M4.93 19.07l2.83-2.83M16.24 7.76l2.83-2.83"/></svg></div>
      <div class="card-label">Running Now</div>
      <div class="card-value" x-text="schedJobs.filter(j => j.running).length"></div>
    </div>
    <div class="card">
      <div class="card-icon amber"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M10.29 3.86L1.82 18a2 2 0 001.71 3h16.94a2 2 0 001.71-3L13.71 3.86a2 2 0 00-3.42 0z"/><line x1="12" y1="9" x2="12" y2="13"/><line x1="12" y1="17" x2="12.01" y2="17"/></svg></div>
      <div class="card-label">Last Exit != 0</div>
      <div class="card-value" x-text="schedJobs.filter(j => j.loaded && j.last_exit !== 0 && j.last_exit !== null).length"></div>
    </div>
  </div>

  <div x-show="schedLoading" class="loading"><div class="spinner"></div></div>

  <template x-if="!schedLoading && schedJobs.length === 0">
    <div class="empty"><div class="empty-icon">&#128197;</div><div class="empty-text">No launchd agents found</div></div>
  </template>

  <template x-for="job in schedJobs" :key="job.label">
    <div class="sched-card" :class="job.running ? 'running-now' : (job.loaded ? 'loaded' : 'not-loaded')">
      <div class="sched-header" @click="toggleSchedExpand(job.label)">
        <div>
          <div class="sched-label" x-text="job.label"></div>
          <div style="font-size:.8rem;color:var(--text-secondary);margin-top:2px" x-text="job.schedule || 'No schedule'"></div>
        </div>
        <div class="sched-meta">
          <span class="pill" :class="job.running ? 'pill-running' : (job.loaded ? 'pill-success' : 'pill-fail')"
                x-text="job.running ? 'Running' : (job.loaded ? 'Loaded' : 'Not Loaded')"></span>
          <template x-if="job.last_exit !== null && job.last_exit !== undefined">
            <span class="pill" :class="job.last_exit === 0 ? 'pill-success' : 'pill-fail'" x-text="'Exit: ' + job.last_exit"></span>
          </template>
          <span style="font-size:.8rem" x-text="schedExpandedId === job.label ? '&#9660;' : '&#9654;'"></span>
        </div>
      </div>

      <template x-if="schedExpandedId === job.label">
        <div class="sched-detail">
          <div class="sched-field">
            <div class="sched-field-label">Command</div>
            <div class="sched-field-value" x-text="job.command"></div>
          </div>
          <div class="sched-field">
            <div class="sched-field-label">Working Dir</div>
            <div class="sched-field-value" x-text="job.working_dir || '—'"></div>
          </div>
          <div class="sched-field">
            <div class="sched-field-label">Schedule</div>
            <div class="sched-field-value" x-text="(job.schedule || 'None') + (job.interval_seconds ? ' (' + job.interval_seconds + 's)' : '')"></div>
          </div>
          <div class="sched-field">
            <div class="sched-field-label">Run at Load</div>
            <div class="sched-field-value" x-text="job.run_at_load ? 'Yes' : 'No'"></div>
          </div>
          <div class="sched-field">
            <div class="sched-field-label">PID</div>
            <div class="sched-field-value" x-text="job.pid ?? '—'"></div>
          </div>
          <div class="sched-field">
            <div class="sched-field-label">Last Exit</div>
            <div class="sched-field-value">
              <span :style="job.last_exit !== 0 && job.last_exit !== null ? 'color:var(--red);font-weight:600' : ''" x-text="job.last_exit ?? '—'"></span>
            </div>
          </div>
          <div class="sched-field">
            <div class="sched-field-label">Log File</div>
            <div class="sched-field-value" x-text="job.log_path || 'None'"></div>
          </div>
          <div class="sched-field" x-show="job.log_size > 0">
            <div class="sched-field-label">Log Size</div>
            <div class="sched-field-value" x-text="fmtBytes(job.log_size)"></div>
          </div>
          <div class="sched-field">
            <div class="sched-field-label">Plist Path</div>
            <div class="sched-field-value" x-text="job.plist_path"></div>
          </div>

          <!-- Log viewer -->
          <template x-if="job.log_path">
            <div>
              <div class="log-controls">
                <button class="btn btn-sm btn-primary" @click="fetchSchedLog(job.label)"
                  x-text="schedLogData[job.label] ? 'Refresh Log' : 'View Log'"></button>
                <select x-model="schedLogLines" @change="if(schedLogData[job.label]) fetchSchedLog(job.label)"
                  style="padding:4px 8px;border:1px solid var(--border);border-radius:6px;font-size:.8rem">
                  <option value="50">50 lines</option>
                  <option value="100">100 lines</option>
                  <option value="300">300 lines</option>
                  <option value="500">500 lines</option>
                </select>
                <span style="font-size:.8rem;color:var(--text-secondary)" x-show="schedLogData[job.label]"
                  x-text="schedLogData[job.label] ? 'Showing last ' + schedLogData[job.label].lines.length + ' of ' + schedLogData[job.label].total_lines + ' lines' : ''">
                </span>
              </div>
              <template x-if="schedLogData[job.label]">
                <div class="log-viewer" x-ref="logViewer">
                  <template x-for="(line, li) in schedLogData[job.label].lines" :key="li">
                    <div class="log-line" x-text="line"></div>
                  </template>
                </div>
              </template>
            </div>
          </template>
        </div>
      </template>
    </div>
  </template>
</div>

<!-- ══════════════════════════════════════════════════════════════
     VIEW: DB EXPLORER
     ══════════════════════════════════════════════════════════════ -->
<div x-show="view==='explorer'" x-transition.opacity>
  <div class="page-header">
    <div class="page-title">DB Explorer</div>
    <button class="btn btn-ghost btn-sm" @click="copyExplorerJSON()" x-show="explorerData.items.length > 0">Copy as JSON</button>
  </div>

  <div class="panel">
    <div class="filters">
      <select x-model="explorerTable" @change="explorerPage=1;fetchExplorerData()">
        <template x-for="t in dbTables" :key="t.name">
          <option :value="t.name" x-text="t.name + ' (' + t.row_count + ' rows)'"></option>
        </template>
      </select>
      <select x-model="explorerPerPage" @change="explorerPage=1;fetchExplorerData()">
        <option value="50">50 rows</option>
        <option value="100">100 rows</option>
        <option value="200">200 rows</option>
      </select>
    </div>

    <div x-show="explorerLoading" class="loading"><div class="spinner"></div></div>

    <div style="overflow-x:auto" x-show="!explorerLoading && explorerData.items.length > 0">
      <table>
        <thead>
          <tr>
            <template x-for="col in explorerData.columns" :key="col">
              <th @click="toggleExplorerSort(col)" :class="{sorted: explorerSort.by===col}">
                <span x-text="col"></span>
                <span class="sort-arrow" x-text="explorerSort.by===col?(explorerSort.dir==='asc'?'&#9650;':'&#9660;'):'&#9660;'"></span>
              </th>
            </template>
          </tr>
          <!-- Column filters -->
          <tr style="background:#fafbfc">
            <template x-for="col in explorerData.columns" :key="'f-'+col">
              <th style="padding:4px 8px">
                <input class="col-filter" type="text" placeholder="Filter..."
                  x-model.debounce.300ms="explorerColFilters[col]"
                  @input="filterExplorerLocal()">
              </th>
            </template>
          </tr>
        </thead>
        <tbody>
          <template x-for="(row, idx) in explorerFiltered" :key="idx">
            <tr class="clickable-row" @click="openRowModal(row)">
              <template x-for="col in explorerData.columns" :key="col+'-'+idx">
                <td>
                  <div class="cell-truncate" x-text="formatCell(row[col])"></div>
                </td>
              </template>
            </tr>
          </template>
        </tbody>
      </table>
    </div>

    <template x-if="!explorerLoading && explorerData.items.length === 0">
      <div class="empty"><div class="empty-icon">&#128451;</div><div class="empty-text">No data in this table</div></div>
    </template>

    <div class="pagination" x-show="explorerData.pages > 1">
      <div class="pagination-info" x-text="'Page ' + explorerPage + ' of ' + explorerData.pages + ' (' + explorerData.total + ' rows)'"></div>
      <div class="pagination-controls">
        <button :disabled="explorerPage<=1" @click="explorerPage--;fetchExplorerData()">Prev</button>
        <span class="page-num" x-text="explorerPage + ' / ' + explorerData.pages"></span>
        <button :disabled="explorerPage>=explorerData.pages" @click="explorerPage++;fetchExplorerData()">Next</button>
      </div>
    </div>
  </div>

  <!-- Row detail modal -->
  <template x-if="rowModalData">
    <div class="modal-overlay" @click.self="rowModalData=null">
      <div class="modal">
        <div class="modal-header">
          <div class="panel-title">Row Detail</div>
          <button class="btn btn-ghost btn-sm" @click="rowModalData=null">Close</button>
        </div>
        <div class="modal-body">
          <template x-for="col in explorerData.columns" :key="'m-'+col">
            <div class="modal-field">
              <div class="modal-field-label" x-text="col"></div>
              <div class="modal-field-value" x-text="formatCellFull(rowModalData[col])"></div>
            </div>
          </template>
        </div>
      </div>
    </div>
  </template>
</div>

<!-- ══════════════════════════════════════════════════════════════
     VIEW: SQL CONSOLE
     ══════════════════════════════════════════════════════════════ -->
<div x-show="view==='sql'" x-transition.opacity>
  <div class="page-header">
    <div class="page-title">SQL Console</div>
    <div style="font-size:.8rem;color:var(--text-secondary)">Read-only &middot; SELECT only &middot; LIMIT 1000</div>
  </div>

  <!-- Preset queries -->
  <div class="preset-queries">
    <button class="preset-btn" @click="sqlText='SELECT * FROM runs ORDER BY started_at DESC LIMIT 10';runSQL()">Recent runs</button>
    <button class="preset-btn" @click="sqlText='SELECT * FROM results WHERE jd_text IS NULL OR jd_text = \\'\\' LIMIT 20';runSQL()">Jobs with no JD</button>
    <button class="preset-btn" @click="sqlText='SELECT * FROM runs WHERE errors != \\'[]\\'  AND errors IS NOT NULL ORDER BY started_at DESC LIMIT 10';runSQL()">Runs with errors</button>
    <button class="preset-btn" @click="sqlText='SELECT SUBSTR(url, 1, INSTR(SUBSTR(url, 9), \\'/\\') + 8) as domain, COUNT(*) as cnt FROM results GROUP BY domain ORDER BY cnt DESC LIMIT 20';runSQL()">Top domains</button>
    <button class="preset-btn" @click="sqlText='SELECT board, seniority, COUNT(*) as cnt FROM results GROUP BY board, seniority ORDER BY cnt DESC';runSQL()">Board x Seniority</button>
    <button class="preset-btn" @click="sqlText='SELECT date(created_at) as day, COUNT(*) as cnt FROM results GROUP BY day ORDER BY day DESC LIMIT 30';runSQL()">Daily counts</button>
    <button class="preset-btn" @click="sqlText='SELECT title, salary_k, seniority, board FROM results WHERE salary_k IS NOT NULL ORDER BY salary_k DESC LIMIT 25';runSQL()">Salary data</button>
  </div>

  <div class="panel">
    <div style="padding:16px 20px">
      <textarea class="sql-editor" x-model="sqlText" @keydown.meta.enter.prevent="runSQL()" @keydown.ctrl.enter.prevent="runSQL()" placeholder="Enter a SELECT query... (Cmd+Enter to run)"></textarea>
      <div style="display:flex;align-items:center;gap:12px;margin-top:8px">
        <button class="btn btn-primary" @click="runSQL()" :disabled="sqlRunning">
          <span x-show="!sqlRunning">Run Query</span>
          <span x-show="sqlRunning">Running...</span>
        </button>
        <div class="query-meta" x-show="sqlResult">
          <span x-text="sqlResult ? sqlResult.row_count + ' rows' : ''"></span>
          <span x-text="sqlResult ? ' in ' + sqlResult.elapsed_ms + 'ms' : ''"></span>
        </div>
        <div style="font-size:.85rem;color:var(--red)" x-show="sqlError" x-text="sqlError"></div>
      </div>
    </div>

    <!-- Query history -->
    <template x-if="sqlHistory.length > 0">
      <div style="border-top:1px solid var(--border)">
        <div style="padding:8px 20px;font-size:.8rem;font-weight:600;color:var(--text-secondary)">Recent Queries</div>
        <template x-for="(q, qi) in sqlHistory" :key="qi">
          <div class="query-history-item" @click="sqlText=q;runSQL()" x-text="q"></div>
        </template>
      </div>
    </template>
  </div>

  <!-- Results -->
  <div class="panel" x-show="sqlResult && sqlResult.rows.length > 0">
    <div style="overflow-x:auto">
      <table>
        <thead>
          <tr>
            <template x-for="col in sqlResult?.columns || []" :key="'sc-'+col">
              <th x-text="col"></th>
            </template>
          </tr>
        </thead>
        <tbody>
          <template x-for="(row, ri) in sqlResult?.rows || []" :key="'sr-'+ri">
            <tr>
              <template x-for="col in sqlResult?.columns || []" :key="'src-'+col+'-'+ri">
                <td><div class="cell-truncate" x-text="formatCell(row[col])"></div></td>
              </template>
            </tr>
          </template>
        </tbody>
      </table>
    </div>
  </div>
</div>

</div><!-- /.main -->

<script>
function dashboard() {
  return {
    view: 'overview',
    lastFetch: null,
    isActive: false,
    dbSizeLabel: '',
    llmStatus: null,

    // Overview
    ov: {},
    trendChart: null, boardChart: null, seniorityChart: null, growthChart: null,

    // Jobs
    jobs: {items:[],total:0,page:1,pages:0,latest_run_id:null},
    jf: {board:'',seniority:'',search:'',url_search:'',run_id:'',date_from:'',date_to:''},
    jSort: {by:'created_at',dir:'desc'},
    jPage: 1, jPerPage: 25,
    expandedId: null, expandedDetail: null,
    jobsLoading: false,
    boards: ['greenhouse','lever','ashby','workday','bamboohr','icims','smartrecruiters','unknown'],
    seniorities: ['junior','mid','senior','staff','principal','lead','manager','director','unknown'],
    runIds: [],

    // Rejected
    rejected: {items:[],total:0,pages:0},
    rejectedStats: null,
    rejectedStages: [],
    rf: {stage:'', run_id:'', search:''},
    rPage: 1, rPerPage: 50,
    rejectedLoading: false,
    expandedRejectedId: null, expandedRejectedDetail: null,

    // Runs
    runs: [], runsLoading: false,
    runStats: null, runPage: 1, runPages: 1,
    expandedRunId: null, expandedRunJobs: null,
    runTimelineChart: null,

    // Dedup & Growth
    dedupData: null, dedupLoaded: false,
    repeatChart: null, uniquenessChart: null, dailyNewChart: null,

    // Filters (moved to dedup view)
    filterStages: [], filterChart: null, passRate: '—',

    // DB Explorer
    dbTables: [], explorerTable: '',
    explorerData: {items:[],columns:[],total:0,page:1,pages:0},
    explorerPage: 1, explorerPerPage: 50,
    explorerSort: {by:null,dir:'asc'},
    explorerLoading: false,
    explorerColFilters: {},
    explorerFiltered: [],
    rowModalData: null,

    // Schedules
    schedJobs: [], schedLoading: false,
    schedExpandedId: null, schedLogData: {}, schedLogLines: '100',

    // SQL Console
    sqlText: '', sqlResult: null, sqlError: '', sqlRunning: false,
    sqlHistory: JSON.parse(localStorage.getItem('sqlHistory') || '[]'),

    init() {
      this.fetchOverview();
      this.fetchActiveRun();
      this.fetchRunIds();
      this.fetchLLMStatus();
      setInterval(() => {
        if (this.view === 'overview') this.fetchOverview();
        if (this.view === 'jobs') this.fetchJobs();
        if (this.view === 'runs') this.fetchRuns();
        if (this.view === 'dedup') { this.fetchDedupStats(); this.fetchFilterStats(); }
      }, 30000);
      setInterval(() => this.fetchActiveRun(), 10000);
      setInterval(() => this.fetchLLMStatus(), 60000);
    },

    go(v) {
      this.view = v;
      if (v === 'overview') this.fetchOverview();
      if (v === 'jobs' && this.jobs.items.length === 0) this.fetchJobs();
      if (v === 'rejected' && !this.rejectedStats) { this.fetchRejectedStats(); this.fetchRejected(); }
      if (v === 'runs' && this.runs.length === 0) this.fetchRuns();
      if (v === 'dedup' && !this.dedupLoaded) { this.fetchDedupStats(); this.fetchFilterStats(); }
      if (v === 'schedules' && this.schedJobs.length === 0) this.fetchSchedules();
      if (v === 'explorer' && this.dbTables.length === 0) this.fetchDBTables();
    },

    // ── Overview ────────────────────────────────────────────
    async fetchOverview() {
      try {
        const [ovRes, growthRes] = await Promise.all([
          fetch('/api/overview'),
          fetch('/api/growth'),
        ]);
        this.ov = await ovRes.json();
        this._growthData = await growthRes.json();
        this.lastFetch = new Date().toISOString();
        this.dbSizeLabel = this.fmtBytes(this.ov.db_size);
        this.$nextTick(() => {
          this.renderGrowthChart();
          this.renderTrendChart();
          this.renderBoardChart();
          this.renderSeniorityChart();
        });
      } catch(e) { console.error('overview', e); }
    },

    // ── Jobs ────────────────────────────────────────────────
    async fetchJobs() {
      this.jobsLoading = true;
      const p = new URLSearchParams({page:this.jPage,per_page:this.jPerPage,sort_by:this.jSort.by,sort_dir:this.jSort.dir});
      if (this.jf.board) p.set('board', this.jf.board);
      if (this.jf.seniority) p.set('seniority', this.jf.seniority);
      if (this.jf.search) p.set('search', this.jf.search);
      if (this.jf.url_search) p.set('url_search', this.jf.url_search);
      if (this.jf.run_id) p.set('run_id', this.jf.run_id);
      if (this.jf.date_from) p.set('date_from', this.jf.date_from);
      if (this.jf.date_to) p.set('date_to', this.jf.date_to);
      try {
        const r = await fetch('/api/jobs?' + p);
        this.jobs = await r.json();
      } catch(e) { console.error('jobs', e); }
      this.jobsLoading = false;
    },

    async fetchRunIds() {
      try {
        const r = await fetch('/api/runs?per_page=100');
        const data = await r.json();
        this.runIds = (data.runs || []).map(r => r.run_id);
      } catch(e) {}
    },

    get jobStatsBar() {
      if (!this.jobs.items.length) return '';
      const bs = new Set(this.jobs.items.map(j => j.board));
      const ss = new Set(this.jobs.items.map(j => j.seniority));
      return bs.size + ' boards, ' + ss.size + ' seniority levels in view';
    },

    async toggleJob(id) {
      if (this.expandedId === id) { this.expandedId = null; this.expandedDetail = null; return; }
      this.expandedId = id;
      this.expandedDetail = null;
      try {
        const r = await fetch('/api/jobs/' + id);
        this.expandedDetail = await r.json();
      } catch(e) { console.error('job detail', e); }
    },

    toggleSort(col) {
      if (this.jSort.by === col) this.jSort.dir = this.jSort.dir === 'asc' ? 'desc' : 'asc';
      else { this.jSort.by = col; this.jSort.dir = 'desc'; }
      this.jPage = 1; this.fetchJobs();
    },

    clearJobFilters() {
      this.jf = {board:'',seniority:'',search:'',url_search:'',run_id:'',date_from:'',date_to:''};
      this.jPage = 1; this.fetchJobs();
    },

    // ── Runs ────────────────────────────────────────────────
    async fetchRuns() {
      this.runsLoading = true;
      try {
        const r = await fetch('/api/runs?page=' + this.runPage + '&per_page=50');
        const data = await r.json();
        this.runs = data.runs || [];
        this.runStats = data.stats || null;
        this.runPages = data.pages || 1;
        this.$nextTick(() => this.renderRunTimeline());
      } catch(e) { console.error('runs', e); }
      this.runsLoading = false;
    },

    async toggleRunExpand(runId) {
      if (this.expandedRunId === runId) {
        this.expandedRunId = null;
        this.expandedRunJobs = null;
        return;
      }
      this.expandedRunId = runId;
      this.expandedRunJobs = null;
      try {
        const r = await fetch('/api/runs/' + encodeURIComponent(runId));
        const data = await r.json();
        this.expandedRunJobs = data.jobs || [];
      } catch(e) { console.error('run detail', e); this.expandedRunJobs = []; }
    },

    async fetchActiveRun() {
      try {
        const r = await fetch('/api/runs/active');
        const data = await r.json();
        this.isActive = data.active;
      } catch(e) { this.isActive = false; }
    },

    // ── Dedup & Growth ──────────────────────────────────────
    async fetchDedupStats() {
      try {
        const r = await fetch('/api/dedup/stats');
        this.dedupData = await r.json();
        this.dedupLoaded = true;
        this.$nextTick(() => {
          this.renderRepeatChart();
          this.renderUniquenessChart();
          this.renderDailyNewChart();
        });
      } catch(e) { console.error('dedup', e); }
    },

    async fetchFilterStats() {
      try {
        const r = await fetch('/api/filters/stats');
        const data = await r.json();
        this.filterStages = data.stages || [];
        if (this.runs.length === 0) await this.fetchRuns();
        let totalDedup = 0, totalPassed = 0;
        for (const run of this.runs) {
          if (run.dedup_count != null && run.filtered_count != null) {
            totalDedup += run.dedup_count;
            totalPassed += run.filtered_count;
          }
        }
        this.passRate = totalDedup > 0 ? Math.round(totalPassed / totalDedup * 100) + '%' : '—';
        this.$nextTick(() => this.renderFilterChart());
      } catch(e) { console.error('filters', e); }
    },

    // ── Rejected ─────────────────────────────────────────────
    async fetchRejectedStats() {
      try {
        const r = await fetch('/api/rejected/stats');
        this.rejectedStats = await r.json();
      } catch(e) { console.error('rejected stats', e); }
    },

    async fetchRejected() {
      this.rejectedLoading = true;
      const p = new URLSearchParams({page: this.rPage, per_page: this.rPerPage});
      if (this.rf.stage) p.set('stage', this.rf.stage);
      if (this.rf.run_id) p.set('run_id', this.rf.run_id);
      if (this.rf.search) p.set('search', this.rf.search);
      try {
        const r = await fetch('/api/rejected?' + p);
        const data = await r.json();
        this.rejected = data;
        this.rejectedStages = data.stages || [];
      } catch(e) { console.error('rejected', e); }
      this.rejectedLoading = false;
    },

    async toggleRejected(id) {
      if (this.expandedRejectedId === id) {
        this.expandedRejectedId = null; this.expandedRejectedDetail = null; return;
      }
      this.expandedRejectedId = id;
      this.expandedRejectedDetail = null;
      try {
        const r = await fetch('/api/rejected/' + id);
        this.expandedRejectedDetail = await r.json();
      } catch(e) { console.error('rejected detail', e); }
    },

    // ── LLM status ──────────────────────────────────────────
    async fetchLLMStatus() {
      try {
        const r = await fetch('/api/llm/status');
        this.llmStatus = await r.json();
      } catch(e) { this.llmStatus = {available: false, models: [], url: 'http://localhost:8800'}; }
    },

    // ── Schedules ────────────────────────────────────────────
    async fetchSchedules() {
      this.schedLoading = true;
      try {
        const r = await fetch('/api/schedules');
        const data = await r.json();
        this.schedJobs = data.jobs || [];
      } catch(e) { console.error('schedules', e); }
      this.schedLoading = false;
    },

    toggleSchedExpand(label) {
      this.schedExpandedId = this.schedExpandedId === label ? null : label;
    },

    async fetchSchedLog(label) {
      try {
        const r = await fetch('/api/schedules/' + encodeURIComponent(label) + '/log?lines=' + this.schedLogLines);
        const data = await r.json();
        this.schedLogData[label] = data;
        // Scroll to bottom after render
        this.$nextTick(() => {
          const viewer = this.$refs.logViewer;
          if (viewer) viewer.scrollTop = viewer.scrollHeight;
        });
      } catch(e) { console.error('sched log', e); }
    },

    // ── DB Explorer ─────────────────────────────────────────
    async fetchDBTables() {
      try {
        const r = await fetch('/api/db/tables');
        const data = await r.json();
        this.dbTables = data.tables || [];
        if (this.dbTables.length > 0 && !this.explorerTable) {
          this.explorerTable = this.dbTables[0].name;
          this.fetchExplorerData();
        }
      } catch(e) { console.error('db tables', e); }
    },

    async fetchExplorerData() {
      this.explorerLoading = true;
      this.explorerColFilters = {};
      const p = new URLSearchParams({page: this.explorerPage, per_page: this.explorerPerPage});
      if (this.explorerSort.by) {
        p.set('sort_by', this.explorerSort.by);
        p.set('sort_dir', this.explorerSort.dir);
      }
      try {
        const r = await fetch('/api/db/table/' + encodeURIComponent(this.explorerTable) + '?' + p);
        this.explorerData = await r.json();
        this.explorerFiltered = this.explorerData.items;
      } catch(e) { console.error('explorer', e); }
      this.explorerLoading = false;
    },

    toggleExplorerSort(col) {
      if (this.explorerSort.by === col) this.explorerSort.dir = this.explorerSort.dir === 'asc' ? 'desc' : 'asc';
      else { this.explorerSort.by = col; this.explorerSort.dir = 'asc'; }
      this.explorerPage = 1;
      this.fetchExplorerData();
    },

    filterExplorerLocal() {
      const filters = this.explorerColFilters;
      this.explorerFiltered = this.explorerData.items.filter(row => {
        for (const col in filters) {
          if (!filters[col]) continue;
          const val = String(row[col] ?? '').toLowerCase();
          if (!val.includes(filters[col].toLowerCase())) return false;
        }
        return true;
      });
    },

    openRowModal(row) {
      this.rowModalData = row;
    },

    copyExplorerJSON() {
      const text = JSON.stringify(this.explorerFiltered, null, 2);
      navigator.clipboard.writeText(text).catch(() => {});
    },

    // ── SQL Console ─────────────────────────────────────────
    async runSQL() {
      if (!this.sqlText.trim()) return;
      this.sqlRunning = true;
      this.sqlError = '';
      this.sqlResult = null;
      try {
        const r = await fetch('/api/db/query?sql=' + encodeURIComponent(this.sqlText.trim()));
        const data = await r.json();
        if (data.error) {
          this.sqlError = data.error;
        } else {
          this.sqlResult = data;
          // Save to history
          const q = this.sqlText.trim();
          this.sqlHistory = [q, ...this.sqlHistory.filter(h => h !== q)].slice(0, 10);
          localStorage.setItem('sqlHistory', JSON.stringify(this.sqlHistory));
        }
      } catch(e) { this.sqlError = 'Request failed: ' + e.message; }
      this.sqlRunning = false;
    },

    // ── Chart rendering ─────────────────────────────────────
    renderGrowthChart() {
      const el = document.getElementById('growthChart');
      if (!el || !this._growthData) return;
      if (this.growthChart) this.growthChart.destroy();
      const results = this._growthData.results || [];
      const seen = this._growthData.seen_urls || [];
      const datasets = [{
        label: 'Cumulative Results',
        data: results.map(d => ({x: d.date, y: d.cumulative})),
        borderColor: '#4361ee',
        backgroundColor: 'rgba(67,97,238,.1)',
        fill: true, tension: .3, pointRadius: 0,
      }];
      if (seen.length > 0) {
        datasets.push({
          label: 'Cumulative URLs Seen',
          data: seen.map(d => ({x: d.date, y: d.cumulative})),
          borderColor: '#7c3aed',
          backgroundColor: 'rgba(124,58,237,.05)',
          fill: true, tension: .3, pointRadius: 0,
          yAxisID: 'y1',
        });
      }
      const opts = {
        responsive: true, maintainAspectRatio: false,
        interaction: {mode: 'index', intersect: false},
        plugins: {legend: {position: 'top', labels: {boxWidth: 12}}},
        scales: {
          x: {type: 'category', grid: {display: false}},
          y: {beginAtZero: true, position: 'left', title: {display: true, text: 'Results'}},
        }
      };
      if (seen.length > 0) {
        opts.scales.y1 = {beginAtZero: true, position: 'right', title: {display: true, text: 'URLs Seen'}, grid: {drawOnChartArea: false}};
      }
      this.growthChart = new Chart(el, {type: 'line', data: {labels: results.map(d => d.date.slice(5)), datasets}, options: opts});
    },

    renderTrendChart() {
      const el = document.getElementById('trendChart');
      if (!el || !this.ov.trend) return;
      if (this.trendChart) this.trendChart.destroy();
      this.trendChart = new Chart(el, {
        type: 'bar',
        data: {
          labels: this.ov.trend.map(d => d.date.slice(5)),
          datasets: [{
            label: 'Jobs/Day',
            data: this.ov.trend.map(d => d.count),
            backgroundColor: 'rgba(67,97,238,.6)',
            borderRadius: 4,
          }]
        },
        options: {responsive:true,maintainAspectRatio:false,plugins:{legend:{display:false}},scales:{y:{beginAtZero:true,ticks:{stepSize:1}},x:{grid:{display:false}}}}
      });
    },

    renderBoardChart() {
      const el = document.getElementById('boardChart');
      if (!el || !this.ov.boards) return;
      if (this.boardChart) this.boardChart.destroy();
      const labels = Object.keys(this.ov.boards);
      const colors = ['#06d6a0','#ffd166','#4361ee','#ef476f','#7c3aed','#f97316','#14b8a6','#6b7280'];
      this.boardChart = new Chart(el, {
        type: 'doughnut',
        data: {labels, datasets: [{data: Object.values(this.ov.boards), backgroundColor: colors.slice(0,labels.length)}]},
        options: {responsive:true,maintainAspectRatio:false,plugins:{legend:{position:'right',labels:{boxWidth:12,padding:8,font:{size:12}}}}}
      });
    },

    renderSeniorityChart() {
      const el = document.getElementById('seniorityChart');
      if (!el || !this.ov.seniority) return;
      if (this.seniorityChart) this.seniorityChart.destroy();
      const labels = Object.keys(this.ov.seniority);
      const colors = ['#06d6a0','#4361ee','#ffd166','#ef476f','#7c3aed','#f97316','#14b8a6','#ec4899','#6b7280'];
      this.seniorityChart = new Chart(el, {
        type: 'doughnut',
        data: {labels, datasets: [{data: Object.values(this.ov.seniority), backgroundColor: colors.slice(0,labels.length)}]},
        options: {responsive:true,maintainAspectRatio:false,plugins:{legend:{position:'right',labels:{boxWidth:12,padding:8,font:{size:12}}}}}
      });
    },

    renderRunTimeline() {
      const el = document.getElementById('runTimelineChart');
      if (!el || !this.runs.length) return;
      if (this.runTimelineChart) this.runTimelineChart.destroy();
      const recent = this.runs.slice().reverse().slice(-30);
      const colors = recent.map(r => r.status === 'complete' ? '#06d6a0' : (r.status === 'running' ? '#4361ee' : '#ef476f'));
      this.runTimelineChart = new Chart(el, {
        type: 'bar',
        data: {
          labels: recent.map(r => r.started_at ? new Date(r.started_at).toLocaleDateString('en-US', {month:'short',day:'numeric'}) : ''),
          datasets: [{
            label: 'Duration (s)',
            data: recent.map(r => r.elapsed ?? 0),
            backgroundColor: colors,
            borderRadius: 4,
          }]
        },
        options: {responsive:true,maintainAspectRatio:false,plugins:{legend:{display:false}},scales:{y:{beginAtZero:true,title:{display:true,text:'seconds'}},x:{grid:{display:false}}}}
      });
    },

    renderRepeatChart() {
      const el = document.getElementById('repeatChart');
      if (!el || !this.dedupData?.repeat_freq) return;
      if (this.repeatChart) this.repeatChart.destroy();
      const freq = this.dedupData.repeat_freq;
      this.repeatChart = new Chart(el, {
        type: 'doughnut',
        data: {
          labels: Object.keys(freq),
          datasets: [{data: Object.values(freq), backgroundColor: ['#06d6a0','#4361ee','#ffd166','#ef476f']}]
        },
        options: {responsive:true,maintainAspectRatio:false,plugins:{legend:{position:'right',labels:{boxWidth:12,padding:8,font:{size:12}}}}}
      });
    },

    renderUniquenessChart() {
      const el = document.getElementById('uniquenessChart');
      if (!el || !this.dedupData?.run_uniqueness?.length) return;
      if (this.uniquenessChart) this.uniquenessChart.destroy();
      const data = this.dedupData.run_uniqueness.slice().reverse().slice(-30);
      const pcts = data.map(r => r.dedup > 0 ? Math.round(r.stored / r.dedup * 100) : 0);
      this.uniquenessChart = new Chart(el, {
        type: 'line',
        data: {
          labels: data.map(r => r.date ? new Date(r.date).toLocaleDateString('en-US', {month:'short',day:'numeric'}) : ''),
          datasets: [{
            label: '% Unique',
            data: pcts,
            borderColor: '#7c3aed',
            backgroundColor: 'rgba(124,58,237,.1)',
            fill: true, tension: .3, pointRadius: 2,
          }]
        },
        options: {responsive:true,maintainAspectRatio:false,plugins:{legend:{display:false}},scales:{y:{beginAtZero:true,max:100,ticks:{callback:v=>v+'%'}},x:{grid:{display:false}}}}
      });
    },

    renderDailyNewChart() {
      const el = document.getElementById('dailyNewChart');
      if (!el || !this.dedupData?.daily_new?.length) return;
      if (this.dailyNewChart) this.dailyNewChart.destroy();
      const data = this.dedupData.daily_new;
      this.dailyNewChart = new Chart(el, {
        type: 'bar',
        data: {
          labels: data.map(d => d.date.slice(5)),
          datasets: [{
            label: 'New Jobs',
            data: data.map(d => d.count),
            backgroundColor: 'rgba(6,214,160,.6)',
            borderRadius: 4,
          }]
        },
        options: {responsive:true,maintainAspectRatio:false,plugins:{legend:{display:false}},scales:{y:{beginAtZero:true,ticks:{stepSize:1}},x:{grid:{display:false}}}}
      });
    },

    renderFilterChart() {
      const el = document.getElementById('filterChart');
      if (!el || !this.filterStages.length) return;
      if (this.filterChart) this.filterChart.destroy();
      const items = [];
      for (const s of this.filterStages) {
        for (const r of s.reasons.slice(0, 3)) {
          items.push({label: s.stage + ': ' + r.reason, count: r.count});
        }
      }
      items.sort((a,b) => b.count - a.count);
      const top = items.slice(0, 12);
      this.filterChart = new Chart(el, {
        type: 'bar',
        data: {
          labels: top.map(i => i.label.length > 40 ? i.label.slice(0,37)+'...' : i.label),
          datasets: [{data: top.map(i => i.count), backgroundColor: '#4361ee', borderRadius: 4}]
        },
        options: {indexAxis:'y',responsive:true,maintainAspectRatio:false,plugins:{legend:{display:false}},scales:{x:{beginAtZero:true,ticks:{stepSize:1}},y:{ticks:{font:{size:11}}}}}
      });
    },

    // ── Formatters ──────────────────────────────────────────
    fmt(n) { return n != null ? n.toLocaleString() : '—'; },

    fmtBytes(bytes) {
      if (bytes == null || bytes === 0) return '—';
      const units = ['B','KB','MB','GB'];
      let i = 0;
      let val = bytes;
      while (val >= 1024 && i < units.length - 1) { val /= 1024; i++; }
      return val.toFixed(i > 0 ? 1 : 0) + ' ' + units[i];
    },

    timeAgo(ts) {
      if (!ts) return '—';
      const d = new Date(ts);
      const diff = (Date.now() - d.getTime()) / 1000;
      if (diff < 60) return Math.round(diff) + 's ago';
      if (diff < 3600) return Math.round(diff/60) + 'm ago';
      if (diff < 86400) return Math.round(diff/3600) + 'h ago';
      return Math.round(diff/86400) + 'd ago';
    },

    fmtDate(ts) {
      if (!ts) return '—';
      return new Date(ts).toLocaleDateString('en-US', {month:'short',day:'numeric',year:'numeric'});
    },

    fmtDuration(sec) {
      if (sec == null) return '—';
      if (sec < 60) return Math.round(sec) + 's';
      return Math.floor(sec/60) + 'm ' + Math.round(sec%60) + 's';
    },

    formatCell(val) {
      if (val === null || val === undefined) return 'NULL';
      if (typeof val === 'string' && val.length > 100) return val.slice(0, 100) + '...';
      return String(val);
    },

    formatCellFull(val) {
      if (val === null || val === undefined) return 'NULL';
      if (typeof val === 'string') {
        try { return JSON.stringify(JSON.parse(val), null, 2); } catch(e) {}
      }
      return String(val);
    },
  };
}
</script>
</body>
</html>
