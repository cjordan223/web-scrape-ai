FILTER TUNING NOTES
===================
Written: 2026-02-22
Purpose: Review rejected jobs after overnight run and tune filters accordingly.

HOW TO REVIEW
-------------
1. Start dashboard: python dashboard/server.py
2. Go to http://localhost:8899 → "Rejected" view
3. Click each stage chip to filter by rejection reason
4. SQL Console shortcut:
     SELECT rejection_stage, rejection_reason, title, url FROM rejected ORDER BY rejection_stage, rejection_reason LIMIT 200;
   Or by stage:
     SELECT title, url, snippet, rejection_reason FROM rejected WHERE rejection_stage = 'salary' ORDER BY created_at DESC;

CURRENT FILTER STAGES (in order, config in job_scraper/config.default.yaml)
-----------------------------------------------------------------------------
1. url_domain        - blocks dictionary.com, reddit, wikipedia etc.
2. title_relevance   - title must contain a security keyword (security, cyber, appsec, etc.)
3. title_role        - title must contain a role word (engineer, analyst, etc.)
4. seniority         - rejects: senior, staff, principal, lead, manager, director
5. experience        - rejects if JD states > 4 years required
6. content_blocklist - rejects if title/snippet/JD contains clearance keywords
7. remote            - requires remote keyword in title/snippet/JD
8. salary            - rejects if salary < $120K OR no salary found in JD
9. llm_review        - LLM common-sense check (Qwen3-Coder-Next-4bit on :8800)

WHAT TO LOOK FOR
----------------
title_relevance rejections:
  - Legitimate security jobs with unusual keyword patterns? → add to title_keywords in config.yaml
  - Pure noise (dictionaries, articles, non-job pages)? → possibly add to url_domain_blocklist

title_role rejections:
  - Real security roles with an unusual role word? → add to title_role_words
  - e.g. "Security Consultant" not matching? → "consultant" is already there, check spelling

seniority rejections:
  - Is "lead" or "senior" being over-applied? title detection uses regex \b word boundaries
  - Consider loosening: remove "lead" from seniority_exclude if too aggressive

remote rejections:
  - Lots of real remote jobs getting caught? The remote check looks at title+snippet+JD
  - If JD fetch fails (403/404), no JD text = remote check fails on snippet alone
  - Consider: require_remote: false if too many false negatives here

salary rejections:
  - "no JD text to parse salary from" = fetch failed (403 from Indeed/ZipRecruiter/Glassdoor)
    These are likely real jobs we can't scrape. Consider blocking those domains upstream
    OR changing: min_salary_k: 0 to disable salary filter entirely if too noisy
  - "no salary found in JD" = JD fetched but no salary listed. Tune min_salary_k or
    add a config option like require_salary: false
  - Actual low salary ($<120K) = working correctly, keep

llm_review rejections:
  - Review the reasons carefully. LLM should only reject:
    a) physical security roles
    b) job aggregator pages (not actual postings)
    c) clearly senior-only despite passing seniority filter
  - If LLM is being too aggressive on salary/seniority already caught by rules,
    tighten the system prompt in job_scraper/llm_reviewer.py

TUNING LEVERS (config.default.yaml)
-------------------------------------
filter:
  min_salary_k: 120       # lower to 100, or set to 0 to disable
  require_remote: true    # set false if too many legit jobs cut
  max_experience_years: 4 # raise to 5-6 if too aggressive
  seniority_exclude:      # remove "lead" if cutting too many tech leads
    - senior
    - staff
    - principal
    - lead              # <-- consider removing
    - manager
    - director
  title_keywords:         # add new keywords if missing real jobs
    - ...
  title_role_words:       # add new role words if missing real jobs
    - ...

LLM config in config.default.yaml:
  llm_review:
    enabled: true         # set false to disable
    fail_open: true       # if server down, job passes
    jd_max_chars: 2000    # increase if LLM needs more context

NOTES FROM FIRST RUN (2026-02-22)
-----------------------------------
- 151 raw → 8 rejections captured in first partial run (DB was fresh)
- Rejection breakdown: title_relevance x5, remote x1, salary x1, seniority x1
- "Java Security Engineer Trainee" → salary rejected (no JD = ZipRecruiter/Indeed blocked)
- "Staff Cyber Security Engineer @ Kong" → correct seniority reject
- "Corporate Security Engineer @ Harvey" → remote rejected (check if actually remote)
- LLM running cleanly, good pass/fail decisions observed
- Main concern: salary filter may be cutting real jobs where JD is unfetchable
  Suggest: after overnight run, look at how many salary rejections are "no JD text"
  vs actual low salary. May want to only reject on confirmed low salary, not missing.
